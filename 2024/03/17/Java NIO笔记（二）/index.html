<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Haoçš„ç©ºé—´ğŸ¥ | Haoçš„ç©ºé—´ğŸ¥</title><meta name="author" content="è€¶æ ¼å°”"><meta name="copyright" content="è€¶æ ¼å°”"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Nettyæ¡†æ¶å‰é¢æˆ‘ä»¬å­¦ä¹ äº†Javaä¸ºæˆ‘ä»¬æä¾›çš„NIOæ¡†æ¶ï¼Œæä¾›ä½¿ç”¨NIOæä¾›çš„ä¸‰å¤§ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æ›´åŠ é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯ç½‘ç»œç¨‹åºäº†ï¼Œç”šè‡³è¿˜å¯ä»¥è‡ªè¡Œè§„å®šä¸€ç§é€šä¿¡åè®®è¿›è¡Œé€šä¿¡ã€‚ NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜ä½†æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ä½¿ç”¨NIOæ¡†æ¶çš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç›˜ç‚¹ä¸€ä¸‹ã€‚ å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢å¯èƒ½åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œä½ å‘ç°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š  å½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸»åŠ¨ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œ">
<meta property="og:type" content="article">
<meta property="og:title" content="Haoçš„ç©ºé—´ğŸ¥">
<meta property="og:url" content="http://alanyaeer.fun/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/index.html">
<meta property="og:site_name" content="Haoçš„ç©ºé—´ğŸ¥">
<meta property="og:description" content="Nettyæ¡†æ¶å‰é¢æˆ‘ä»¬å­¦ä¹ äº†Javaä¸ºæˆ‘ä»¬æä¾›çš„NIOæ¡†æ¶ï¼Œæä¾›ä½¿ç”¨NIOæä¾›çš„ä¸‰å¤§ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æ›´åŠ é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯ç½‘ç»œç¨‹åºäº†ï¼Œç”šè‡³è¿˜å¯ä»¥è‡ªè¡Œè§„å®šä¸€ç§é€šä¿¡åè®®è¿›è¡Œé€šä¿¡ã€‚ NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜ä½†æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ä½¿ç”¨NIOæ¡†æ¶çš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç›˜ç‚¹ä¸€ä¸‹ã€‚ å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢å¯èƒ½åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œä½ å‘ç°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š  å½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸»åŠ¨ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://alanyaeer.fun/img/avatar.jpg">
<meta property="article:published_time" content="2024-03-17T13:05:20.700Z">
<meta property="article:modified_time" content="2024-04-19T11:22:31.055Z">
<meta property="article:author" content="è€¶æ ¼å°”">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://alanyaeer.fun/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://alanyaeer.fun/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Haoçš„ç©ºé—´ğŸ¥',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-19 19:22:31'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4310562_upfi60u88s.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/progress_bar.css" media="defer" onload="this.media='all'"></head><body><span id="fps"></span><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/progress_bar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">7</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon fas fa-home" aria-hidden="true"><use xlink:href="#icon-home"></use></svg><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon fas fa-archive" aria-hidden="true"><use xlink:href="#icon-guidang"></use></svg><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-sekuaibiaoqian"></i><svg class="icon fas fa-tags" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon fas fa-folder-open" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon hide" aria-hidden="true"><use xlink:href="#icon-liebiao1"></use></svg><span> åˆ—è¡¨</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon fas fa-music" aria-hidden="true"><use xlink:href="#icon-yinle">                   </use></svg><span> éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon fas fa-video" aria-hidden="true"><use xlink:href="#icon-dianying">                   </use></svg><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-a-027_kecheng"></i><svg class="icon fas fa-envelope-open" aria-hidden="true"><use xlink:href="#icon-a-027_kecheng"></use></svg><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon fas fa-link" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-a-027_huodong"></i><svg class="icon fas fa-heart" aria-hidden="true"><use xlink:href="#icon-a-027_huodong"></use></svg><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Haoçš„ç©ºé—´ğŸ¥"><span class="site-name">Haoçš„ç©ºé—´ğŸ¥</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon fas fa-home" aria-hidden="true"><use xlink:href="#icon-home"></use></svg><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon fas fa-archive" aria-hidden="true"><use xlink:href="#icon-guidang"></use></svg><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-sekuaibiaoqian"></i><svg class="icon fas fa-tags" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon fas fa-folder-open" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon hide" aria-hidden="true"><use xlink:href="#icon-liebiao1"></use></svg><span> åˆ—è¡¨</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon fas fa-music" aria-hidden="true"><use xlink:href="#icon-yinle">                   </use></svg><span> éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon fas fa-video" aria-hidden="true"><use xlink:href="#icon-dianying">                   </use></svg><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-a-027_kecheng"></i><svg class="icon fas fa-envelope-open" aria-hidden="true"><use xlink:href="#icon-a-027_kecheng"></use></svg><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon fas fa-link" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-a-027_huodong"></i><svg class="icon fas fa-heart" aria-hidden="true"><use xlink:href="#icon-a-027_huodong"></use></svg><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">æ— é¢˜</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2024-03-17T13:05:20.700Z" title="å‘è¡¨äº 2024-03-17 21:05:20">2024-03-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-04-19T11:22:31.055Z" title="æ›´æ–°äº 2024-04-19 19:22:31">2024-04-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">17.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>66åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Nettyæ¡†æ¶"><a href="#Nettyæ¡†æ¶" class="headerlink" title="Nettyæ¡†æ¶"></a>Nettyæ¡†æ¶</h1><p>å‰é¢æˆ‘ä»¬å­¦ä¹ äº†Javaä¸ºæˆ‘ä»¬æä¾›çš„NIOæ¡†æ¶ï¼Œæä¾›ä½¿ç”¨NIOæä¾›çš„ä¸‰å¤§ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™æ›´åŠ é«˜æ€§èƒ½çš„å®¢æˆ·ç«¯/æœåŠ¡ç«¯ç½‘ç»œç¨‹åºäº†ï¼Œç”šè‡³è¿˜å¯ä»¥è‡ªè¡Œè§„å®šä¸€ç§é€šä¿¡åè®®è¿›è¡Œé€šä¿¡ã€‚</p>
<h2 id="NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜"><a href="#NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜"></a>NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜</h2><p>ä½†æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ä½¿ç”¨NIOæ¡†æ¶çš„æ—¶å€™ï¼Œè¿˜æ˜¯å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥ç›˜ç‚¹ä¸€ä¸‹ã€‚</p>
<h3 id="å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢"><a href="#å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢" class="headerlink" title="å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢"></a>å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢</h3><p>å¯èƒ½åœ¨ä¹‹å‰çš„å®éªŒä¸­ï¼Œä½ å‘ç°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1z0omdbn1j21q60isq70.jpg" alt="image-20220506214320210"></p>
<p>å½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯ä¸»åŠ¨ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šå¯¼è‡´READäº‹ä»¶ä¸€ç›´è¢«è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´<code>selector.select()</code>ä¼šç›´æ¥é€šè¿‡ï¼Œå¹¶ä¸”æ˜¯å¯è¯»çš„çŠ¶æ€ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å®é™…ä¸Šè¯»åˆ°æ˜¯æ•°æ®æ˜¯ä¸€ä¸ªç©ºçš„ï¼ˆä¸Šé¢çš„å›¾ä¸­åœ¨ç©ºè½®è¯¢ä¸¤æ¬¡åæŠ›å‡ºå¼‚å¸¸äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ— é™çš„å¾ªç¯ä¸‹å»ï¼‰æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¾—ç¨å¾®å¤„ç†ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span>(key.isReadable()) {</span><br><span class="line">    <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">    <span class="comment">//è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœreadæ“ä½œå¾—åˆ°çš„ç»“æœæ˜¯-1ï¼Œé‚£ä¹ˆè¯´æ˜æœåŠ¡ç«¯å·²ç»æ–­å¼€è¿æ¥äº†</span></span><br><span class="line">    <span class="keyword">if</span>(channel.read(buffer) &lt; <span class="number">0</span>) {</span><br><span class="line">        System.out.println(<span class="string">"å®¢æˆ·ç«¯å·²ç»æ–­å¼€è¿æ¥äº†ï¼š"</span>+channel.getRemoteAddress());</span><br><span class="line">        channel.close();   <span class="comment">//ç›´æ¥å…³é—­æ­¤é€šé“</span></span><br><span class="line">        <span class="keyword">continue</span>;   <span class="comment">//ç»§ç»­è¿›è¡Œé€‰æ‹©</span></span><br><span class="line">    }</span><br><span class="line">    buffer.flip();</span><br><span class="line">    System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">    channel.write(ByteBuffer.wrap(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€æ—¶å…³é—­è¿æ¥äº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1z1qtxd9nj21cy078jrw.jpg" alt="image-20220506222006550"></p>
<p>å½“ç„¶ï¼Œé™¤äº†è¿™ç§æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´ç©ºè½®è¯¢ä¹‹å¤–ï¼Œå®é™…ä¸Šè¿˜æœ‰ä¸€ç§å¯èƒ½ï¼Œè¿™ç§æƒ…å†µæ˜¯NIOæ¡†æ¶æœ¬èº«çš„BUGï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();  <span class="comment">//ç”±äºåº•å±‚epollæœºåˆ¶çš„é—®é¢˜ï¼Œå¯¼è‡´selectæ–¹æ³•å¯èƒ½ä¼šä¸€ç›´è¿”å›0ï¼Œé€ æˆæ— é™å¾ªç¯çš„æƒ…å†µã€‚</span></span><br><span class="line">    System.out.println(<span class="string">"ç›‘å¬åˆ° "</span>+count+<span class="string">" ä¸ªäº‹ä»¶"</span>);</span><br><span class="line">    Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">    Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br></pre></td></tr></tbody></table></figure>

<p>è¯¦ç»†è¯·çœ‹JDKå®˜æ–¹BUGåé¦ˆï¼š</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6670302">JDK-6670302 : (se) NIO selector wakes up with 0 selected keys infinitely</a></li>
<li><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6403933">JDK-6403933 : (se) Selector doesnâ€™t block on Selector.select(timeout) (lnx)</a></li>
</ol>
<p>æœ¬è´¨åŸå› ä¹Ÿæ˜¯å› ä¸ºå®¢æˆ·ç«¯çš„ä¸»åŠ¨æ–­å¼€å¯¼è‡´ï¼š</p>
<blockquote>
<p>This is an issue with poll (and epoll) on Linux. If a file descriptor for a connected socket is polled with a request event mask of 0, and if the connection is abruptly terminated (RST) then the poll wakes up with the POLLHUP (and maybe POLLERR) bit set in the returned event set. The implication of this behaviour is that Selector will wakeup and as the interest set for the SocketChannel is 0 it means there arenâ€™t any selected events and the select method returns 0.</p>
</blockquote>
<p>è¿™ä¸ªé—®é¢˜æœ¬è´¨æ˜¯ä¸æ“ä½œç³»ç»Ÿæœ‰å…³çš„ï¼Œæ‰€ä»¥JDKä¸€ç›´éƒ½è®¤ä¸ºæ˜¯æ“ä½œç³»ç»Ÿçš„é—®é¢˜ï¼Œä¸åº”è¯¥ç”±è‡ªå·±æ¥å¤„ç†ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜åœ¨å½“æ—¶çš„å¥½å‡ ä¸ªJDKç‰ˆæœ¬éƒ½æ˜¯å­˜åœ¨çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆä¸¥é‡çš„ç©ºè½¬é—®é¢˜ï¼Œæ— é™åˆ¶åœ°è¿›è¡Œç©ºè½¬æ“ä½œä¼šå¯¼è‡´CPUèµ„æºè¢«ç–¯ç‹‚æ¶ˆè€—ã€‚</p>
<p>ä¸è¿‡ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œå´è¢«Nettyæ¡†æ¶å·§å¦™è§£å†³äº†ï¼Œæˆ‘ä»¬åé¢å†è¯´ã€‚</p>
<h3 id="ç²˜åŒ…-æ‹†åŒ…é—®é¢˜"><a href="#ç²˜åŒ…-æ‹†åŒ…é—®é¢˜" class="headerlink" title="ç²˜åŒ…/æ‹†åŒ…é—®é¢˜"></a>ç²˜åŒ…/æ‹†åŒ…é—®é¢˜</h3><p>é™¤äº†ä¸Šé¢çš„é—®é¢˜ä¹‹å¤–ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬åœ¨<code>è®¡ç®—æœºç½‘ç»œ</code>è¿™é—¨è¯¾ç¨‹ä¸­å­¦ä¹ è¿‡ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡TCPåè®®å‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¼šå…ˆå°†æ•°æ®å­˜æ”¾åœ¨ç¼“å†²åŒºä¸­ï¼Œè€Œè‡³äºä»€ä¹ˆæ—¶å€™çœŸæ­£åœ°å‘å‡ºè¿™äº›æ•°æ®ï¼Œæ˜¯ç”±TCPåè®®æ¥å†³å®šçš„ï¼Œè¿™æ˜¯æˆ‘ä»¬æ— æ³•æ§åˆ¶çš„äº‹æƒ…ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1z2lccfu5j21ii0c60tu.jpg" alt="image-20220506224926169"></p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯”å¦‚ç°åœ¨æˆ‘ä»¬è¦å‘é€ä¸¤ä¸ªæ•°æ®åŒ…ï¼ˆP1/P2ï¼‰ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªåŒ…åº”è¯¥æ˜¯ä¾æ¬¡åˆ°è¾¾æœåŠ¡ç«¯ï¼Œå¹¶ç”±æœåŠ¡ç«¯æ­£ç¡®è¯»å–ä¸¤æ¬¡æ•°æ®å‡ºæ¥ï¼Œä½†æ˜¯ç”±äºä¸Šé¢çš„æœºåˆ¶ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š</p>
<ol>
<li>å¯èƒ½P1å’ŒP2è¢«åˆåœ¨ä¸€èµ·å‘é€ç»™äº†æœåŠ¡ç«¯ï¼ˆç²˜åŒ…ç°è±¡ï¼‰</li>
<li>å¯èƒ½P1å’ŒP2çš„å‰åŠéƒ¨åˆ†åˆåœ¨ä¸€èµ·å‘é€ç»™äº†æœåŠ¡ç«¯ï¼ˆæ‹†åŒ…ç°è±¡ï¼‰</li>
<li>å¯èƒ½P1çš„å‰åŠéƒ¨åˆ†å°±è¢«å•ç‹¬ä½œä¸ºä¸€ä¸ªéƒ¨åˆ†å‘ç»™äº†æœåŠ¡ç«¯ï¼Œåé¢çš„å’ŒP2ä¸€èµ·å‘ç»™æœåŠ¡ç«¯ï¼ˆä¹Ÿæ˜¯æ‹†åŒ…ç°è±¡ï¼‰</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1z2em84c6j21cm0da3z4.jpg" alt="image-20220506224258538"></p>
<p>å½“ç„¶ï¼Œå¯¹äºè¿™ç§é—®é¢˜ï¼Œä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒå¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>æ¶ˆæ¯å®šé•¿ï¼Œå‘é€æ–¹å’Œæ¥æ”¶æ–¹è§„å®šå›ºå®šå¤§å°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä¾‹å¦‚æ¯ä¸ªæ•°æ®åŒ…å¤§å°å›ºå®šä¸º200å­—èŠ‚ï¼Œå¦‚æœä¸å¤Ÿï¼Œç©ºä½è¡¥ç©ºæ ¼ï¼Œåªæœ‰æ¥æ”¶äº†200ä¸ªå­—èŠ‚ä¹‹åï¼Œä½œä¸ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…è¿›è¡Œå¤„ç†ã€‚</li>
<li>åœ¨æ¯ä¸ªåŒ…çš„æœ«å°¾ä½¿ç”¨å›ºå®šçš„åˆ†éš”ç¬¦ï¼Œæ¯”å¦‚æ¯ä¸ªæ•°æ®åŒ…æœ«å°¾éƒ½æ˜¯<code>\r\n</code>ï¼Œè¿™æ ·å°±ä¸€å®šéœ€è¦è¯»å–åˆ°è¿™æ ·çš„åˆ†éš”ç¬¦æ‰èƒ½å°†å‰é¢æ‰€æœ‰çš„æ•°æ®ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…è¿›è¡Œå¤„ç†ã€‚</li>
<li>å°†æ¶ˆæ¯åˆ†ä¸ºå¤´éƒ¨å’Œæœ¬ä½“ï¼Œåœ¨å¤´éƒ¨ä¸­ä¿å­˜æœ‰å½“å‰æ•´ä¸ªæ•°æ®åŒ…çš„é•¿åº¦ï¼Œåªæœ‰åœ¨è¯»åˆ°è¶³å¤Ÿé•¿åº¦ä¹‹åæ‰ç®—æ˜¯è¯»åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ã€‚</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬å°±æ¥æ¼”ç¤ºä¸€ä¸‹ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">         <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open()){</span><br><span class="line">        serverChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">        serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¸€ä¸ªæ•°æ®åŒ…è¦æ±‚å¿…é¡»å¡æ»¡30ä¸ªå­—èŠ‚</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br><span class="line">            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">                ...</span><br><span class="line">                    <span class="keyword">if</span>(buffer.remaining() == <span class="number">0</span>) {</span><br><span class="line">                        buffer.flip();</span><br><span class="line">                        System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">                        buffer.clear();</span><br><span class="line">                    }</span><br><span class="line">                    channel.write(ByteBuffer.wrap((<span class="string">"å·²æ”¶åˆ° "</span>+size+<span class="string">" å­—èŠ‚çš„æ•°æ®ï¼"</span>).getBytes()));</span><br><span class="line">                }</span><br><span class="line">               	...</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå¦‚æœæ²¡æœ‰è¾¾åˆ°30ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆä¼šæš‚æ—¶å­˜å‚¨èµ·æ¥ï¼Œç­‰æœ‰30ä¸ªä¹‹åå†ä¸€æ¬¡æ€§å¾—åˆ°ï¼Œå½“ç„¶å¦‚æœæ•°æ®é‡è¶…è¿‡äº†30ï¼Œé‚£ä¹ˆæœ€å¤šä¹Ÿåªä¼šè¯»å–30ä¸ªå­—èŠ‚ï¼Œå…¶ä»–çš„æ”¾åœ¨ä¸‹ä¸€æ‰¹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1zmuamek3j21ou0hmdiq.jpg" alt="image-20220507102955570"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1zmugj9ztj21l005qt9d.jpg" alt="image-20220507103009255"></p>
<p>è¿™æ ·å°±å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³ç²˜åŒ…/æ‹†åŒ…é—®é¢˜äº†ã€‚</p>
<hr>
<h2 id="èµ°è¿›Nettyæ¡†æ¶"><a href="#èµ°è¿›Nettyæ¡†æ¶" class="headerlink" title="èµ°è¿›Nettyæ¡†æ¶"></a>èµ°è¿›Nettyæ¡†æ¶</h2><p>å‰é¢æˆ‘ä»¬ç›˜ç‚¹äº†ä¸€ä¸‹NIOå­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œè€Œåœ¨Nettyæ¡†æ¶ä¸­ï¼Œè¿™äº›é—®é¢˜éƒ½è¢«å·§å¦™çš„è§£å†³äº†ã€‚</p>
<p>Nettyæ˜¯ç”±JBOSSæä¾›çš„ä¸€ä¸ªå¼€æºçš„javaç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œä¸»è¦æ˜¯å¯¹javaçš„nioåŒ…è¿›è¡Œäº†å†æ¬¡å°è£…ã€‚Nettyæ¯”javaåŸç”Ÿçš„nioåŒ…æä¾›äº†æ›´åŠ å¼ºå¤§ã€ç¨³å®šçš„åŠŸèƒ½å’Œæ˜“äºä½¿ç”¨çš„apiã€‚ nettyçš„ä½œè€…æ˜¯Trustin Leeï¼Œè¿™æ˜¯ä¸€ä¸ªéŸ©å›½äººï¼Œä»–è¿˜å¼€å‘äº†å¦å¤–ä¸€ä¸ªè‘—åçš„ç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œminaã€‚äºŒè€…åœ¨å¾ˆå¤šæ–¹é¢éƒ½ååˆ†ç›¸ä¼¼ï¼Œå®ƒä»¬çš„çº¿ç¨‹æ¨¡å‹ä¹Ÿæ˜¯åŸºæœ¬ä¸€è‡´ ã€‚ä¸è¿‡nettyç¤¾åŒºçš„æ´»è·ƒç¨‹åº¦è¦minaé«˜å¾—å¤šã€‚</p>
<p>Nettyå®é™…ä¸Šåº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œæ¯”å¦‚æˆ‘ä»¬çš„Minecraftæ¸¸æˆæœåŠ¡å™¨ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1znqwr5lqj21wa0pak1k.jpg" alt="image-20220507110120090"></p>
<p>Javaç‰ˆæœ¬çš„MinecraftæœåŠ¡å™¨å°±æ˜¯ä½¿ç”¨Nettyæ¡†æ¶ä½œä¸ºç½‘ç»œé€šä¿¡çš„åŸºç¡€ï¼Œæ­£æ˜¯å¾—ç›ŠäºNettyæ¡†æ¶çš„é«˜æ€§èƒ½ï¼Œæˆ‘ä»¬æ‰èƒ½æ„‰å¿«åœ°å’Œå…¶ä»–çš„å°ä¼™ä¼´ä¸€èµ·åœ¨æœåŠ¡å™¨é‡Œé¢ç‚¸æœã€‚</p>
<p>å­¦ä¹ äº†Nettyæ¡†æ¶åï¼Œè¯´ä¸å®šä½ ä¹Ÿå¯ä»¥æ‘¸ç´¢åˆ°éƒ¨åˆ†Minecraftæ’ä»¶/æ¨¡ç»„å¼€å‘çš„åº•å±‚ç»†èŠ‚ï¼ˆå¤ªæŠ˜ç£¨äº†ï¼ŒUPä¸»é«˜ä¸­æäº†å¤§åŠå¹´è¿™ç©æ„ï¼‰</p>
<p>å½“ç„¶é™¤äº†æ¸¸æˆæœåŠ¡å™¨ä¹‹å¤–ï¼Œæˆ‘ä»¬å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨ä¹Ÿå¯ä»¥ä½¿ç”¨Nettyæ¥å®Œæˆï¼Œæ¯”å¦‚Dubboçš„RPCæ¡†æ¶ï¼ŒåŒ…æ‹¬æœ€æ–°çš„SpringWebFluxæ¡†æ¶ï¼Œä¹ŸæŠ›å¼ƒäº†å†…åµŒTomcatè€Œä½¿ç”¨Nettyä½œä¸ºé€šä¿¡æ¡†æ¶ã€‚æ—¢ç„¶Nettyè¿™ä¹ˆå¼ºå¤§ï¼Œé‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±å¼€å§‹Nettyçš„å­¦ä¹ å§ï¼</p>
<p>å¯¼åŒ…å…ˆï¼š</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.76.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="ByteBufä»‹ç»"><a href="#ByteBufä»‹ç»" class="headerlink" title="ByteBufä»‹ç»"></a>ByteBufä»‹ç»</h3><p>Nettyå¹¶æ²¡æœ‰ä½¿ç”¨NIOä¸­æä¾›çš„ByteBufferæ¥è¿›è¡Œæ•°æ®è£…è½½ï¼Œè€Œæ˜¯è‡ªè¡Œå®šä¹‰äº†ä¸€ä¸ªByteBufç±»ã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªç±»ç›¸æ¯”NIOä¸­çš„ByteBufferæœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„å‘¢ï¼Ÿ</p>
<ul>
<li>å†™æ“ä½œå®Œæˆåæ— éœ€è¿›è¡Œ<code>flip()</code>ç¿»è½¬ã€‚</li>
<li>å…·æœ‰æ¯”ByteBufferæ›´å¿«çš„å“åº”é€Ÿåº¦ã€‚</li>
<li>åŠ¨æ€æ‰©å®¹ã€‚</li>
</ul>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å†…éƒ¨ç»“æ„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractByteBuf</span> <span class="keyword">extends</span> <span class="title class_">ByteBuf</span> {</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">int</span> readerIndex;   <span class="comment">//indexè¢«åˆ†ä¸ºäº†è¯»å’Œå†™ï¼Œæ˜¯ä¸¤ä¸ªæŒ‡é’ˆåœ¨åŒæ—¶å·¥ä½œ</span></span><br><span class="line">    <span class="type">int</span> writerIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> markedReaderIndex;    <span class="comment">//markæ“ä½œä¹Ÿåˆ†ä¸¤ç§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> markedWriterIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxCapacity;    <span class="comment">//æœ€å¤§å®¹é‡ï¼Œæ²¡é”™ï¼Œè¿™ç©æ„èƒ½åŠ¨æ€æ‰©å®¹</span></span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«ç”±ä¸¤ä¸ªæŒ‡é’ˆåœ¨è¿›è¡Œç»´æŠ¤ï¼Œæ¯å†™å…¥ä¸€æ¬¡ï¼Œ<code>writerIndex</code>å‘åç§»åŠ¨ä¸€ä½ï¼Œæ¯è¯»å–ä¸€æ¬¡ï¼Œä¹Ÿæ˜¯<code>readerIndex</code>å‘åç§»åŠ¨ä¸€ä½ï¼Œå½“ç„¶<code>readerIndex</code>ä¸èƒ½å¤§äº<code>writerIndex</code>ï¼Œè¿™æ ·å°±ä¸ä¼šåƒNIOä¸­çš„ByteBufferé‚£æ ·è¿˜éœ€è¦è¿›è¡Œç¿»è½¬äº†ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1zwgc0v5ej21fe08m3z1.jpg" alt="image-20220507160235552"></p>
<p>å…¶ä¸­<code>readerIndex</code>å’Œ<code>writerIndex</code>ä¹‹é—´çš„éƒ¨åˆ†å°±æ˜¯æ˜¯å¯è¯»çš„å†…å®¹ï¼Œè€Œ<code>writerIndex</code>ä¹‹ååˆ°<code>capacity</code>éƒ½æ˜¯å¯å†™çš„éƒ¨åˆ†ã€‚</p>
<p>æˆ‘ä»¬æ¥å®é™…ä½¿ç”¨ä¸€ä¸‹çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªåˆå§‹å®¹é‡ä¸º10çš„ByteBufç¼“å†²åŒºï¼Œè¿™é‡Œçš„Unpooledæ˜¯ç”¨äºå¿«é€Ÿç”ŸæˆByteBufçš„å·¥å…·ç±»</span></span><br><span class="line">    <span class="comment">//è‡³äºä¸ºå•¥å«Unpooledæ˜¯æ± åŒ–çš„æ„æ€ï¼ŒByteBufæœ‰æ± åŒ–å’Œéæ± åŒ–ä¸¤ç§ï¼ŒåŒºåˆ«åœ¨äºå¯¹å†…å­˜çš„å¤ç”¨ï¼Œæˆ‘ä»¬ä¹‹åå†è®¨è®º</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.buffer(<span class="number">10</span>);</span><br><span class="line">    System.out.println(<span class="string">"åˆå§‹çŠ¶æ€ï¼š"</span>+Arrays.toString(buf.array()));</span><br><span class="line">    buf.writeInt(-<span class="number">888888888</span>);   <span class="comment">//å†™å…¥ä¸€ä¸ªIntæ•°æ®</span></span><br><span class="line">    System.out.println(<span class="string">"å†™å…¥Intåï¼š"</span>+Arrays.toString(buf.array()));</span><br><span class="line">    buf.readShort();   <span class="comment">//æ— éœ€ç¿»è½¬ï¼Œç›´æ¥è¯»å–ä¸€ä¸ªshortæ•°æ®å‡ºæ¥</span></span><br><span class="line">    System.out.println(<span class="string">"è¯»å–Shortåï¼š"</span>+Arrays.toString(buf.array()));</span><br><span class="line">    buf.discardReadBytes();   <span class="comment">//ä¸¢å¼ƒæ“ä½œï¼Œä¼šå°†å½“å‰çš„å¯è¯»éƒ¨åˆ†å†…å®¹ä¸¢åˆ°æœ€å‰é¢ï¼Œå¹¶ä¸”è¯»å†™æŒ‡é’ˆå‘å‰ç§»åŠ¨ä¸¢å¼ƒçš„è·ç¦»</span></span><br><span class="line">    System.out.println(<span class="string">"ä¸¢å¼ƒä¹‹åï¼š"</span>+Arrays.toString(buf.array()));</span><br><span class="line">    buf.clear();    <span class="comment">//æ¸…ç©ºæ“ä½œï¼Œæ¸…ç©ºä¹‹åè¯»å†™æŒ‡é’ˆéƒ½å½’é›¶</span></span><br><span class="line">    System.out.println(<span class="string">"æ¸…ç©ºä¹‹åï¼š"</span>+Arrays.toString(buf.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡ç»“åˆæ–­ç‚¹è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿè¯»å†™æŒ‡é’ˆçš„ç§»åŠ¨æƒ…å†µï¼Œæ›´åŠ æ¸…æ¥šçš„è®¤è¯†ä¸€ä¸‹ByteBufçš„åº•å±‚æ“ä½œã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹åˆ’åˆ†æ“ä½œæ˜¯ä¸æ˜¯å’Œä¹‹å‰ä¸€æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">  	<span class="comment">//æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¸€ä¸ªbyte[]ç›´æ¥åŒ…è£…è¿›ç¼“å†²åŒºï¼ˆå’ŒNIOæ˜¯ä¸€æ ·çš„ï¼‰ä¸è¿‡å†™æŒ‡é’ˆçš„å€¼ä¸€å¼€å§‹å°±è·‘åˆ°æœ€åå»äº†ï¼Œä½†æ˜¯è¿™ç©æ„æ˜¯ä¸æ˜¯åªè¯»çš„</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.wrappedBuffer(<span class="string">"abcdefg"</span>.getBytes());</span><br><span class="line">  	<span class="comment">//é™¤äº†åŒ…è£…ï¼Œä¹Ÿå¯ä»¥å¤åˆ¶æ•°æ®ï¼ŒcopiedBuffer()ä¼šå®Œå®Œæ•´æ•´å°†æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„ç¼“å†²åŒºä¸­</span></span><br><span class="line">    buf.readByte();   <span class="comment">//è¯»å–ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">slice</span> <span class="operator">=</span> buf.slice();   <span class="comment">//ç°åœ¨è¯»æŒ‡é’ˆä½äº1ï¼Œç„¶åè¿›è¡Œåˆ’åˆ†</span></span><br><span class="line"></span><br><span class="line">    System.out.println(slice.arrayOffset());   <span class="comment">//å¾—åˆ°åˆ’åˆ†å‡ºæ¥çš„ByteBufçš„åç§»åœ°å€</span></span><br><span class="line">    System.out.println(Arrays.toString(slice.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåˆ’åˆ†ä¹Ÿæ˜¯æ ¹æ®å½“å‰è¯»å–çš„ä½ç½®æ¥è¿›è¡Œçš„ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­æ¥çœ‹çœ‹å®ƒçš„å¦ä¸€ä¸ªç‰¹æ€§ï¼ŒåŠ¨æ€æ‰©å®¹ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªå®¹é‡ä¸º10çš„ç¼“å†²åŒºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.buffer(<span class="number">10</span>);    <span class="comment">//å®¹é‡åªæœ‰10å­—èŠ‚</span></span><br><span class="line">    System.out.println(buf.capacity());</span><br><span class="line">  	<span class="comment">//ç›´æ¥å†™ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">    buf.writeCharSequence(<span class="string">"å¢æœ¬ä¼Ÿç‰›é€¼ï¼"</span>, StandardCharsets.UTF_8);   <span class="comment">//å¾ˆæ˜æ˜¾è¿™ä¹ˆå¤šå­—å·²ç»è¶…è¿‡10å­—èŠ‚äº†</span></span><br><span class="line">    System.out.println(buf.capacity());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡ç»“æœæˆ‘ä»¬å‘ç°ï¼Œåœ¨å†™å…¥ä¸€ä¸ªè¶…å‡ºå½“å‰å®¹é‡çš„æ•°æ®æ—¶ï¼Œä¼šè¿›è¡ŒåŠ¨æ€æ‰©å®¹ï¼Œæ‰©å®¹ä¼šä»64å¼€å§‹ï¼Œä¹‹åæ¯æ¬¡è§¦å‘æ‰©å®¹éƒ½ä¼šx2ï¼Œå½“ç„¶å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›å®ƒæ‰©å®¹ï¼Œå¯ä»¥æŒ‡å®šæœ€å¤§å®¹é‡ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//åœ¨ç”Ÿæˆæ—¶æŒ‡å®šmaxCapacityä¹Ÿä¸º10</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.buffer(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    System.out.println(buf.capacity());</span><br><span class="line">    buf.writeCharSequence(<span class="string">"å¢æœ¬ä¼Ÿç‰›é€¼ï¼"</span>, StandardCharsets.UTF_8);</span><br><span class="line">    System.out.println(buf.capacity());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç°åœ¨æ— æ³•å†åŠ¨æ€æ‰©å®¹äº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1zxvmzz7hj224806sq64.jpg" alt="image-20220507165153381"></p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸€ä¸‹ç¼“å†²åŒºçš„ä¸‰ç§å®ç°æ¨¡å¼ï¼šå †ç¼“å†²åŒºæ¨¡å¼ã€ç›´æ¥ç¼“å†²åŒºæ¨¡å¼ã€å¤åˆç¼“å†²åŒºæ¨¡å¼ã€‚</p>
<p>å †ç¼“å†²åŒºï¼ˆæ•°ç»„å®ç°ï¼‰å’Œç›´æ¥ç¼“å†²åŒºï¼ˆå †å¤–å†…å­˜å®ç°ï¼‰ä¸ç”¨å¤šè¯´ï¼Œå‰é¢æˆ‘ä»¬åœ¨NIOä¸­å·²ç»äº†è§£è¿‡äº†ï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªç›´æ¥ç¼“å†²åŒºä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.directBuffer(<span class="number">10</span>);</span><br><span class="line">    System.out.println(Arrays.toString(buf.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åŒæ ·çš„ä¸èƒ½ç›´æ¥æ‹¿åˆ°æ•°ç»„ï¼Œå› ä¸ºåº•å±‚å‹æ ¹ä¸æ˜¯æ•°ç»„å®ç°çš„ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1zxbvl2y3j21h803st9z.jpg" alt="image-20220507163253662"></p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹å¤åˆæ¨¡å¼ï¼Œå¤åˆæ¨¡å¼å¯ä»¥ä»»æ„åœ°æ‹¼å‡‘ç»„åˆå…¶ä»–ç¼“å†²åŒºï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1zygujz9sj21no0c0abg.jpg" alt="image-20220507171216323"></p>
<p>è¿™æ ·ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹ä¸¤ä¸ªç¼“å†²åŒºç»„åˆçš„å†…å®¹è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬å°±ä¸ç”¨å†å•ç‹¬åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºäº†ï¼Œè€Œæ˜¯ç›´æ¥å°†å…¶è¿›è¡Œæ‹¼æ¥æ“ä½œï¼Œç›¸å½“äºæ˜¯ä½œä¸ºå¤šä¸ªç¼“å†²åŒºç»„åˆçš„è§†å›¾ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªå¤åˆç¼“å†²åŒº</span></span><br><span class="line"><span class="type">CompositeByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.compositeBuffer();</span><br><span class="line">buf.addComponent(Unpooled.copiedBuffer(<span class="string">"abc"</span>.getBytes()));</span><br><span class="line">buf.addComponent(Unpooled.copiedBuffer(<span class="string">"def"</span>.getBytes()));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; buf.capacity(); i++) {</span><br><span class="line">    System.out.println((<span class="type">char</span>) buf.getByte(i));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹Ÿå¯ä»¥æ­£å¸¸æ“ä½œç»„åˆåçš„ç¼“å†²åŒºã€‚</p>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œæ± åŒ–ç¼“å†²åŒºå’Œéæ± åŒ–ç¼“å†²åŒºçš„åŒºåˆ«ã€‚</p>
<p>æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹Unpooledå·¥å…·ç±»ä¸­å…·ä½“æ˜¯å¦‚ä½•åˆ›å»ºbufferçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Unpooled</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteBufAllocator ALLOC;  <span class="comment">//å®é™…ä¸Šå†…éƒ¨æ˜¯æœ‰ä¸€ä¸ªByteBufAllocatorå¯¹è±¡çš„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteOrder BIG_ENDIAN;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteOrder LITTLE_ENDIAN;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteBuf EMPTY_BUFFER;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteBuf <span class="title function_">buffer</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> ALLOC.heapBuffer();   <span class="comment">//ç¼“å†²åŒºçš„åˆ›å»ºæ“ä½œå®é™…ä¸Šæ˜¯ä¾é ByteBufAllocatoræ¥è¿›è¡Œçš„</span></span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">  	...</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">static</span> {   <span class="comment">//ALLOCåœ¨é™æ€ä»£ç å—ä¸­è¿›è¡ŒæŒ‡å®šï¼Œå®é™…ä¸ŠçœŸæ­£çš„å®ç°ç±»æ˜¯UnpooledByteBufAllocator</span></span><br><span class="line">        ALLOC = UnpooledByteBufAllocator.DEFAULT;</span><br><span class="line">        BIG_ENDIAN = ByteOrder.BIG_ENDIAN;</span><br><span class="line">        LITTLE_ENDIAN = ByteOrder.LITTLE_ENDIAN;</span><br><span class="line">        EMPTY_BUFFER = ALLOC.buffer(<span class="number">0</span>, <span class="number">0</span>);   <span class="comment">//ç©ºç¼“å†²åŒºå®¹é‡å’Œæœ€å¤§å®¹é‡éƒ½æ˜¯0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> EMPTY_BUFFER <span class="keyword">instanceof</span> EmptyByteBuf : <span class="string">"EMPTY_BUFFER must be an EmptyByteBuf."</span>;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œè¿™ä¸ªByteBufAllocatoråˆæ˜¯ä¸ªå•¥ï¼Œé¡¾åæ€ä¹‰ï¼Œå…¶å®å°±æ˜¯è´Ÿè´£åˆ†é…ç¼“å†²åŒºçš„ã€‚</p>
<p>å®ƒæœ‰ä¸¤ä¸ªå…·ä½“å®ç°ç±»ï¼š<code>UnpooledByteBufAllocator</code>å’Œ<code>PooledByteBufAllocator</code>ï¼Œä¸€ä¸ªæ˜¯éæ± åŒ–ç¼“å†²åŒºç”Ÿæˆå™¨ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯æ± åŒ–ç¼“å†²åŒºç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆæ± åŒ–å’Œéæ± åŒ–æœ‰å•¥åŒºåˆ«å‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šæ± åŒ–ç¼“å†²åŒºåˆ©ç”¨äº†æ± åŒ–æ€æƒ³ï¼Œå°†ç¼“å†²åŒºé€šè¿‡è®¾ç½®å†…å­˜æ± æ¥è¿›è¡Œå†…å­˜å—å¤ç”¨ï¼Œè¿™æ ·å°±ä¸ç”¨é¢‘ç¹åœ°è¿›è¡Œå†…å­˜çš„ç”³è¯·ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨å †å¤–å†…å­˜çš„æ—¶å€™ï¼Œé¿å…å¤šæ¬¡é‡å¤é€šè¿‡åº•å±‚<code>malloc()</code>å‡½æ•°ç³»ç»Ÿè°ƒç”¨ç”³è¯·å†…å­˜é€ æˆçš„æ€§èƒ½æŸå¤±ã€‚Nettyçš„å†…å­˜ç®¡ç†æœºåˆ¶ä¸»è¦æ˜¯å€Ÿé‰´Jemallocå†…å­˜åˆ†é…ç­–ç•¥ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚</p>
<p>æ‰€ä»¥ï¼Œç”±äºæ˜¯å¤ç”¨å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ByteBufAllocator</span> <span class="variable">allocator</span> <span class="operator">=</span> PooledByteBufAllocator.DEFAULT;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> allocator.directBuffer(<span class="number">10</span>);   <span class="comment">//ç”³è¯·ä¸€ä¸ªå®¹é‡ä¸º10çš„ç›´æ¥ç¼“å†²åŒº</span></span><br><span class="line">    buf.writeChar(<span class="string">'T'</span>);    <span class="comment">//éšä¾¿æ“ä½œæ“ä½œ</span></span><br><span class="line">    System.out.println(buf.readChar());</span><br><span class="line">    buf.release();    <span class="comment">//é‡Šæ”¾æ­¤ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf2</span> <span class="operator">=</span> allocator.directBuffer(<span class="number">10</span>);   <span class="comment">//é‡æ–°å†ç”³è¯·ä¸€ä¸ªåŒæ ·å¤§å°çš„ç›´æ¥ç¼“å†²åŒº</span></span><br><span class="line">    System.out.println(buf2 == buf);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨å®Œä¸€ä¸ªç¼“å†²åŒºä¹‹åï¼Œæˆ‘ä»¬å°†å…¶è¿›è¡Œèµ„æºé‡Šæ”¾ï¼Œå½“æˆ‘ä»¬å†æ¬¡ç”³è¯·ä¸€ä¸ªåŒæ ·å¤§å°çš„ç¼“å†²åŒºæ—¶ï¼Œä¼šç›´æ¥å¾—åˆ°ä¹‹å‰å·²ç»ç”³è¯·å¥½çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥ï¼ŒPooledByteBufAllocatorå®é™…ä¸Šæ˜¯å°†ByteBufå®ä¾‹æ”¾å…¥æ± ä¸­åœ¨è¿›è¡Œå¤ç”¨ã€‚</p>
<h3 id="é›¶æ‹·è´ç®€ä»‹"><a href="#é›¶æ‹·è´ç®€ä»‹" class="headerlink" title="é›¶æ‹·è´ç®€ä»‹"></a>é›¶æ‹·è´ç®€ä»‹</h3><p><strong>æ³¨æ„ï¼š</strong>æ­¤å°èŠ‚ä½œä¸ºé€‰å­¦å†…å®¹ï¼Œéœ€è¦æŒæ¡<code>æ“ä½œç³»ç»Ÿ</code>å’Œ<code>è®¡ç®—æœºç»„æˆåŸç†</code>æ‰èƒ½å­¦ä¹ ã€‚</p>
<p>é›¶æ‹·è´æ˜¯ä¸€ç§I/Oæ“ä½œä¼˜åŒ–æŠ€æœ¯ï¼Œå¯ä»¥å¿«é€Ÿé«˜æ•ˆåœ°å°†æ•°æ®ä»æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨åˆ°ç½‘ç»œæ¥å£ï¼Œè€Œä¸éœ€è¦å°†å…¶ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œé¦–å…ˆç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä»€ä¹ˆæ˜¯å†…æ ¸ç©ºé—´ï¼Œä»€ä¹ˆåˆæ˜¯ç”¨æˆ·ç©ºé—´å‘¢ï¼Ÿ</p>
<p>å…¶å®æ—©æœŸæ“ä½œç³»ç»Ÿæ˜¯ä¸åŒºåˆ†å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„ï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºèƒ½è®¿é—®ä»»æ„å†…å­˜ç©ºé—´ï¼Œç¨‹åºå¾ˆå®¹æ˜“ä¸ç¨³å®šï¼Œå¸¸å¸¸æŠŠç³»ç»Ÿæå´©æºƒï¼Œæ¯”å¦‚æ¸…é™¤æ“ä½œç³»ç»Ÿçš„å†…å­˜æ•°æ®ã€‚å®é™…ä¸Šè®©åº”ç”¨ç¨‹åºéšä¾¿è®¿é—®å†…å­˜çœŸçš„å¤ªå±é™©äº†ï¼Œäºæ˜¯å°±æŒ‰ç…§CPU æŒ‡ä»¤çš„é‡è¦ç¨‹åº¦å¯¹æŒ‡ä»¤è¿›è¡Œäº†åˆ†çº§ï¼ŒæŒ‡ä»¤åˆ†ä¸ºå››ä¸ªçº§åˆ«ï¼šRing0 ~ Ring3ï¼ŒLinux ä¸‹åªä½¿ç”¨äº† Ring0 å’Œ Ring3 ä¸¤ä¸ªè¿è¡Œçº§åˆ«ï¼Œè¿›ç¨‹è¿è¡Œåœ¨ Ring3 çº§åˆ«æ—¶è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼ŒæŒ‡ä»¤åªè®¿é—®ç”¨æˆ·ç©ºé—´ï¼Œè€Œè¿è¡Œåœ¨ Ring0 çº§åˆ«æ—¶è¢«ç§°ä¸ºè¿è¡Œåœ¨å†…æ ¸æ€ï¼Œå¯ä»¥è®¿é—®ä»»æ„å†…å­˜ç©ºé—´ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25i6lqr4hj21l80gct9n.jpg" alt="image-20220512122211805"></p>
<p>æ¯”å¦‚æˆ‘ä»¬Javaä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå®é™…ä¸Šæœ€ç»ˆæ˜¯è¦äº¤ç»™æ“ä½œç³»ç»Ÿæ¥ä¸ºæˆ‘ä»¬è¿›è¡Œåˆ†é…çš„ï¼Œè€Œéœ€è¦æ“ä½œç³»ç»Ÿå¸®åŠ©æˆ‘ä»¬å®Œæˆä»»åŠ¡åˆ™éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯å†…æ ¸åœ¨è¿›è¡Œå¤„ç†ï¼Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±çš„ç¨‹åºåœ¨å¤„ç†ï¼Œè¿™æ—¶å°±ç›¸å½“äºæˆ‘ä»¬çš„ç¨‹åºå¤„äºäº†å†…æ ¸æ€ï¼Œè€Œå½“æ“ä½œç³»ç»Ÿåº•å±‚åˆ†é…å®Œæˆï¼Œæœ€ååˆ°æˆ‘ä»¬Javaä»£ç ä¸­è¿”å›å¾—åˆ°çº¿ç¨‹å¯¹è±¡æ—¶ï¼Œåˆç»§ç»­ç”±æˆ‘ä»¬çš„ç¨‹åºè¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥ä»å†…æ ¸æ€è½¬æ¢å›äº†ç”¨æˆ·æ€ã€‚</p>
<p>è€Œæˆ‘ä»¬çš„æ–‡ä»¶æ“ä½œä¹Ÿæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å®é™…ä¸Šä¹Ÿæ˜¯éœ€è¦è®©æ“ä½œç³»ç»Ÿå¸®åŠ©æˆ‘ä»¬ä»ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶æ•°æ®æˆ–æ˜¯å‘ç½‘ç»œå‘é€æ•°æ®ï¼Œæ¯”å¦‚ä½¿ç”¨ä¼ ç»ŸIOçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦ä»ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶ç„¶åå‘é€åˆ°ç½‘ç»œä¸Šï¼Œå°±ä¼šç»å†ä»¥ä¸‹æµç¨‹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25ify7168j21s60i4n0f.jpg" alt="image-20220512123113806"></p>
<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹ä¸­æ˜¯ç»å†äº†2æ¬¡CPUæ‹·è´+2æ¬¡DMAæ‹·è´ï¼Œä¸€å…±å››æ¬¡æ‹·è´ï¼Œè™½ç„¶é€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œä½†æ˜¯æ•°æ®è€æ˜¯è¿™æ ·æ¥å›è¿›è¡Œå¤åˆ¶ï¼Œæ˜¯ä¸æ˜¯å¤ªæµªè´¹æ—¶é—´äº†ç‚¹ï¼Ÿæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å¯»æ‰¾ä¸€ç§æ›´å¥½çš„æ–¹å¼ï¼Œæ¥å®ç°é›¶æ‹·è´ã€‚</p>
<p>å®ç°é›¶æ‹·è´æˆ‘ä»¬è¿™é‡Œæ¼”ç¤ºä¸‰ç§æ–¹æ¡ˆï¼š</p>
<ol>
<li><p>ä½¿ç”¨è™šæ‹Ÿå†…å­˜</p>
<p>ç°åœ¨çš„æ“ä½œç³»ç»ŸåŸºæœ¬éƒ½æ˜¯æ”¯æŒè™šæ‹Ÿå†…å­˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®©å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿåœ°å€æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€ï¼Œè¿™æ ·å°±ç›¸å½“äºæ˜¯ç›´æ¥å…±ç”¨äº†è¿™ä¸€å—åŒºåŸŸï¼Œä¹Ÿå°±è°ˆä¸ä¸Šæ‹·è´æ“ä½œäº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25iui62e8j21na0i477f.jpg" alt="image-20220512124512936"></p>
</li>
<li><p>ä½¿ç”¨mmap/writeå†…å­˜æ˜ å°„</p>
<p>å®é™…ä¸Šè¿™ç§æ–¹å¼å°±æ˜¯å°†å†…æ ¸ç©ºé—´ä¸­çš„ç¼“å­˜ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ç¼“å­˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åœ¨å­¦ä¹ NIOä¸­ä½¿ç”¨çš„MappedByteBufferï¼Œå°±æ˜¯ç›´æ¥ä½œä¸ºæ˜ å°„å­˜åœ¨ï¼Œå½“æˆ‘ä»¬éœ€è¦å°†æ•°æ®å‘é€åˆ°Socketç¼“å†²åŒºæ—¶ï¼Œç›´æ¥åœ¨å†…æ ¸ç©ºé—´ä¸­è¿›è¡Œæ“ä½œå°±è¡Œäº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25iwxop2wj21ky0i0ad1.jpg" alt="image-20220512124732995"></p>
<p>ä¸è¿‡è¿™æ ·è¿˜æ˜¯ä¼šå‡ºç°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæˆ‘ä»¬å¾—å†ä¼˜åŒ–ä¼˜åŒ–ã€‚</p>
</li>
<li><p>ä½¿ç”¨sendfileæ–¹å¼</p>
<p>åœ¨Linux2.1å¼€å§‹ï¼Œå¼•å…¥äº†sendfileæ–¹å¼æ¥ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å‘Šè¯‰å†…æ ¸è¦æŠŠå“ªä¸ªæ–‡ä»¶æ•°æ®æ‹·è´æ‹·è´åˆ°Socketä¸Šï¼Œç›´æ¥åœ¨å†…æ ¸ç©ºé—´ä¸­ä¸€æ­¥åˆ°ä½ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25izbhxnrj21f60hwtb0.jpg" alt="image-20220512124950007"></p>
<p>æ¯”å¦‚æˆ‘ä»¬ä¹‹å‰åœ¨NIOä¸­ä½¿ç”¨çš„<code>transferTo()</code>æ–¹æ³•ï¼Œå°±æ˜¯åˆ©ç”¨äº†è¿™ç§æœºåˆ¶æ¥å®ç°é›¶æ‹·è´çš„ã€‚</p>
</li>
</ol>
<h3 id="Nettyå·¥ä½œæ¨¡å‹"><a href="#Nettyå·¥ä½œæ¨¡å‹" class="headerlink" title="Nettyå·¥ä½œæ¨¡å‹"></a>Nettyå·¥ä½œæ¨¡å‹</h3><p>å‰é¢æˆ‘ä»¬äº†è§£äº†Nettyä¸ºæˆ‘ä»¬æä¾›çš„æ›´é«˜çº§çš„ç¼“å†²åŒºç±»ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹Nettyæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸Šä¸€ç« æˆ‘ä»¬ä»‹ç»äº†Reactoræ¨¡å¼ï¼Œè€ŒNettyæ­£æ˜¯ä»¥ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹ä¸ºåŸºç¡€ï¼Œæ„å»ºå‡ºäº†ä¸€å¥—é«˜æ•ˆçš„å·¥ä½œæ¨¡å‹ã€‚</p>
<p>å¤§è‡´å·¥ä½œæ¨¡å‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h22hrmmll1j21hg0c040d.jpg" alt="image-20220509215109408"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹éå¸¸ç±»ä¼¼ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1xgciyet7j21f40cijtp.jpg" alt="image-20220505131410997"></p>
<p>æ‰€æœ‰çš„å®¢æˆ·ç«¯éœ€è¦è¿æ¥åˆ°ä¸»Reactorå®ŒæˆAcceptæ“ä½œåï¼Œå…¶ä»–çš„æ“ä½œç”±ä»Reactorå»å®Œæˆï¼Œè¿™é‡Œä¹Ÿæ˜¯å·®ä¸å¤šçš„æ€æƒ³ï¼Œä½†æ˜¯å®ƒè¿›è¡Œäº†ä¸€äº›æ”¹è¿›ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„è®¾è®¡ï¼š</p>
<ul>
<li>Netty æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± BossGroupå’ŒWorkerGroupï¼ŒBossGroupä¸“é—¨è´Ÿè´£æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥, WorkerGroupä¸“é—¨è´Ÿè¯»å†™ï¼Œå°±åƒæˆ‘ä»¬å‰é¢è¯´çš„ä¸»ä»Reactorä¸€æ ·ã€‚</li>
<li>æ— è®ºæ˜¯BossGroupè¿˜æ˜¯WorkerGroupï¼Œéƒ½æ˜¯ä½¿ç”¨EventLoopï¼ˆäº‹ä»¶å¾ªç¯ï¼Œå¾ˆå¤šç³»ç»Ÿéƒ½é‡‡ç”¨äº†äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œæ¯”å¦‚å‰ç«¯æ¡†æ¶Node.jsï¼Œäº‹ä»¶å¾ªç¯é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­åœ°è¿›è¡Œäº‹ä»¶é€šçŸ¥ï¼‰æ¥è¿›è¡Œäº‹ä»¶ç›‘å¬çš„ï¼Œæ•´ä¸ªNettyä¹Ÿæ˜¯ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¥è¿ä½œçš„ï¼Œæ¯”å¦‚å½“å®¢æˆ·ç«¯å·²ç»å‡†å¤‡å¥½è¯»å†™ã€è¿æ¥å»ºç«‹æ—¶ï¼Œéƒ½ä¼šè¿›è¡Œäº‹ä»¶é€šçŸ¥ï¼Œè¯´ç™½äº†å°±åƒæˆ‘ä»¬ä¹‹å‰å†™NIOå¤šè·¯å¤ç”¨é‚£æ ·ï¼Œåªä¸è¿‡è¿™é‡Œæ¢æˆEventLoopäº†è€Œå·²ï¼Œå®ƒå·²ç»å¸®åŠ©æˆ‘ä»¬å°è£…å¥½äº†ä¸€äº›å¸¸ç”¨æ“ä½œï¼Œè€Œä¸”æˆ‘ä»¬å¯ä»¥è‡ªå·±æ·»åŠ ä¸€äº›é¢å¤–çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰å¤šä¸ªEventLoopï¼Œä¼šå­˜æ”¾åœ¨EventLoopGroupä¸­ï¼ŒEventLoopGroupå°±æ˜¯BossGroupå’ŒWorkerGroupçš„å…·ä½“å®ç°ã€‚</li>
<li>åœ¨BossGroupä¹‹åï¼Œä¼šæ­£å¸¸å°†SocketChannelç»‘å®šåˆ°WorkerGroupä¸­çš„å…¶ä¸­ä¸€ä¸ªEventLoopä¸Šï¼Œè¿›è¡Œåç»­çš„è¯»å†™æ“ä½œç›‘å¬ã€‚</li>
</ul>
<p>å‰é¢æˆ‘ä»¬å¤§è‡´äº†è§£äº†ä¸€ä¸‹Nettyçš„å·¥ä½œæ¨¡å‹ï¼Œæ¥ç€æˆ‘ä»¬æ¥å°è¯•åˆ›å»ºä¸€ä¸ªNettyæœåŠ¡å™¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨NioEventLoopGroupå®ç°ç±»å³å¯ï¼Œåˆ›å»ºBossGroupå’ŒWorkerGroup</span></span><br><span class="line">    <span class="comment">//å½“ç„¶è¿˜æœ‰EpollEventLoopGroupï¼Œä½†æ˜¯ä»…æ”¯æŒLinuxï¼Œè¿™æ˜¯NettyåŸºäºLinuxåº•å±‚Epollå•ç‹¬ç¼–å†™çš„ä¸€å¥—æœ¬åœ°å®ç°ï¼Œæ²¡æœ‰ä½¿ç”¨NIOé‚£å¥—</span></span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(), workerGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»</span></span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    <span class="comment">//å¯é“¾å¼ï¼Œå°±å¾ˆæ£’</span></span><br><span class="line">    bootstrap</span><br><span class="line">            .group(bossGroup, workerGroup)   <span class="comment">//æŒ‡å®šäº‹ä»¶å¾ªç¯ç»„</span></span><br><span class="line">            .channel(NioServerSocketChannel.class)   <span class="comment">//æŒ‡å®šä¸ºNIOçš„ServerSocketChannel</span></span><br><span class="line">            .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {   <span class="comment">//æ³¨æ„ï¼Œè¿™é‡Œçš„SocketChannelä¸æ˜¯æˆ‘ä»¬NIOé‡Œé¢çš„ï¼Œæ˜¯Nettyçš„</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">                    <span class="comment">//è·å–æµæ°´çº¿ï¼Œå½“æˆ‘ä»¬éœ€è¦å¤„ç†å®¢æˆ·ç«¯çš„æ•°æ®æ—¶ï¼Œå®é™…ä¸Šæ˜¯åƒæµæ°´çº¿ä¸€æ ·åœ¨å¤„ç†ï¼Œè¿™ä¸ªæµæ°´çº¿ä¸Šå¯ä»¥æœ‰å¾ˆå¤šHandler</span></span><br><span class="line">                    channel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){   <span class="comment">//æ·»åŠ ä¸€ä¸ªHandlerï¼Œè¿™é‡Œä½¿ç”¨ChannelInboundHandlerAdapter</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> {  <span class="comment">//ctxæ˜¯ä¸Šä¸‹æ–‡ï¼Œmsgæ˜¯æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œé»˜è®¤ä»¥ByteBufå½¢å¼ï¼ˆä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å½¢å¼ï¼Œåé¢å†è¯´ï¼‰</span></span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;   <span class="comment">//ç±»å‹è½¬æ¢ä¸€ä¸‹</span></span><br><span class="line">                            System.out.println(Thread.currentThread().getName()+<span class="string">" &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                            <span class="comment">//é€šè¿‡ä¸Šä¸‹æ–‡å¯ä»¥ç›´æ¥å‘é€æ•°æ®å›å»ï¼Œæ³¨æ„è¦writeAndFlushæ‰èƒ½è®©å®¢æˆ·ç«¯ç«‹å³æ”¶åˆ°</span></span><br><span class="line">                            ctx.writeAndFlush(Unpooled.wrappedBuffer(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    <span class="comment">//æœ€åç»‘å®šç«¯å£ï¼Œå¯åŠ¨</span></span><br><span class="line">    bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å†™äº†å¾ˆå¤šä¸œè¥¿ï¼Œä½†æ˜¯ä½ ä¸€å®šä¼šæ‡µé€¼ï¼Œè¿™äº›æ–°æ¥çš„ä¸œè¥¿ï¼Œéƒ½æ˜¯ä»€ä¹ˆè·Ÿä»€ä¹ˆå•Šï¼Œæ€ä¹ˆä¸€ä¸ªä¹Ÿæ²¡çœ‹æ˜ç™½ï¼Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶å…ˆå°†ä»£ç å†™åœ¨è¿™é‡Œï¼Œå…·ä½“çš„å„ä¸ªéƒ¨åˆ†ï¼Œè¿˜è¯·å¬åé¢ç»†ç»†é“æ¥ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€ç¼–å†™ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„SocketChannelï¼Œä¸€ä¼šé€šè¿‡é€šé“è¿›è¡Œé€šä¿¡</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> SocketChannel.open(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">"localhost"</span>, <span class="number">8080</span>));</span><br><span class="line">         <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)){</span><br><span class="line">        System.out.println(<span class="string">"å·²è¿æ¥åˆ°æœåŠ¡ç«¯ï¼"</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {   <span class="comment">//å’±ç»™å®ƒå¥—ä¸ªæ— é™å¾ªç¯ï¼Œè¿™æ ·å°±èƒ½ä¸€ç›´å‘æ¶ˆæ¯äº†</span></span><br><span class="line">            System.out.println(<span class="string">"è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">            <span class="keyword">if</span>(text.isEmpty()) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">//ç›´æ¥å‘é€šé“ä¸­å†™å…¥æ•°æ®ï¼ŒçœŸèˆ’æœ</span></span><br><span class="line">            channel.write(ByteBuffer.wrap(text.getBytes()));</span><br><span class="line">            System.out.println(<span class="string">"å·²å‘é€ï¼"</span>);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">            channel.read(buffer);   <span class="comment">//ç›´æ¥ä»é€šé“ä¸­è¯»å–æ•°æ®</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            System.out.println(<span class="string">"æ”¶åˆ°æœåŠ¡å™¨è¿”å›ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡é€šé“æ­£å¸¸æ”¶å‘æ•°æ®å³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±æˆåŠŸæ­å»ºå¥½äº†ä¸€ä¸ªNettyæœåŠ¡å™¨ã€‚</p>
<h3 id="Channelè¯¦è§£"><a href="#Channelè¯¦è§£" class="headerlink" title="Channelè¯¦è§£"></a>Channelè¯¦è§£</h3><p>åœ¨å­¦ä¹ NIOæ—¶ï¼Œæˆ‘ä»¬å°±å·²ç»æ¥è§¦åˆ°Channeläº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é€šé“æ¥è¿›è¡Œæ•°æ®çš„ä¼ è¾“ï¼Œå¹¶ä¸”é€šé“æ”¯æŒåŒå‘ä¼ è¾“ã€‚</p>
<p>è€Œåœ¨Nettyä¸­ï¼Œä¹Ÿæœ‰å¯¹åº”çš„Channelç±»å‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Channel</span> <span class="keyword">extends</span> <span class="title class_">AttributeMap</span>, ChannelOutboundInvoker, Comparable&lt;Channel&gt; {</span><br><span class="line">    ChannelId <span class="title function_">id</span><span class="params">()</span>;   <span class="comment">//é€šé“ID</span></span><br><span class="line">    EventLoop <span class="title function_">eventLoop</span><span class="params">()</span>;   <span class="comment">//è·å–æ­¤é€šé“æ‰€å±çš„EventLoopï¼Œå› ä¸ºä¸€ä¸ªChannelåœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…åªèƒ½æ³¨å†Œåˆ°ä¸€ä¸ªEventLoopä¸­</span></span><br><span class="line">    Channel <span class="title function_">parent</span><span class="params">()</span>;   <span class="comment">//Channelæ˜¯å…·æœ‰å±‚çº§å…³ç³»çš„ï¼Œè¿™é‡Œæ˜¯è¿”å›çˆ¶Channel</span></span><br><span class="line">    ChannelConfig <span class="title function_">config</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isOpen</span><span class="params">()</span>;   <span class="comment">//é€šé“å½“å‰çš„ç›¸å…³çŠ¶æ€</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isRegistered</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isActive</span><span class="params">()</span>;</span><br><span class="line">    ChannelMetadata <span class="title function_">metadata</span><span class="params">()</span>;   <span class="comment">//é€šé“ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">    SocketAddress <span class="title function_">localAddress</span><span class="params">()</span>; </span><br><span class="line">    SocketAddress <span class="title function_">remoteAddress</span><span class="params">()</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">closeFuture</span><span class="params">()</span>;  <span class="comment">//å…³é—­é€šé“ï¼Œä½†æ˜¯ä¼šç”¨åˆ°ChannelFutureï¼Œåé¢è¯´</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isWritable</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">long</span> <span class="title function_">bytesBeforeUnwritable</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">long</span> <span class="title function_">bytesBeforeWritable</span><span class="params">()</span>;</span><br><span class="line">    Unsafe <span class="title function_">unsafe</span><span class="params">()</span>;</span><br><span class="line">    ChannelPipeline <span class="title function_">pipeline</span><span class="params">()</span>;   <span class="comment">//æµæ°´çº¿ï¼Œä¹‹åä¹Ÿä¼šè¯´</span></span><br><span class="line">    ByteBufAllocator <span class="title function_">alloc</span><span class="params">()</span>;   <span class="comment">//å¯ä»¥ç›´æ¥ä»Channelæ‹¿åˆ°ByteBufAllocatorçš„å®ä¾‹ï¼Œæ¥åˆ†é…ByteBuf</span></span><br><span class="line">    Channel <span class="title function_">read</span><span class="params">()</span>;</span><br><span class="line">    Channel <span class="title function_">flush</span><span class="params">()</span>;   <span class="comment">//åˆ·æ–°ï¼ŒåŸºæ“</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒNettyä¸­çš„Channelç›¸æ¯”NIOåŠŸèƒ½å°±å¤šå¾—å¤šäº†ã€‚Nettyä¸­çš„Channelä¸»è¦ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ‰€æœ‰çš„IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹åŒæ­¥è¿è¡Œï¼Œæ–¹æ³•è°ƒç”¨ä¹‹åå°±ç›´æ¥è¿”å›äº†ï¼Œé‚£æ€ä¹ˆè·å–æ“ä½œçš„ç»“æœå‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬åœ¨å‰é¢JUCç¯‡æ•™ç¨‹ä¸­å­¦ä¹ çš„Futureå—ï¼Œæ²¡é”™ï¼Œè¿™é‡Œçš„ChannelFutureä¹Ÿæ˜¯å¹²è¿™äº‹çš„ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹Channelæ¥å£çš„çˆ¶æ¥å£ChannelOutboundInvokeræ¥å£ï¼Œè¿™é‡Œé¢å®šä¹‰äº†å¤§é‡çš„I/Oæ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChannelOutboundInvoker</span> {   <span class="comment">//é€šé“å‡ºç«™è°ƒç”¨ï¼ˆåŒ…å«å¤§é‡çš„ç½‘ç»œå‡ºç«™æ“ä½œï¼Œæ¯”å¦‚å†™ï¼‰</span></span><br><span class="line">    ChannelFuture <span class="title function_">bind</span><span class="params">(SocketAddress var1)</span>;  <span class="comment">//Socketç»‘å®šã€è¿æ¥ã€æ–­å¼€ã€å…³é—­ç­‰æ“ä½œ</span></span><br><span class="line">    ChannelFuture <span class="title function_">connect</span><span class="params">(SocketAddress var1)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">connect</span><span class="params">(SocketAddress var1, SocketAddress var2)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">disconnect</span><span class="params">()</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">deregister</span><span class="params">()</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">bind</span><span class="params">(SocketAddress var1, ChannelPromise var2)</span>;    <span class="comment">//ä¸‹é¢è¿™ä¸€ç³»åˆ—è¿˜æœ‰é™„å¸¦ChannelPromiseçš„ï¼ŒChannelPromiseæˆ‘ä»¬åé¢å†è¯´ï¼Œå…¶å®å°±æ˜¯ChannelFutureçš„å¢å¼ºç‰ˆ</span></span><br><span class="line">    ChannelFuture <span class="title function_">connect</span><span class="params">(SocketAddress var1, ChannelPromise var2)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">connect</span><span class="params">(SocketAddress var1, SocketAddress var2, ChannelPromise var3)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">disconnect</span><span class="params">(ChannelPromise var1)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">close</span><span class="params">(ChannelPromise var1)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">deregister</span><span class="params">(ChannelPromise var1)</span>;</span><br><span class="line">    ChannelOutboundInvoker <span class="title function_">read</span><span class="params">()</span>;</span><br><span class="line">  </span><br><span class="line">    ChannelFuture <span class="title function_">write</span><span class="params">(Object var1)</span>;    <span class="comment">//å¯ä»¥çœ‹åˆ°è¿™äº›å¸¸è§çš„å†™æ“ä½œï¼Œéƒ½æ˜¯è¿”å›çš„ChannelFutureï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ç»“æœ</span></span><br><span class="line">    ChannelFuture <span class="title function_">write</span><span class="params">(Object var1, ChannelPromise var2)</span>;</span><br><span class="line">    ChannelOutboundInvoker <span class="title function_">flush</span><span class="params">()</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">writeAndFlush</span><span class="params">(Object var1, ChannelPromise var2)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">writeAndFlush</span><span class="params">(Object var1)</span>;</span><br><span class="line">  </span><br><span class="line">    ChannelPromise <span class="title function_">newPromise</span><span class="params">()</span>;   <span class="comment">//å…¶ä»–çš„æš‚æ—¶ä¸æ</span></span><br><span class="line">    ChannelProgressivePromise <span class="title function_">newProgressivePromise</span><span class="params">()</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">newSucceededFuture</span><span class="params">()</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">newFailedFuture</span><span class="params">(Throwable var1)</span>;</span><br><span class="line">    ChannelPromise <span class="title function_">voidPromise</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å½“ç„¶å®ƒè¿˜å®ç°äº†AttributeMapæ¥å£ï¼Œå…¶å®æœ‰ç‚¹ç±»ä¼¼äºSessioné‚£ç§æ„Ÿè§‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€äº›å±æ€§ä¹‹ç±»çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AttributeMap</span> {</span><br><span class="line">    &lt;T&gt; Attribute&lt;T&gt; <span class="title function_">attr</span><span class="params">(AttributeKey&lt;T&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="type">boolean</span> <span class="title function_">hasAttr</span><span class="params">(AttributeKey&lt;T&gt; var1)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬äº†è§£äº†Nettyåº•å±‚çš„Channelä¹‹åï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ChannelHandlerï¼Œæ—¢ç„¶ç°åœ¨æœ‰äº†é€šé“ï¼Œé‚£ä¹ˆæ€ä¹ˆè¿›è¡Œæ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°†éœ€è¦å¤„ç†çš„äº‹æƒ…æ”¾åœ¨ChannelHandlerä¸­ï¼ŒChannelHandlerå……å½“äº†æ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¹‹å‰Reactoræ¨¡å¼ä¸­çš„Handlerï¼Œå…¨é å®ƒæ¥å¤„ç†è¯»å†™æ“ä½œã€‚</p>
<p>ä¸è¿‡è¿™é‡Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„ChannelHandleråœ¨è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ä¸€æ•´å¥—æµæ°´çº¿ï¼Œæˆ‘ä»¬ä¹‹åä¼šä»‹ç»ChannelPipelineã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢å°±æ˜¯ä½¿ç”¨äº†ChannelInboundHandlerAdapteræŠ½è±¡ç±»ï¼Œå®ƒæ˜¯ChannelInboundHandleræ¥å£çš„å®ç°ï¼Œç”¨äºå¤„ç†å…¥ç«™æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®é™…ä¸Šå°±æ˜¯é€šè¿‡é‡å†™å¯¹åº”çš„æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ï¼Œè¿™äº›æ–¹æ³•ä¼šåœ¨åˆé€‚çš„æ—¶é—´è¢«è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> {  </span><br><span class="line">      	<span class="comment">//ctxæ˜¯ä¸Šä¸‹æ–‡ï¼Œmsgæ˜¯æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œä»¥ByteBufå½¢å¼</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;   <span class="comment">//ç±»å‹è½¬æ¢ä¸€ä¸‹</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//é€šè¿‡ä¸Šä¸‹æ–‡å¯ä»¥ç›´æ¥å‘é€æ•°æ®å›å»ï¼Œæ³¨æ„è¦writeAndFlushæ‰èƒ½è®©å®¢æˆ·ç«¯ç«‹å³æ”¶åˆ°</span></span><br><span class="line">        ctx.writeAndFlush(Unpooled.wrappedBuffer(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å…ˆä»é¡¶å±‚æ¥å£å¼€å§‹çœ‹èµ·ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChannelHandler</span> {</span><br><span class="line">  	<span class="comment">//å½“ChannelHandlerè¢«æ·»åŠ åˆ°æµæ°´çº¿ä¸­æ—¶è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//å½“ChannelHandlerä»æµæ°´çº¿ä¸­ç§»é™¤æ—¶è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handlerRemoved</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> å·²è¿‡æ—¶é‚£å’±å°±ä¸ç®¡äº† */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext var1, Throwable var2)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inherited</span></span><br><span class="line">    <span class="meta">@Documented</span></span><br><span class="line">    <span class="meta">@Target({ElementType.TYPE})</span></span><br><span class="line">    <span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@interface</span> Sharable {</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é¡¶å±‚æ¥å£çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œå°±åªæœ‰ä¸€äº›æµæ°´çº¿ç›¸å…³çš„å›è°ƒæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸‹ä¸€çº§ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ChannelInboundHandlerç”¨äºå¤„ç†å…¥ç«™ç›¸å…³äº‹ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChannelInboundHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelHandler</span> {</span><br><span class="line">  	<span class="comment">//å½“Channelå·²ç»æ³¨å†Œåˆ°è‡ªå·±çš„EventLoopä¸Šæ—¶è°ƒç”¨ï¼Œå‰é¢æˆ‘ä»¬è¯´äº†ï¼Œä¸€ä¸ªChannelåªä¼šæ³¨å†Œåˆ°ä¸€ä¸ªEventLoopä¸Šï¼Œæ³¨å†Œåˆ°EventLoopåï¼Œè¿™æ ·æ‰ä¼šåœ¨å‘ç”Ÿå¯¹åº”äº‹ä»¶æ—¶è¢«é€šçŸ¥ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">channelRegistered</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//ä»EventLoopä¸Šå–æ¶ˆæ³¨å†Œæ—¶</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">channelUnregistered</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//å½“Channelå·²ç»å¤„äºæ´»è·ƒçŠ¶æ€æ—¶è¢«è°ƒç”¨ï¼Œæ­¤æ—¶Channelå·²ç»è¿æ¥/ç»‘å®šï¼Œå¹¶ä¸”å·²ç»å°±ç»ª</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//è·Ÿä¸Šé¢ç›¸åï¼Œä¸å†æ´»è·ƒäº†ï¼Œå¹¶ä¸”ä¸åœ¨è¿æ¥å®ƒçš„è¿œç¨‹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//å½“ä»Channelè¯»å–æ•°æ®æ—¶è¢«è°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®è¢«è‡ªåŠ¨åŒ…è£…æˆäº†ä¸€ä¸ªObjectï¼ˆé»˜è®¤æ˜¯ByteBufï¼‰</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext var1, Object var2)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//ä¸Šä¸€ä¸ªè¯»å–æ“ä½œå®Œæˆåè°ƒç”¨</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//æš‚æ—¶ä¸ä»‹ç»</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext var1, Object var2)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//å½“Channelçš„å¯å†™çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶è¢«è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext var1)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">		<span class="comment">//å‡ºç°å¼‚å¸¸æ—¶è¢«è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext var1, Throwable var2)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è€Œæˆ‘ä»¬ä¸Šé¢ç”¨åˆ°çš„ChannelInboundHandlerAdapterå®é™…ä¸Šå°±æ˜¯å¯¹è¿™äº›æ–¹æ³•å®ç°çš„æŠ½è±¡ç±»ï¼Œç›¸æ¯”ç›´æ¥ç”¨æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åªé‡å†™æˆ‘ä»¬éœ€è¦çš„æ–¹æ³•ï¼Œæ²¡æœ‰é‡å†™çš„æ–¹æ³•ä¼šé»˜è®¤å‘æµæ°´çº¿ä¸‹ä¸€ä¸ªChannelHandlerå‘é€ã€‚</p>
<p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å§ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestChannelHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"channelRegistered"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelUnregistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"channelUnregistered"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"channelActive"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"channelInactive"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//è¿™æ¬¡æˆ‘ä»¬å°±ç›´æ¥ä½¿ç”¨ctx.alloc()æ¥ç”Ÿæˆç¼“å†²åŒº</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">back</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">        back.writeCharSequence(<span class="string">"å·²æ”¶åˆ°ï¼"</span>, StandardCharsets.UTF_8);</span><br><span class="line">        ctx.writeAndFlush(back);</span><br><span class="line">        System.out.println(<span class="string">"channelRead"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"channelReadComplete"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"userEventTriggered"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"channelWritabilityChanged"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"exceptionCaught"</span>+cause);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(), workerGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    bootstrap</span><br><span class="line">            .group(bossGroup, workerGroup)</span><br><span class="line">            .channel(NioServerSocketChannel.class)</span><br><span class="line">      			<span class="comment">//ChannelInitializeræ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ChannelHandlerï¼Œå®ƒæœ¬èº«ä¸å¤„ç†ä»»ä½•å‡ºç«™/å…¥ç«™äº‹ä»¶ï¼Œå®ƒçš„ç›®çš„ä»…ä»…æ˜¯å®ŒæˆChannelçš„åˆå§‹åŒ–</span></span><br><span class="line">            .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">                    <span class="comment">//å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„ChannelHandleræ·»åŠ åˆ°æµæ°´çº¿</span></span><br><span class="line">                    channel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">TestChannelHandler</span>());</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬å¯åŠ¨æœåŠ¡å™¨ï¼Œè®©å®¢æˆ·ç«¯æ¥è¿æ¥å¹¶å‘é€ä¸€ä¸‹æ•°æ®è¯•è¯•çœ‹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h231vpff1tj21j60900tp.jpg" alt="image-20220510092703319"></p>
<p>å¯ä»¥çœ‹åˆ°ChannelInboundHandlerçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œé¦–å…ˆæ˜¯Channelæ³¨å†ŒæˆåŠŸï¼Œç„¶åæ‰ä¼šå˜æˆå¯ç”¨çŠ¶æ€ï¼Œæ¥ç€å°±å·®ä¸å¤šå¯ä»¥ç­‰å¾…å®¢æˆ·ç«¯æ¥æ•°æ®äº†ï¼Œå½“å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šå†æ¬¡è§¦å‘ä¸€æ¬¡<code>channelReadComplete</code>ï¼Œç„¶åä¸å¯ç”¨ï¼Œæœ€åå–æ¶ˆæ³¨å†Œã€‚</p>
<p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å‡ºç°å¼‚å¸¸çš„æƒ…å†µå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">    System.out.println(Thread.currentThread().getName()+<span class="string">" &gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">back</span> <span class="operator">=</span> ctx.alloc().buffer();</span><br><span class="line">    back.writeCharSequence(<span class="string">"å·²æ”¶åˆ°ï¼"</span>, StandardCharsets.UTF_8);</span><br><span class="line">    ctx.writeAndFlush(back);</span><br><span class="line">    System.out.println(<span class="string">"channelRead"</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"æˆ‘æ˜¯è‡ªå®šä¹‰å¼‚å¸¸1"</span>);  <span class="comment">//å¼„ç‚¹å¼‚å¸¸ä¸Šå»</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    System.out.println(<span class="string">"channelReadComplete"</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"æˆ‘æ˜¯è‡ªå®šä¹‰å¼‚å¸¸2"</span>);   <span class="comment">//å¼„ç‚¹å¼‚å¸¸ä¸Šå»</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    System.out.println(<span class="string">"exceptionCaught"</span>+cause);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šæ¥ç€è°ƒç”¨<code>exceptionCaught</code>æ–¹æ³•ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2329bmho8j21g407y75e.jpg" alt="image-20220510094007913"></p>
<p>ä¸ChannelInboundHandlerå¯¹åº”çš„è¿˜æœ‰ChannelOutboundHandlerç”¨äºå¤„ç†å‡ºç«™ç›¸å…³çš„æ“ä½œï¼Œè¿™é‡Œå°±ä¸è¿›è¡Œæ¼”ç¤ºäº†ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹ChannelPipelineï¼Œæ¯ä¸€ä¸ªChanneléƒ½å¯¹åº”ä¸€ä¸ªChannelPipelineï¼ˆåœ¨Channelåˆå§‹åŒ–æ—¶å°±è¢«åˆ›å»ºäº†ï¼‰</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24hpuq1sej219i08wgms.jpg" alt="image-20220511152035030"></p>
<p>å®ƒå°±åƒæ˜¯ä¸€æ¡æµæ°´çº¿ä¸€æ ·ï¼Œæ•´æ¡æµæ°´çº¿ä¸Šå¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ªHandlerï¼ˆåŒ…æ‹¬å…¥ç«™å’Œå‡ºç«™ï¼‰ï¼Œæ•´æ¡æµæ°´çº¿ä¸Šçš„ä¸¤ç«¯è¿˜æœ‰ä¸¤ä¸ªé»˜è®¤çš„å¤„ç†å™¨ï¼ˆç”¨äºä¸€äº›é¢„ç½®æ“ä½œå’Œåç»­æ“ä½œï¼Œæ¯”å¦‚é‡Šæ”¾èµ„æºç­‰ï¼‰ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒå¦‚ä½•å®‰æ’è¿™äº›è‡ªå®šä¹‰çš„Handlerå³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨å¸Œæœ›åˆ›å»ºä¸¤ä¸ªå…¥ç«™ChannelHandlerï¼Œä¸€ä¸ªç”¨äºæ¥æ”¶è¯·æ±‚å¹¶å¤„ç†ï¼Œè¿˜æœ‰ä¸€ä¸ªç”¨äºå¤„ç†å½“å‰æ¥æ”¶è¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {   <span class="comment">//æ³¨æ„ï¼Œè¿™é‡Œçš„SocketChannelä¸æ˜¯æˆ‘ä»¬NIOé‡Œé¢çš„ï¼Œæ˜¯Nettyçš„</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">        channel.pipeline()   <span class="comment">//ç›´æ¥è·å–pipelineï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªHandlerï¼Œæ³¨æ„é¡ºåº</span></span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){   <span class="comment">//ç¬¬ä¸€ä¸ªç”¨äºå¤„ç†æ¶ˆæ¯æ¥æ”¶</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                        System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"æˆ‘æ˜¯å¼‚å¸¸"</span>);</span><br><span class="line">                    }</span><br><span class="line">                })</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){   <span class="comment">//ç¬¬äºŒä¸ªç”¨äºå¤„ç†å¼‚å¸¸</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                        System.out.println(<span class="string">"æˆ‘æ˜¯å¼‚å¸¸å¤„ç†ï¼š"</span>+cause);</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿå®é™…ä¸Šå¦‚æœæˆ‘ä»¬ä¸åœ¨ChannelInboundHandlerAdapterä¸­é‡å†™å¯¹åº”çš„æ–¹æ³•ï¼Œå®ƒä¼šé»˜è®¤ä¼ æ’­åˆ°æµæ°´çº¿çš„ä¸‹ä¸€ä¸ªChannelInboundHandlerAdapterè¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    ctx.fireExceptionCaught(cause);   <span class="comment">//é€šè¿‡ChannelHandlerContextæ¥å‘ä¸‹ä¼ é€’ï¼ŒChannelHandlerContextæ˜¯åœ¨Handleræ·»åŠ è¿›Pipelineä¸­æ—¶å°±è¢«è‡ªåŠ¨åˆ›å»ºçš„</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦å°†ä¸€ä¸ªæ¶ˆæ¯åœ¨ä¸¤ä¸ªHandlerä¸­è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">    channel.pipeline()   <span class="comment">//ç›´æ¥è·å–pipelineï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªHandler</span></span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(<span class="string">"1æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                    ctx.fireChannelRead(msg);   <span class="comment">//é€šè¿‡ChannelHandlerContext</span></span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(<span class="string">"2æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹å‡ºç«™ç›¸å…³æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ChannelOutboundHandlerAdapteræ¥å®Œæˆï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">    channel.pipeline()</span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>(){   </span><br><span class="line">              <span class="comment">//æ³¨æ„å‡ºæ ˆç«™æ“ä½œåº”è¯¥åœ¨å…¥ç«™æ“ä½œçš„å‰é¢ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ChannelHandlerContextçš„writeæ–¹æ³•æ—¶ï¼Œæ˜¯ä»æµæ°´çº¿çš„å½“å‰ä½ç½®å€’ç€å¾€å‰æ‰¾ä¸‹ä¸€ä¸ªChannelOutboundHandlerAdapterï¼Œè€Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„ChannelInboundHandlerAdapteræ˜¯ä»å‰å¾€åæ‰¾ä¸‹ä¸€ä¸ªï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Channelçš„writeæ–¹æ³•ï¼Œé‚£ä¹ˆä¼šä»æ•´ä¸ªæµæ°´çº¿çš„æœ€åå¼€å§‹å€’ç€å¾€å‰æ‰¾ChannelOutboundHandlerAdapterï¼Œä¸€å®šè¦æ³¨æ„é¡ºåºã€‚</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception {  <span class="comment">//å½“æ‰§è¡Œwriteæ“ä½œæ—¶ï¼Œä¼š</span></span><br><span class="line">                    System.out.println(msg);   <span class="comment">//writeçš„æ˜¯å•¥ï¼Œè¿™é‡Œå°±æ˜¯æ˜¯å•¥</span></span><br><span class="line">                  	<span class="comment">//æˆ‘ä»¬å°†å…¶è½¬æ¢ä¸ºByteBufï¼Œè¿™æ ·æ‰èƒ½å‘é€å›å®¢æˆ·ç«¯</span></span><br><span class="line">                    ctx.writeAndFlush(Unpooled.wrappedBuffer(msg.toString().getBytes()));</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(<span class="string">"1æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                    ctx.fireChannelRead(msg);</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(<span class="string">"2æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                    ctx.writeAndFlush(<span class="string">"ä¸ä¼šå§ä¸ä¼šå§ï¼Œä¸ä¼šè¿˜æœ‰äººéƒ½çœ‹åˆ°è¿™é‡Œäº†è¿˜æ²¡ä¸‰è¿å§"</span>);   <span class="comment">//è¿™é‡Œå¯ä»¥writeä»»ä½•å¯¹è±¡</span></span><br><span class="line">                  	<span class="comment">//ctx.channel().writeAndFlush("å•Šå¯¹å¯¹å¯¹"); æˆ–æ˜¯é€šè¿‡Channelè¿›è¡Œwriteä¹Ÿå¯ä»¥</span></span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬æ¥è¯•è¯•çœ‹ï¼Œæä¸¤ä¸ªå‡ºç«™çš„Handlerï¼ŒéªŒè¯ä¸€ä¸‹æ˜¯ä¸æ˜¯ä¸Šé¢çš„æ ·å­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">    channel.pipeline()   <span class="comment">//ç›´æ¥è·å–pipelineï¼Œç„¶åæ·»åŠ ä¸¤ä¸ªHandler</span></span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(<span class="string">"1æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                    ctx.fireChannelRead(msg);</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                    System.out.println(<span class="string">"2æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                    ctx.channel().writeAndFlush(<span class="string">"ä¼å…µä¸€å·å¢æœ¬ä¼Ÿ"</span>);  <span class="comment">//è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨channelçš„write</span></span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    System.out.println(<span class="string">"1å·å‡ºç«™ï¼š"</span>+msg);</span><br><span class="line">                }</span><br><span class="line">            })</span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelOutboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    System.out.println(<span class="string">"2å·å‡ºç«™ï¼š"</span>+msg);</span><br><span class="line">                    ctx.write(msg);  <span class="comment">//ç»§ç»­writeç»™å…¶ä»–çš„å‡ºç«™Handlerï¼Œä¸ç„¶åˆ°è¿™é‡Œå°±æ–­äº†</span></span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ‰€ä»¥ï¼Œå‡ºç«™æ“ä½œåœ¨æµæ°´çº¿ä¸Šæ˜¯åç€æ¥çš„ï¼Œæ•´ä¸ªæµæ°´çº¿æ“ä½œå¤§æ¦‚æµç¨‹å¦‚ä¸‹:</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2381nnw6kj21ey0bitam.jpg" alt="image-20220510130021714"></p>
<p>æœ‰å…³ChannelåŠå…¶å¤„ç†ç›¸å…³æ“ä½œï¼Œå°±å…ˆè®²åˆ°è¿™é‡Œã€‚</p>
<h3 id="EventLoopå’Œä»»åŠ¡è°ƒåº¦"><a href="#EventLoopå’Œä»»åŠ¡è°ƒåº¦" class="headerlink" title="EventLoopå’Œä»»åŠ¡è°ƒåº¦"></a>EventLoopå’Œä»»åŠ¡è°ƒåº¦</h3><p>å‰é¢æˆ‘ä»¬è®²è§£äº†Channelï¼Œé‚£ä¹ˆåœ¨EventLoopä¸­å…·ä½“æ˜¯å¦‚ä½•è¿›è¡Œè°ƒåº¦çš„å‘¢ï¼Ÿå®é™…ä¸Šæˆ‘ä»¬ä¹‹å‰åœ¨ç¼–å†™NIOçš„æ—¶å€™ï¼Œå°±æ˜¯ä¸€ä¸ªwhileå¾ªç¯åœ¨æºæºä¸æ–­åœ°ç­‰å¾…æ–°çš„äº‹ä»¶ï¼Œè€ŒEventLoopä¹Ÿæ­£æ˜¯è¿™ç§æ€æƒ³ï¼Œå®ƒæœ¬è´¨å°±æ˜¯ä¸€ä¸ªäº‹ä»¶ç­‰å¾…/å¤„ç†çº¿ç¨‹ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2390nmv60j21es0awta1.jpg" alt="image-20220510133359757"></p>
<p>æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨çš„å°±æ˜¯EventLoopGroupï¼ŒåŒ…å«å¾ˆå¤šä¸ªEventLoopï¼Œæˆ‘ä»¬æ¯åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼Œå°±éœ€è¦ç»‘å®šåˆ°ä¸€ä¸ªEventLoopä¸Šï¼Œä¹‹åEventLoopå°±ä¼šå¼€å§‹ç›‘å¬è¿™ä¸ªè¿æ¥ï¼ˆåªè¦è¿æ¥ä¸å…³é—­ï¼Œä¸€ç›´éƒ½æ˜¯è¿™ä¸ªEventLoopè´Ÿè´£æ­¤Channelï¼‰ï¼Œè€Œä¸€ä¸ªEventLoopå¯ä»¥åŒæ—¶ç›‘å¬å¾ˆå¤šä¸ªChannelï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„Selectorç½¢äº†ã€‚</p>
<p>å½“ç„¶ï¼ŒEventLoopå¹¶ä¸åªæ˜¯ç”¨äºç½‘ç»œæ“ä½œçš„ï¼Œæˆ‘ä»¬å‰é¢æ‰€è¯´çš„EventLoopå…¶å®éƒ½æ˜¯NioEventLoopï¼Œå®ƒæ˜¯ä¸“ç”¨äºç½‘ç»œé€šä¿¡çš„ï¼Œé™¤äº†ç½‘ç»œé€šä¿¡ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨æ™®é€šçš„EventLoopæ¥å¤„ç†ä¸€äº›å…¶ä»–çš„äº‹ä»¶ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨ç¼–å†™çš„æœåŠ¡ç«¯ï¼Œè™½ç„¶ç»“æ„ä¸Šå’Œä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹å·®ä¸å¤šï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼ŒHandlerä¼¼ä¹æ˜¯å’Œè¯»å†™æ“ä½œåœ¨ä¸€èµ·è¿›è¡Œçš„ï¼Œè€Œæˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„æ¨¡å‹ä¸­ï¼ŒHandleræ˜¯åœ¨è¯»å†™ä¹‹å¤–çš„å•ç‹¬çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(), workerGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);  <span class="comment">//çº¿ç¨‹æ•°å…ˆé™åˆ¶ä¸€ä¸‹</span></span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    bootstrap</span><br><span class="line">            .group(bossGroup, workerGroup)   <span class="comment">//æŒ‡å®šäº‹ä»¶å¾ªç¯ç»„</span></span><br><span class="line">            .channel(NioServerSocketChannel.class)   <span class="comment">//æŒ‡å®šä¸ºNIOçš„ServerSocketChannel</span></span><br><span class="line">            .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {   <span class="comment">//æ³¨æ„ï¼Œè¿™é‡Œçš„SocketChannelä¸æ˜¯æˆ‘ä»¬NIOé‡Œé¢çš„ï¼Œæ˜¯Nettyçš„</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">                    channel.pipeline()</span><br><span class="line">                            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                                    System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                                    Thread.sleep(<span class="number">10000</span>);   <span class="comment">//è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¡10ç§’å‡è£…åœ¨å¤„ç†ä»»åŠ¡</span></span><br><span class="line">                                    ctx.writeAndFlush(Unpooled.wrappedBuffer(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">                                }</span><br><span class="line">                            });</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåœ¨è¿™é‡Œå¡ä½äº†ï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•å¤„ç†EventLoopç»‘å®šçš„å…¶ä»–Channeläº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±åˆ›å»ºä¸€ä¸ªæ™®é€šçš„EventLoopæ¥ä¸“é—¨å¤„ç†è¯»å†™ä¹‹å¤–çš„ä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(), workerGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);  <span class="comment">//çº¿ç¨‹æ•°å…ˆé™åˆ¶ä¸€ä¸‹</span></span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoopGroup</span>();  <span class="comment">//ä½¿ç”¨DefaultEventLoopæ¥å¤„ç†å…¶ä»–ä»»åŠ¡</span></span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    bootstrap</span><br><span class="line">            .group(bossGroup, workerGroup)</span><br><span class="line">            .channel(NioServerSocketChannel.class)</span><br><span class="line">            .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">                    channel.pipeline()</span><br><span class="line">                            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                                  	System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                                    handlerGroup.submit(() -&gt; {   </span><br><span class="line">                                <span class="comment">//ç”±äºç»§æ‰¿è‡ªScheduledExecutorServiceï¼Œæˆ‘ä»¬ç›´æ¥æäº¤ä»»åŠ¡å°±è¡Œäº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰è´¼æ–¹ä¾¿</span></span><br><span class="line">                                        <span class="keyword">try</span> {</span><br><span class="line">                                            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                                        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                                        }</span><br><span class="line">                                        ctx.writeAndFlush(Unpooled.wrappedBuffer(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">                                    });</span><br><span class="line">                                }</span><br><span class="line">                            });</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å†™æˆä¸€æ¡æµæ°´çº¿ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(), workerGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);  <span class="comment">//çº¿ç¨‹æ•°å…ˆé™åˆ¶ä¸€ä¸‹</span></span><br><span class="line">    <span class="type">EventLoopGroup</span> <span class="variable">handlerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultEventLoopGroup</span>();  <span class="comment">//ä½¿ç”¨DefaultEventLoopæ¥å¤„ç†å…¶ä»–ä»»åŠ¡</span></span><br><span class="line">    <span class="type">ServerBootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">    bootstrap</span><br><span class="line">            .group(bossGroup, workerGroup)</span><br><span class="line">            .channel(NioServerSocketChannel.class)</span><br><span class="line">            .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">                    channel.pipeline()</span><br><span class="line">                            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                                    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                                    System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                                    ctx.fireChannelRead(msg);</span><br><span class="line">                                }</span><br><span class="line">                            }).addLast(handlerGroup, <span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){  <span class="comment">//åœ¨æ·»åŠ æ—¶ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šä½¿ç”¨å“ªä¸ªEventLoopGroup</span></span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                                    <span class="keyword">try</span> {</span><br><span class="line">                                        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                                    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                                    }</span><br><span class="line">                                    ctx.writeAndFlush(Unpooled.wrappedBuffer(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">                                }</span><br><span class="line">                            });</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±è¿›ä¸€æ­¥åœ°å°†EventLoopåˆ©ç”¨èµ·æ¥äº†ã€‚</p>
<p>æŒ‰ç…§å‰é¢æœåŠ¡ç«¯çš„æ–¹å¼ï¼Œæˆ‘ä»¬æ¥æŠŠNettyç‰ˆæœ¬çš„å®¢æˆ·ç«¯ä¹Ÿç»™å†™äº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();   <span class="comment">//å®¢æˆ·ç«¯ä¹Ÿæ˜¯ä½¿ç”¨Bootstrapæ¥å¯åŠ¨</span></span><br><span class="line">    bootstrap</span><br><span class="line">            .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())   <span class="comment">//å®¢æˆ·ç«¯å°±æ²¡é‚£ä¹ˆéº»çƒ¦äº†ï¼Œç›´æ¥ä¸€ä¸ªEventLoopå°±è¡Œï¼Œç”¨äºå¤„ç†å‘å›æ¥çš„æ•°æ®</span></span><br><span class="line">            .channel(NioSocketChannel.class)   <span class="comment">//å®¢æˆ·ç«¯è‚¯å®šå°±æ˜¯ä½¿ç”¨SocketChanneläº†</span></span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {   <span class="comment">//è¿™é‡Œçš„æ•°æ®å¤„ç†æ–¹å¼å’ŒæœåŠ¡ç«¯æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    channel.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){   </span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">                            System.out.println(<span class="string">"&gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.connect(<span class="string">"localhost"</span>, <span class="number">8080</span>).channel();  <span class="comment">//è¿æ¥åæ‹¿åˆ°å¯¹åº”çš„Channelå¯¹è±¡</span></span><br><span class="line">  	<span class="comment">//æ³¨æ„ä¸Šé¢è¿æ¥æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œè°ƒç”¨ä¹‹åä¼šç»§ç»­å¾€ä¸‹èµ°ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ­£å¼ç¼–å†™å®¢æˆ·ç«¯çš„æ•°æ®å‘é€ä»£ç äº†</span></span><br><span class="line">    <span class="keyword">try</span>(<span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)){    <span class="comment">//è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œæ‰«äº†å°±å‘</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            System.out.println(<span class="string">"&lt;&lt; è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">            <span class="keyword">if</span>(text.isEmpty()) <span class="keyword">continue</span>;</span><br><span class="line">            channel.writeAndFlush(Unpooled.wrappedBuffer(text.getBytes()));  <span class="comment">//é€šè¿‡Channelå¯¹è±¡å‘é€æ•°æ®</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å§ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h23b2raotjj21a607u3zd.jpg" alt="image-20220510144513303"></p>
<h3 id="Futureå’ŒPromise"><a href="#Futureå’ŒPromise" class="headerlink" title="Futureå’ŒPromise"></a>Futureå’ŒPromise</h3><p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ChannelFutureï¼Œå‰é¢æˆ‘ä»¬æåˆ°ï¼ŒNettyä¸­Channelçš„ç›¸å…³æ“ä½œéƒ½æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œå¹¶ä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹åŒæ­¥æ‰§è¡Œï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹å³å¾—åˆ°æ‰§è¡Œç»“æœï¼Œå¦‚æœéœ€è¦å¾—åˆ°ç»“æœï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¿…é¡»è¦åˆ©ç”¨åˆ°Futureã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ChannelFutueræ¥å£æ€ä¹ˆå®šä¹‰çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChannelFuture</span> <span class="keyword">extends</span> <span class="title class_">Future</span>&lt;Void&gt; {</span><br><span class="line">    Channel <span class="title function_">channel</span><span class="params">()</span>;    <span class="comment">//æˆ‘ä»¬å¯ä»¥ç›´æ¥è·å–æ­¤ä»»åŠ¡çš„Channel</span></span><br><span class="line">    ChannelFuture <span class="title function_">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt; var1)</span>;  <span class="comment">//å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œä¼šç›´æ¥æ‰§è¡ŒGenericFutureListenerçš„ä»»åŠ¡ï¼Œæ³¨æ„æ‰§è¡Œçš„ä½ç½®ä¹Ÿæ˜¯åœ¨EventLoopä¸­</span></span><br><span class="line">    ChannelFuture <span class="title function_">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt;... var1)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt; var1)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> Void&gt;&gt;... var1)</span>;</span><br><span class="line">    ChannelFuture <span class="title function_">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;   <span class="comment">//åœ¨å½“å‰çº¿ç¨‹åŒæ­¥ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œä»»åŠ¡å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    ChannelFuture <span class="title function_">syncUninterruptibly</span><span class="params">()</span>;   <span class="comment">//åŒä¸Šï¼Œä½†æ˜¯æ— æ³•å“åº”ä¸­æ–­</span></span><br><span class="line">    ChannelFuture <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;  <span class="comment">//åŒä¸Šï¼Œä½†æ˜¯ä»»åŠ¡ä¸­æ–­ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦æ‰‹åŠ¨åˆ¤æ–­</span></span><br><span class="line">    ChannelFuture <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;    <span class="comment">//ä¸ç”¨æˆ‘è¯´äº†å§ï¼Ÿ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isVoid</span><span class="params">()</span>;   <span class="comment">//è¿”å›ç±»å‹æ˜¯å¦ä¸ºvoid</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ­¤æ¥å£æ˜¯ç»§æ‰¿è‡ªNettyä¸­çš„Futureæ¥å£çš„ï¼ˆä¸æ˜¯JDKçš„é‚£ä¸ªï¼‰ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Future</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">java</span>.util.concurrent.Future&lt;V&gt; {   <span class="comment">//å†å¾€ä¸Šæ‰æ˜¯JDKçš„Future</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isSuccess</span><span class="params">()</span>;    <span class="comment">//ç”¨äºåˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸçš„</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancellable</span><span class="params">()</span>;</span><br><span class="line">    Throwable <span class="title function_">cause</span><span class="params">()</span>;    <span class="comment">//è·å–å¯¼è‡´ä»»åŠ¡å¤±è´¥çš„å¼‚å¸¸</span></span><br><span class="line">    </span><br><span class="line">  	...</span><br><span class="line">    </span><br><span class="line">    V <span class="title function_">getNow</span><span class="params">()</span>;  <span class="comment">//ç«‹å³è·å–ç»“æœï¼Œå¦‚æœè¿˜æœªäº§ç”Ÿç»“æœï¼Œå¾—åˆ°nullï¼Œä¸è¿‡ChannelFutureå®šä¹‰Vä¸ºVoidï¼Œå°±ç®—å®Œæˆäº†è·å–ä¹Ÿæ˜¯null</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> var1)</span>;    <span class="comment">//å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Channelçš„å¾ˆå¤šæ“ä½œéƒ½æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªChannelFutureï¼Œæ¯”å¦‚Channelçš„writeæ“ä½œï¼Œè¿”å›çš„å°±æ˜¯ä¸€ä¸ªChannelFutureå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+buf.toString(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> ctx.writeAndFlush(Unpooled.wrappedBuffer(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">        System.out.println(<span class="string">"ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼š"</span>+future.isDone());   <span class="comment">//é€šè¿‡ChannelFutureæ¥è·å–ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>åŒ…æ‹¬æˆ‘ä»¬çš„æœåŠ¡ç«¯å¯åŠ¨ä¹Ÿæ˜¯è¿”å›çš„ChannelFutureï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">								}</span><br><span class="line">            });</span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">    System.out.println(<span class="string">"æœåŠ¡ç«¯å¯åŠ¨çŠ¶æ€ï¼š"</span>+future.isDone());</span><br><span class="line">    System.out.println(<span class="string">"æˆ‘æ˜¯æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹åè¦åšçš„äº‹æƒ…ï¼"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡ç«¯çš„å¯åŠ¨å°±æ¯”è¾ƒæ…¢äº†ï¼Œæ‰€ä»¥åœ¨ä¸€å¼€å§‹ç›´æ¥è·å–çŠ¶æ€ä¼šè¿”å›<code>false</code>ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆéœ€è¦ç­‰åˆ°æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹ååšä¸€äº›äº‹æƒ…ï¼Œè¿™ä¸ªæ—¶å€™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿç°åœ¨æˆ‘ä»¬å°±æœ‰ä¸¤ç§æ–¹æ¡ˆäº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">    future.sync();   <span class="comment">//è®©å½“å‰çº¿ç¨‹åŒæ­¥ç­‰å¾…ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">    System.out.println(<span class="string">"æœåŠ¡ç«¯å¯åŠ¨çŠ¶æ€ï¼š"</span>+future.isDone());</span><br><span class="line">    System.out.println(<span class="string">"æˆ‘æ˜¯æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹åè¦åšçš„äº‹æƒ…ï¼"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç¬¬ä¸€ç§æ–¹æ¡ˆæ˜¯ç›´æ¥è®©å½“å‰çº¿ç¨‹åŒæ­¥ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>sync()</code>æ–¹æ³•ï¼Œè¿™æ ·å½“å‰çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ç›´åˆ°ä»»åŠ¡ç»“æŸã€‚ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆæ—¶é€šçŸ¥ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.bind(<span class="number">8080</span>);</span><br><span class="line">		<span class="comment">//ç›´æ¥æ·»åŠ ç›‘å¬å™¨ï¼Œå½“ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œä½†æ˜¯æ³¨æ„æ‰§è¡Œä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œä¸æ˜¯åœ¨å½“å‰çº¿ç¨‹</span></span><br><span class="line">    future.addListener(f -&gt; System.out.println(<span class="string">"æˆ‘æ˜¯æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹åè¦åšçš„äº‹æƒ…ï¼"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åŒ…æ‹¬å®¢æˆ·ç«¯çš„å…³é—­ï¼Œä¹Ÿæ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>(<span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)){</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        System.out.println(<span class="string">"&lt;&lt; è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">        <span class="keyword">if</span>(text.isEmpty()) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span>(text.equals(<span class="string">"exit"</span>)) {   <span class="comment">//è¾“å…¥exitå°±é€€å‡º</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> channel.close();</span><br><span class="line">            future.sync();    <span class="comment">//ç­‰å¾…Channelå®Œå…¨å…³é—­</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        channel.writeAndFlush(Unpooled.wrappedBuffer(text.getBytes()));</span><br><span class="line">    }</span><br><span class="line">} <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">} <span class="keyword">finally</span> {</span><br><span class="line">    group.shutdownGracefully();   <span class="comment">//ä¼˜é›…é€€å‡ºEventLoopï¼Œå…¶å®å°±æ˜¯æŠŠè¿˜æ²¡å‘é€çš„æ•°æ®ä¹‹ç±»çš„äº‹æƒ…åšå®Œï¼Œå½“ç„¶ä¹Ÿå¯ä»¥shutdownNowç«‹å³å…³é—­</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹Promiseæ¥å£ï¼Œå®ƒæ”¯æŒæ‰‹åŠ¨è®¾å®šæˆåŠŸå’Œå¤±è´¥çš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ­¤æ¥å£ä¹Ÿæ˜¯ç»§æ‰¿è‡ªNettyä¸­çš„Futureæ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Promise</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">Future</span>&lt;V&gt; {</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">setSuccess</span><span class="params">(V var1)</span>;    <span class="comment">//æ‰‹åŠ¨è®¾å®šæˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">trySuccess</span><span class="params">(V var1)</span>;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">setFailure</span><span class="params">(Throwable var1)</span>;  <span class="comment">//æ‰‹åŠ¨è®¾å®šå¤±è´¥</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryFailure</span><span class="params">(Throwable var1)</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">setUncancellable</span><span class="params">()</span>;</span><br><span class="line">		<span class="comment">//è¿™äº›å°±å’Œä¹‹å‰çš„Futureæ˜¯ä¸€æ ·çš„äº†</span></span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt; var1)</span>;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt;... var1)</span>;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt; var1)</span>;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="built_in">super</span> V&gt;&gt;... var1)</span>;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    Promise&lt;V&gt; <span class="title function_">syncUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¯”å¦‚æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    Promise&lt;String&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>());</span><br><span class="line">    System.out.println(promise.isSuccess());    <span class="comment">//åœ¨ä¸€å¼€å§‹è‚¯å®šä¸æ˜¯æˆåŠŸçš„</span></span><br><span class="line">    promise.setSuccess(<span class="string">"lbwnb"</span>);    <span class="comment">//è®¾å®šæˆåŠŸ</span></span><br><span class="line">    System.out.println(promise.isSuccess());   <span class="comment">//å†æ¬¡è·å–ï¼Œå¯ä»¥å‘ç°ç¡®å®æˆåŠŸäº†</span></span><br><span class="line">    System.out.println(promise.get());    <span class="comment">//è·å–ç»“æœï¼Œå°±æ˜¯æˆ‘ä»¬åˆšåˆšç»™è¿›å»çš„</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æŒ‡å®šæˆåŠŸçŠ¶æ€ï¼ŒåŒ…æ‹¬ChannelOutboundInvokerä¸­çš„ä¸€äº›åŸºæœ¬æ“ä½œï¼Œéƒ½æ˜¯æ”¯æŒChannelPromiseçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> (ByteBuf) msg;</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> buf.toString(StandardCharsets.UTF_8);</span><br><span class="line">        System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span>+text);</span><br><span class="line">        <span class="type">ChannelPromise</span> <span class="variable">promise</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultChannelPromise</span>(channel);</span><br><span class="line">        System.out.println(promise.isSuccess());</span><br><span class="line">        ctx.writeAndFlush(Unpooled.wrappedBuffer(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()), promise);</span><br><span class="line">        promise.sync();  <span class="comment">//åŒæ­¥ç­‰å¾…ä¸€ä¸‹</span></span><br><span class="line">        System.out.println(promise.isSuccess());</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>æœ€åç»“æœå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„äº†ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åƒFutureé‚£æ ·æ·»åŠ ç›‘å¬å™¨ï¼Œå½“æˆåŠŸæ—¶è‡ªåŠ¨é€šçŸ¥ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    Promise&lt;String&gt; promise = <span class="keyword">new</span> <span class="title class_">DefaultPromise</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">DefaultEventLoop</span>()); </span><br><span class="line">    promise.addListener(f -&gt; System.out.println(promise.get()));   <span class="comment">//æ³¨æ„æ˜¯åœ¨ä¸Šé¢çš„DefaultEventLoopæ‰§è¡Œçš„</span></span><br><span class="line">    System.out.println(promise.isSuccess());</span><br><span class="line">    promise.setSuccess(<span class="string">"lbwnb"</span>);</span><br><span class="line">    System.out.println(promise.isSuccess());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ‰å…³Futureå’ŒPromiseå°±æš‚æ—¶è®²è§£åˆ°è¿™é‡Œã€‚</p>
<h3 id="ç¼–ç å™¨å’Œè§£ç å™¨"><a href="#ç¼–ç å™¨å’Œè§£ç å™¨" class="headerlink" title="ç¼–ç å™¨å’Œè§£ç å™¨"></a>ç¼–ç å™¨å’Œè§£ç å™¨</h3><p>å‰é¢æˆ‘ä»¬å·²ç»äº†è§£äº†Nettyçš„å¤§éƒ¨åˆ†åŸºç¡€å†…å®¹ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹Nettyå†…ç½®çš„ä¸€äº›ç¼–ç å™¨å’Œè§£ç å™¨ã€‚</p>
<p>åœ¨å‰é¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬çš„æ•°æ®å‘é€å’Œæ¥æ”¶éƒ½æ˜¯éœ€è¦ä»¥ByteBufå½¢å¼ä¼ è¾“ï¼Œä½†æ˜¯è¿™æ ·æ˜¯ä¸æ˜¯æœ‰ç‚¹å¤ªä¸æ–¹ä¾¿äº†ï¼Œå’±ä»¬èƒ½ä¸èƒ½å‚è€ƒä¸€ä¸‹JavaWebé‚£ç§æä¸ªFilterï¼Œåœ¨æˆ‘ä»¬å¼€å§‹å¤„ç†æ•°æ®ä¹‹å‰ï¼Œè¿‡è¿‡æ»¤ä¸€æ¬¡ï¼Œå¹¶åœ¨è¿‡æ»¤çš„é€”ä¸­å°†æ•°æ®è½¬æ¢æˆæˆ‘ä»¬æƒ³è¦çš„ç±»å‹ï¼Œä¹Ÿå¯ä»¥å°†å‘å‡ºçš„æ•°æ®è¿›è¡Œè½¬æ¢ï¼Œè¿™å°±è¦ç”¨åˆ°ç¼–ç è§£ç å™¨äº†ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æœ€ç®€çš„ï¼Œå­—ç¬¦ä¸²ï¼Œå¦‚æœæˆ‘ä»¬è¦ç›´æ¥åœ¨å®¢æˆ·ç«¯æˆ–æ˜¯æœåŠ¡ç«¯å¤„ç†å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²è§£ç å™¨åˆ°æˆ‘ä»¬çš„æµæ°´çº¿ä¸­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">    channel.pipeline()</span><br><span class="line">            <span class="comment">//è§£ç å™¨æœ¬è´¨ä¸Šä¹Ÿç®—æ˜¯ä¸€ç§ChannelInboundHandlerAdapterï¼Œç”¨äºå¤„ç†å…¥ç«™è¯·æ±‚</span></span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())   <span class="comment">//å½“å®¢æˆ·ç«¯å‘é€æ¥çš„æ•°æ®åªæ˜¯ç®€å•çš„å­—ç¬¦ä¸²è½¬æ¢çš„ByteBufæ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å†…ç½®çš„StringDecoderå³å¯è½¬æ¢</span></span><br><span class="line">            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    <span class="comment">//ç»è¿‡StringDecoderè½¬æ¢åï¼Œmsgç›´æ¥å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æ‰“å°å°±è¡Œäº†</span></span><br><span class="line">                    System.out.println(msg);</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨èµ·æ¥è¿˜æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶æ·»åŠ åˆ°æµæ°´çº¿å³å¯ï¼Œå®é™…ä¸Šå™¨æœ¬è´¨å°±æ˜¯ä¸€ä¸ªChannelInboundHandlerAdapterï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24d0v15dkj21zs0k6ad5.jpg" alt="image-20220511123807650"></p>
<p>æˆ‘ä»¬çœ‹åˆ°å®ƒæ˜¯ç»§æ‰¿è‡ªMessageToMessageDecoderï¼Œç”¨äºå°†ä¼ å…¥çš„Messageè½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªè¡Œç¼–å†™ä¸€ä¸ªå®ç°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬ä¹Ÿæ¥æä¸€ä¸ªè‡ªå®šä¹‰çš„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestDecoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;ByteBuf&gt; {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext channelHandlerContext, ByteBuf buf, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"æ•°æ®å·²æ”¶åˆ°ï¼Œæ­£åœ¨è¿›è¡Œè§£ç ..."</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> buf.toString(StandardCharsets.UTF_8);  <span class="comment">//ç›´æ¥è½¬æ¢ä¸ºUTF8å­—ç¬¦ä¸²</span></span><br><span class="line">        list.add(text);   <span class="comment">//è§£ç åéœ€è¦å°†è§£æåçš„æ•°æ®ä¸¢è¿›Listä¸­ï¼Œå¦‚æœä¸¢è¿›å»å¤šä¸ªæ•°æ®ï¼Œç›¸å½“äºæ•°æ®è¢«åˆ†æˆäº†å¤šä¸ªï¼Œåé¢çš„Handlerå°±éœ€è¦æ¯ä¸ªéƒ½å¤„ç†ä¸€æ¬¡</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24db102gqj214o02qq2x.jpg" alt="image-20220511124755974"></p>
<p>å½“ç„¶å¦‚æœæˆ‘ä»¬åœ¨Listé‡Œé¢ä¸¢å¾ˆå¤šä¸ªæ•°æ®çš„è¯ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestDecoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;ByteBuf&gt; {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext channelHandlerContext, ByteBuf buf, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"æ•°æ®å·²æ”¶åˆ°ï¼Œæ­£åœ¨è¿›è¡Œè§£ç ..."</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> buf.toString(StandardCharsets.UTF_8);  <span class="comment">//ç›´æ¥è½¬æ¢ä¸ºUTF8å­—ç¬¦ä¸²</span></span><br><span class="line">        list.add(text);</span><br><span class="line">        list.add(text+<span class="string">"2"</span>);</span><br><span class="line">        list.add(text+<span class="string">'3'</span>);   <span class="comment">//ä¸€æ¡æ¶ˆæ¯è¢«è§£ç æˆä¸‰æ¡æ¶ˆæ¯</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24dcpcdxoj215e04eq2z.jpg" alt="image-20220511124933026"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåé¢çš„Handlerä¼šä¾æ¬¡å¯¹ä¸‰æ¡æ•°æ®éƒ½è¿›è¡Œå¤„ç†ï¼Œå½“ç„¶ï¼Œé™¤äº†MessageToMessageDecoderä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–ç±»å‹çš„è§£ç å™¨ï¼Œæ¯”å¦‚ByteToMessageDecoderç­‰ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼ŒNettyå†…ç½®äº†å¾ˆå¤šçš„è§£ç å™¨å®ç°æ¥æ–¹ä¾¿æˆ‘ä»¬å¼€å‘ï¼Œæ¯”å¦‚HTTPï¼ˆä¸‹ä¸€èŠ‚ä»‹ç»ï¼‰ï¼ŒSMTPã€MQTTç­‰ï¼Œä»¥åŠæˆ‘ä»¬å¸¸ç”¨çš„Redisã€Memcachedã€JSONç­‰æ•°æ®åŒ…ã€‚</p>
<p>å½“ç„¶ï¼Œæœ‰äº†è§£ç å™¨å¤„ç†å‘æ¥çš„æ•°æ®ï¼Œé‚£å‘å‡ºå»çš„æ•°æ®è‚¯å®šä¹Ÿæ˜¯éœ€è¦è¢«å¤„ç†çš„ï¼Œæ‰€ä»¥ç¼–ç å™¨å°±å‡ºç°äº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        <span class="comment">//è§£ç å™¨æœ¬è´¨ä¸Šä¹Ÿç®—æ˜¯ä¸€ç§ChannelInboundHandlerAdapterï¼Œç”¨äºå¤„ç†å…¥ç«™è¯·æ±‚</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="string">"æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼š"</span>+msg);</span><br><span class="line">                ctx.channel().writeAndFlush(<span class="string">"å¯ä»¥ï¼Œä¸è·Ÿä½ å¤šBB"</span>);  <span class="comment">//ç›´æ¥å‘å­—ç¬¦ä¸²å›å»</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());  <span class="comment">//ä½¿ç”¨å†…ç½®çš„StringEncoderå¯ä»¥ç›´æ¥å°†å‡ºç«™çš„å­—ç¬¦ä¸²æ•°æ®ç¼–ç æˆByteBuf</span></span><br></pre></td></tr></tbody></table></figure>

<p>å’Œä¸Šé¢çš„StringDecoderä¸€æ ·ï¼ŒStringEncoderæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªChannelOutboundHandlerAdapterï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24domthrqj21qe0i8mzp.jpg" alt="image-20220511130100984"></p>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰å‰é¢å­¦ä¹ çš„Handlerå’ŒPipelineçªç„¶å°±å˜å¾—æœ‰ç”¨äº†ï¼Œç›´æ¥ä¸€æ¡çº¿æŠŠæ•°æ®å¤„ç†å®‰æ’å¾—æ˜æ˜ç™½ç™½å•Šã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æŠŠå®¢æˆ·ç«¯ä¹Ÿæ”¹æˆä½¿ç”¨ç¼–ç ã€è§£ç å™¨çš„æ ·å­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">    bootstrap</span><br><span class="line">            .group(<span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>())</span><br><span class="line">            .channel(NioSocketChannel.class)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel channel)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                    channel.pipeline()</span><br><span class="line">                            .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())  <span class="comment">//è§£ç å™¨å®‰æ’</span></span><br><span class="line">                            .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                                    System.out.println(<span class="string">"&gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span> + msg);  <span class="comment">//ç›´æ¥æ¥æ”¶å­—ç¬¦ä¸²</span></span><br><span class="line">                                }</span><br><span class="line">                            })</span><br><span class="line">                            .addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());  <span class="comment">//ç¼–ç å™¨å®‰æ’</span></span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.connect(<span class="string">"localhost"</span>, <span class="number">8080</span>).channel();</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)){</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            System.out.println(<span class="string">"&lt;&lt; è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">            <span class="keyword">if</span>(text.isEmpty()) <span class="keyword">continue</span>;</span><br><span class="line">            channel.writeAndFlush(text);  <span class="comment">//ç›´æ¥å‘é€å­—ç¬¦ä¸²å°±è¡Œ</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·æˆ‘ä»¬çš„ä»£ç é‡åˆè¹­è¹­çš„å‡å°‘äº†å¾ˆå¤šï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24dtwy88pj214y04ojrv.jpg" alt="image-20220511130605337"></p>
<p>å½“ç„¶ï¼Œé™¤äº†ç¼–ç å™¨å’Œè§£ç å™¨ä¹‹å¤–ï¼Œè¿˜æœ‰ç¼–è§£ç å™¨ã€‚ï¼Ÿï¼Ÿç¼åˆæ€ªï¼Ÿï¼Ÿ</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24dxlf02nj21qu0fyn0h.jpg" alt="image-20220511130937624"></p>
<p>å¯ä»¥çœ‹åˆ°å®ƒæ˜¯æ—¢ç»§æ‰¿äº†ChannelInboundHandlerAdapterä¹Ÿå®ç°äº†ChannelOutboundHandleræ¥å£ï¼Œåˆèƒ½å¤„ç†å‡ºç«™ä¹Ÿèƒ½å¤„ç†å…¥ç«™è¯·æ±‚ï¼Œå®é™…ä¸Šå°±æ˜¯å°†ä¹‹å‰çš„ç»™ç»„åˆåˆ°ä¸€èµ·äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªç¼åˆåœ¨ä¸€èµ·çš„StringCodecç±»ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//éœ€è¦æŒ‡å®šä¸¤ä¸ªæ³›å‹ï¼Œç¬¬ä¸€ä¸ªæ˜¯å…¥ç«™çš„æ¶ˆæ¯ç±»å‹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å‡ºç«™çš„æ¶ˆæ¯ç±»å‹ï¼Œå‡ºç«™æ˜¯Stringç±»å‹ï¼Œæˆ‘ä»¬è¦è½¬æˆByteBuf</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringCodec</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageCodec</span>&lt;ByteBuf, String&gt; {</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, String buf, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"æ­£åœ¨å¤„ç†å‡ºç«™æ•°æ®..."</span>);</span><br><span class="line">        list.add(Unpooled.wrappedBuffer(buf.getBytes()));   <span class="comment">//åŒæ ·çš„ï¼Œæ·»åŠ çš„æ•°é‡å°±æ˜¯å‡ºç«™çš„æ¶ˆæ¯æ•°é‡</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext channelHandlerContext, ByteBuf buf, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"æ­£åœ¨å¤„ç†å…¥ç«™æ•°æ®..."</span>);</span><br><span class="line">        list.add(buf.toString(StandardCharsets.UTF_8));  <span class="comment">//å’Œä¹‹å‰ä¸€æ ·ï¼Œç›´æ¥ä¸€è¡Œè§£å†³</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°å®é™…ä¸Šå°±æ˜¯éœ€è¦æˆ‘ä»¬åŒæ—¶å»å®ç°ç¼–ç å’Œè§£ç æ–¹æ³•ï¼Œç»§æ‰¿MessageToMessageCodecç±»å³å¯ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæ•´æ¡æµæ°´çº¿ä¸Šæœ‰å¾ˆå¤šä¸ªè§£ç å™¨æˆ–æ˜¯ç¼–ç å™¨ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥å¤šæ¬¡è¿›è¡Œç¼–ç æˆ–æ˜¯è§£ç ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringToStringEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;String&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, String s, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"æˆ‘æ˜¯é¢„å¤„ç†ç¼–ç å™¨ï¼Œå°±è¦çš®è¿™ä¸€ä¸‹ã€‚"</span>);</span><br><span class="line">        list.add(<span class="string">"[å·²å¤„ç†] "</span>+s);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        <span class="comment">//è§£ç å™¨æœ¬è´¨ä¸Šä¹Ÿç®—æ˜¯ä¸€ç§ChannelInboundHandlerAdapterï¼Œç”¨äºå¤„ç†å…¥ç«™è¯·æ±‚</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="string">"æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼š"</span>+msg);</span><br><span class="line">                ctx.channel().writeAndFlush(<span class="string">"å¯ä»¥ï¼Œä¸è·Ÿä½ å¤šBB"</span>);  <span class="comment">//ç›´æ¥å‘å­—ç¬¦ä¸²å›å»</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>())    <span class="comment">//æœ€åå†è½¬æˆByteBuf</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringToStringEncoder</span>());  <span class="comment">//å…ˆä»æˆ‘ä»¬è‡ªå®šä¹‰çš„å¼€å§‹</span></span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®åœ¨æµæ°´çº¿ä¸Šä¸€å±‚ä¸€å±‚å¤„ç†æœ€åå†å›åˆ°çš„å®¢æˆ·ç«¯ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24ej8u6cqj219m04cq3f.jpg" alt="image-20220511133025492"></p>
<p>æˆ‘ä»¬åœ¨ä¸€å¼€å§‹æåˆ°çš„ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ä¸ªè§£ç å™¨è§£å†³ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">FixedLengthFrameDecoder</span>(<span class="number">10</span>))  </span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨å®šé•¿æ•°æ®åŒ…ï¼Œæ¯ä¸ªæ•°æ®åŒ…éƒ½è¦æ˜¯æŒ‡å®šé•¿åº¦</span></span><br><span class="line">  			...</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">DelimiterBasedFrameDecoder</span>(<span class="number">1024</span>, Unpooled.wrappedBuffer(<span class="string">"!"</span>.getBytes())))</span><br><span class="line">        <span class="comment">//ç¬¬äºŒç§ï¼Œå°±æ˜¯æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„åˆ†éš”ç¬¦ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œä»¥æ„Ÿå¹å·ä¸ºåˆ†éš”ç¬¦</span></span><br><span class="line">  			<span class="comment">//åœ¨æ”¶åˆ°åˆ†éš”ç¬¦ä¹‹å‰çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½ä½œä¸ºåŒä¸€ä¸ªæ•°æ®åŒ…çš„å†…å®¹</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">4</span>))</span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨å¤´éƒ¨æ·»åŠ é•¿åº¦ä¿¡æ¯ï¼Œæ¥ç¡®å®šå½“å‰å‘é€çš„æ•°æ®åŒ…å…·ä½“é•¿åº¦æ˜¯å¤šå°‘</span></span><br><span class="line">        <span class="comment">//offsetæ˜¯ä»å“ªé‡Œå¼€å§‹ï¼Œlengthæ˜¯é•¿åº¦ä¿¡æ¯å å¤šå°‘å­—èŠ‚ï¼Œè¿™é‡Œæ˜¯ä»0å¼€å§‹è¯»4ä¸ªå­—èŠ‚è¡¨ç¤ºæ•°æ®åŒ…é•¿åº¦</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="string">"&gt;&gt; æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼š"</span> + msg);</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldPrepender</span>(<span class="number">4</span>))   <span class="comment">//å®¢æˆ·ç«¯åœ¨å‘é€æ—¶ä¹Ÿéœ€è¦å°†é•¿åº¦æ‹¼åˆ°å‰é¢å»</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br></pre></td></tr></tbody></table></figure>

<p>æœ‰å…³ç¼–ç å™¨å’Œè§£ç å™¨çš„å†…å®¹å°±å…ˆä»‹ç»åˆ°è¿™é‡Œã€‚</p>
<h3 id="å®ç°HTTPåè®®é€šä¿¡"><a href="#å®ç°HTTPåè®®é€šä¿¡" class="headerlink" title="å®ç°HTTPåè®®é€šä¿¡"></a>å®ç°HTTPåè®®é€šä¿¡</h3><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†Nettyä¸ºæˆ‘ä»¬æä¾›çš„ç¼–ç å™¨å’Œè§£ç å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥ä½¿ç”¨ä¸€ä¸‹æ”¯æŒHTTPåè®®çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>())   <span class="comment">//Httpè¯·æ±‚è§£ç å™¨</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="string">"æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼š"</span>+msg.getClass());  <span class="comment">//çœ‹çœ‹æ˜¯ä¸ªå•¥ç±»å‹</span></span><br><span class="line">              	<span class="comment">//æ”¶åˆ°æµè§ˆå™¨è¯·æ±‚åï¼Œæˆ‘ä»¬éœ€è¦ç»™ä¸€ä¸ªå“åº”å›å»</span></span><br><span class="line">                <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);  <span class="comment">//HTTPç‰ˆæœ¬ä¸º1.1ï¼ŒçŠ¶æ€ç å°±OKï¼ˆ200ï¼‰å³å¯</span></span><br><span class="line">              	<span class="comment">//ç›´æ¥å‘å“åº”å†…å®¹ä¸­å†™å…¥æ•°æ®</span></span><br><span class="line">                response.content().writeCharSequence(<span class="string">"Hello World!"</span>, StandardCharsets.UTF_8);</span><br><span class="line">                ctx.channel().writeAndFlush(response);   <span class="comment">//å‘é€å“åº”</span></span><br><span class="line">                ctx.channel().close();   <span class="comment">//HTTPè¯·æ±‚æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œæ‰€ä»¥è®°å¾—å…³é—­</span></span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>());   <span class="comment">//å“åº”è®°å¾—ä¹Ÿè¦ç¼–ç åå‘é€å“¦</span></span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬ç”¨æµè§ˆå™¨è®¿é—®ä¸€ä¸‹æˆ‘ä»¬çš„æœåŠ¡å™¨å§ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24fzjztiyj22ac0k2gox.jpg" alt="image-20220511142040941"></p>
<p>å¯ä»¥çœ‹åˆ°æµè§ˆå™¨æˆåŠŸæ¥æ”¶åˆ°æœåŠ¡å™¨å“åº”ï¼Œç„¶åæ§åˆ¶å°æ‰“å°äº†ä»¥ä¸‹ç±»å‹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24g08odmrj21e604kmyh.jpg" alt="image-20220511142121619"></p>
<p>å¯ä»¥çœ‹åˆ°ä¸€æ¬¡è¯·æ±‚æ˜¯ä¸€ä¸ªDefaultHttpRequest+LastHttpContent$1ï¼Œè¿™é‡Œæœ‰ä¸¤ç»„æ˜¯å› ä¸ºæµè§ˆå™¨è¯·æ±‚äº†ä¸€ä¸ªåœ°å€ä¹‹åç´§æ¥ç€è¯·æ±‚äº†æˆ‘ä»¬ç½‘ç«™çš„faviconå›¾æ ‡ã€‚</p>
<p>è¿™æ ·æŠŠæ•°æ®åˆ†å¼€å¤„ç†è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œè¦æ˜¯ç›´æ¥æ•´åˆæˆä¸€ä¸ªå¤šå¥½ï¼Œå®‰æ’ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>())   <span class="comment">//Httpè¯·æ±‚è§£ç å™¨</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(Integer.MAX_VALUE))  <span class="comment">//æä¸€ä¸ªèšåˆå™¨ï¼Œå°†å†…å®¹èšåˆä¸ºä¸€ä¸ªFullHttpRequestï¼Œå‚æ•°æ˜¯æœ€å¤§å†…å®¹é•¿åº¦</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                <span class="type">FullHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> (FullHttpRequest) msg;</span><br><span class="line">                System.out.println(<span class="string">"æµè§ˆå™¨è¯·æ±‚è·¯å¾„ï¼š"</span>+request.uri());  <span class="comment">//ç›´æ¥è·å–è¯·æ±‚ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">                <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);</span><br><span class="line">                response.content().writeCharSequence(<span class="string">"Hello World!"</span>, StandardCharsets.UTF_8);</span><br><span class="line">                ctx.channel().writeAndFlush(response);</span><br><span class="line">                ctx.channel().close();</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>());</span><br></pre></td></tr></tbody></table></figure>

<p>å†æ¬¡è®¿é—®ï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥æ­£å¸¸è¯»å–è¯·æ±‚è·¯å¾„äº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24gcntjzbj210c02e74b.jpg" alt="image-20220511143318500"></p>
<p>æˆ‘ä»¬æ¥è¯•è¯•çœ‹æä¸ªé™æ€é¡µé¢ä»£ç†ç©ç©ï¼Œæ‹¿å‡ºæˆ‘ä»¬çš„é™ˆå¹´è€æ¨¡æ¿ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24gjzm12aj214i0k842b.jpg" alt="image-20220511144020424"></p>
<p>å…¨éƒ¨æ”¾è¿›Resourceæ–‡ä»¶å¤¹ï¼Œä¸€ä¼šæ ¹æ®æµè§ˆå™¨çš„è¯·æ±‚è·¯å¾„ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿”å›å¯¹åº”çš„é¡µé¢äº†ï¼Œå…ˆå®‰æ’ä¸€ä¸ªè§£æå™¨ï¼Œç”¨äºè§£æè·¯å¾„ç„¶åå°†é™æ€é¡µé¢çš„å†…å®¹è¿”å›ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResolver</span> {</span><br><span class="line">		<span class="comment">//ç›´æ¥å•ä¾‹æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">PageResolver</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageResolver</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">PageResolver</span><span class="params">()</span>{}</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PageResolver <span class="title function_">getInstance</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//è¯·æ±‚è·¯å¾„ç»™è¿›æ¥ï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦å°†é¡µé¢æ‹¿åˆ°ï¼Œç„¶åè½¬æ¢æˆå“åº”æ•°æ®åŒ…å‘å›å»</span></span><br><span class="line">    <span class="keyword">public</span> FullHttpResponse <span class="title function_">resolveResource</span><span class="params">(String path)</span>{</span><br><span class="line">        <span class="keyword">if</span>(path.startsWith(<span class="string">"/"</span>))  {  <span class="comment">//åˆ¤æ–­ä¸€ä¸‹æ˜¯ä¸æ˜¯æ­£å¸¸çš„è·¯å¾„è¯·æ±‚</span></span><br><span class="line">            path = path.equals(<span class="string">"/"</span>) ? <span class="string">"index.html"</span> : path.substring(<span class="number">1</span>);    <span class="comment">//å¦‚æœæ˜¯ç›´æ¥è¯·æ±‚æ ¹è·¯å¾„ï¼Œé‚£å°±é»˜è®¤è¿”å›indexé¡µé¢ï¼Œå¦åˆ™å°±è¯¥è¿”å›ä»€ä¹ˆè·¯å¾„çš„æ–‡ä»¶å°±è¿”å›ä»€ä¹ˆ</span></span><br><span class="line">            <span class="keyword">try</span>(<span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader().getResourceAsStream(path)) {</span><br><span class="line">                <span class="keyword">if</span>(stream != <span class="literal">null</span>) {   <span class="comment">//æ‹¿åˆ°æ–‡ä»¶è¾“å…¥æµä¹‹åï¼Œæ‰å¯ä»¥è¿”å›é¡µé¢</span></span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[stream.available()];</span><br><span class="line">                    stream.read(bytes);</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.packet(HttpResponseStatus.OK, bytes);  <span class="comment">//æ•°æ®å…ˆè¯»å‡ºæ¥ï¼Œç„¶åäº¤ç»™ä¸‹é¢çš„æ–¹æ³•æ‰“åŒ…</span></span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e){</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">      	<span class="comment">//å…¶ä»–æƒ…å†µä¸€å¾‹è¿”å›404</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.packet(HttpResponseStatus.NOT_FOUND, <span class="string">"404 Not Found!"</span>.getBytes());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//åŒ…è£…æˆFullHttpResponseï¼ŒæŠŠçŠ¶æ€ç å’Œæ•°æ®å†™è¿›å»</span></span><br><span class="line">    <span class="keyword">private</span> FullHttpResponse <span class="title function_">packet</span><span class="params">(HttpResponseStatus status, <span class="type">byte</span>[] data)</span>{</span><br><span class="line">        <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, status);</span><br><span class="line">        response.content().writeBytes(data);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬çš„é™æ€èµ„æºè§£æå°±å†™å¥½äº†ï¼Œæ¥ç€ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>())   <span class="comment">//Httpè¯·æ±‚è§£ç å™¨</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(Integer.MAX_VALUE))  <span class="comment">//æä¸€ä¸ªèšåˆå™¨ï¼Œå°†å†…å®¹èšåˆä¸ºä¸€ä¸ªFullHttpRequestï¼Œå‚æ•°æ˜¯æœ€å¤§å†…å®¹é•¿åº¦</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                <span class="type">FullHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> (FullHttpRequest) msg;</span><br><span class="line">              	<span class="comment">//è¯·æ±‚è¿›æ¥äº†ç›´æ¥èµ°è§£æ</span></span><br><span class="line">                <span class="type">PageResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> PageResolver.getInstance();</span><br><span class="line">                ctx.channel().writeAndFlush(resolver.resolveResource(request.uri()));</span><br><span class="line">                ctx.channel().close();</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpResponseEncoder</span>());</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬å¯åŠ¨æœåŠ¡å™¨æ¥è¯•è¯•çœ‹å§ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24hbzfrozj21dy0u0jw2.jpg" alt="image-20220511150714100"></p>
<p>å¯ä»¥çœ‹åˆ°é¡µé¢å¯ä»¥æ­£å¸¸å±•ç¤ºäº†ï¼Œæ˜¯ä¸æ˜¯æœ‰Tomcatå“ªå‘³äº†ã€‚</p>
<h3 id="å…¶ä»–å†…ç½®Handlerä»‹ç»"><a href="#å…¶ä»–å†…ç½®Handlerä»‹ç»" class="headerlink" title="å…¶ä»–å†…ç½®Handlerä»‹ç»"></a>å…¶ä»–å†…ç½®Handlerä»‹ç»</h3><p>Nettyä¹Ÿä¸ºæˆ‘ä»¬å†…ç½®äº†ä¸€äº›å…¶ä»–æ¯”è¾ƒå¥½ç”¨çš„Handlerï¼Œæ¯”å¦‚æˆ‘ä»¬è¦æ‰“å°æ—¥å¿—ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>())</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(Integer.MAX_VALUE))</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))   <span class="comment">//æ·»åŠ ä¸€ä¸ªæ—¥å¿—Handlerï¼Œåœ¨è¯·æ±‚åˆ°æ¥æ—¶ä¼šè‡ªåŠ¨æ‰“å°ç›¸å…³æ—¥å¿—</span></span><br><span class="line">        ...</span><br></pre></td></tr></tbody></table></figure>

<p>æ—¥å¿—çº§åˆ«æˆ‘ä»¬é€‰æ‹©INFOï¼Œç°åœ¨æˆ‘ä»¬ç”¨æµè§ˆå™¨è®¿é—®ä¸€ä¸‹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25j8p1xc2j22ig0sutk2.jpg" alt="image-20220512125851248"></p>
<p>å¯ä»¥çœ‹åˆ°æ¯æ¬¡è¯·æ±‚çš„å†…å®¹å’Œè¯¦ç»†ä¿¡æ¯éƒ½ä¼šåœ¨æ—¥å¿—ä¸­å‡ºç°ï¼ŒåŒ…æ‹¬è¯¦ç»†çš„æ•°æ®åŒ…è§£æè¿‡ç¨‹ï¼Œè¯·æ±‚å¤´ä¿¡æ¯éƒ½æ˜¯å®Œæ•´åœ°æ‰“å°åœ¨æ§åˆ¶å°ä¸Šçš„ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨Handlerå¯¹IPåœ°å€è¿›è¡Œè¿‡æ»¤ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸å¸Œæœ›æŸäº›IPåœ°å€è¿æ¥æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpRequestDecoder</span>())</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(Integer.MAX_VALUE))</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">RuleBasedIpFilter</span>(<span class="keyword">new</span> <span class="title class_">IpFilterRule</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(InetSocketAddress inetSocketAddress)</span> {</span><br><span class="line">                <span class="keyword">return</span> !inetSocketAddress.getHostName().equals(<span class="string">"127.0.0.1"</span>);  </span><br><span class="line">              	<span class="comment">//è¿›è¡ŒåŒ¹é…ï¼Œè¿”å›falseè¡¨ç¤ºåŒ¹é…å¤±è´¥</span></span><br><span class="line">              	<span class="comment">//å¦‚æœåŒ¹é…å¤±è´¥ï¼Œé‚£ä¹ˆä¼šæ ¹æ®ä¸‹é¢çš„ç±»å‹å†³å®šè¯¥å¹²ä»€ä¹ˆï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œåˆ¤æ–­æ˜¯ä¸æ˜¯æœ¬åœ°è®¿é—®çš„ï¼Œå¦‚æœæ˜¯é‚£å°±æ‹’ç»</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> IpFilterRuleType <span class="title function_">ruleType</span><span class="params">()</span> {</span><br><span class="line">                <span class="keyword">return</span> IpFilterRuleType.REJECT;   <span class="comment">//ç±»å‹ï¼ŒREJECTè¡¨ç¤ºæ‹’ç»è¿æ¥ï¼ŒACCEPTè¡¨ç¤ºå…è®¸è¿æ¥</span></span><br><span class="line">            }</span><br><span class="line">        }))</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬æµè§ˆå™¨è®¿é—®ä¸€ä¸‹çœ‹çœ‹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25jjq53pvj21r40m8abh.jpg" alt="image-20220512130926968"></p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹é‚£äº›é•¿æœŸå¤„äºç©ºé—²çš„è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeline()</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringDecoder</span>())</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">0</span>))  <span class="comment">//IdleStateHandlerèƒ½å¤Ÿä¾¦æµ‹è¿æ¥ç©ºé—²çŠ¶æ€</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºè¿æ¥å¤šå°‘ç§’æ²¡æœ‰è¯»æ“ä½œæ—¶è§¦å‘äº‹ä»¶ï¼Œç¬¬äºŒä¸ªæ˜¯å†™æ“ä½œï¼Œç¬¬ä¸‰ä¸ªæ˜¯è¯»å†™æ“ä½œéƒ½ç®—ï¼Œ0è¡¨ç¤ºç¦ç”¨</span></span><br><span class="line">        <span class="comment">//äº‹ä»¶éœ€è¦åœ¨ChannelInboundHandlerAdapterä¸­è¿›è¡Œç›‘å¬å¤„ç†</span></span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">ChannelInboundHandlerAdapter</span>(){</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                System.out.println(<span class="string">"æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>+msg);</span><br><span class="line">                ctx.channel().writeAndFlush(<span class="string">"å·²æ”¶åˆ°ï¼"</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                <span class="comment">//æ²¡æƒ³åˆ°å§ï¼Œè¿™ä¸ªæ–¹æ³•åŸæ¥æ˜¯åœ¨è¿™ä¸ªæ—¶å€™ç”¨çš„</span></span><br><span class="line">                <span class="keyword">if</span>(evt <span class="keyword">instanceof</span> IdleStateEvent) {</span><br><span class="line">                    <span class="type">IdleStateEvent</span> <span class="variable">event</span> <span class="operator">=</span> (IdleStateEvent) evt;</span><br><span class="line">                    <span class="keyword">if</span>(event.state() == IdleState.WRITER_IDLE) {</span><br><span class="line">                        System.out.println(<span class="string">"å¥½ä¹…éƒ½æ²¡å†™äº†ï¼Œçœ‹è§†é¢‘çš„ä½ çœŸçš„æœ‰è®¤çœŸåœ¨è·Ÿç€æ•²å—"</span>);</span><br><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span>(event.state() == IdleState.READER_IDLE) {</span><br><span class="line">                        System.out.println(<span class="string">"å·²ç»å¾ˆä¹…å¾ˆä¹…æ²¡æœ‰è¯»äº‹ä»¶å‘ç”Ÿäº†ï¼Œå¥½å¯‚å¯"</span>);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">        .addLast(<span class="keyword">new</span> <span class="title class_">StringEncoder</span>());</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è¶…è¿‡ä¸€æ®µæ—¶é—´ä¸å‘é€æ•°æ®æ—¶ï¼Œå°±ä¼šè¿™æ ·ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h25jteal4rj21eo07qabh.jpg" alt="image-20220512131845296"></p>
<p>é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å…³æ‰é‚£äº›å ç€èŒ…å‘ä¸æ‹‰å±çš„è¿æ¥ã€‚</p>
<h3 id="å¯åŠ¨æµç¨‹æºç è§£è¯»"><a href="#å¯åŠ¨æµç¨‹æºç è§£è¯»" class="headerlink" title="å¯åŠ¨æµç¨‹æºç è§£è¯»"></a>å¯åŠ¨æµç¨‹æºç è§£è¯»</h3><p>å‰é¢æˆ‘ä»¬å®Œæˆäº†å¯¹NettyåŸºæœ¬åŠŸèƒ½çš„è®²è§£ï¼Œæˆ‘ä»¬æœ€åå°±æ¥çœ‹ä¸€ä¸‹ï¼ŒNettyåˆ°åº•æ˜¯å¦‚ä½•å¯åŠ¨ä»¥åŠè¿›è¡Œæ•°æ®å¤„ç†çš„ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼Œæ•´ä¸ªæœåŠ¡ç«¯æ˜¯åœ¨bindä¹‹åå¯åŠ¨çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»è¿™é‡Œå¼€å§‹ä¸‹æ‰‹ï¼Œä¸å¤šBBç›´æ¥ä¸Šæºç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">bind</span><span class="params">(<span class="type">int</span> inetPort)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(inetPort));   <span class="comment">//è½¬æ¢æˆInetSocketAddresså¯¹è±¡</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿›æ¥ä¹‹åå‘ç°æ˜¯è°ƒç”¨çš„å…¶ä»–ç»‘å®šæ–¹æ³•ï¼Œç»§ç»­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">bind</span><span class="params">(SocketAddress localAddress)</span> {</span><br><span class="line">    <span class="built_in">this</span>.validate();   <span class="comment">//å†æ¬¡éªŒè¯ä¸€ä¸‹ï¼Œçœ‹çœ‹EventLoopGroupå’ŒChannelæŒ‡å®šäº†æ²¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.doBind((SocketAddress)ObjectUtil.checkNotNull(localAddress, <span class="string">"localAddress"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChannelFuture <span class="title function_">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> <span class="built_in">this</span>.initAndRegister();   <span class="comment">//ä¸Šæ¥ç¬¬ä¸€å¥åˆå§‹åŒ–ç„¶åæ³¨å†Œ</span></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬çœ‹çœ‹æ˜¯æ€ä¹ˆæ³¨å†Œçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ChannelFuture <span class="title function_">initAndRegister</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        channel = <span class="built_in">this</span>.channelFactory.newChannel();    <span class="comment">//é€šè¿‡channelFactoryåˆ›å»ºæ–°çš„Channelï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨ä¸€å¼€å§‹è®¾å®šçš„NioServerSocketChannel</span></span><br><span class="line">        <span class="built_in">this</span>.init(channel);    <span class="comment">//æ¥ç€å¯¹åˆ›å»ºå¥½çš„NioServerSocketChannelè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> <span class="built_in">this</span>.config().group().register(channel); <span class="comment">//å°†é€šé“æ³¨å†Œåˆ°bossGroupä¸­çš„ä¸€ä¸ªEventLoopä¸­</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> regFuture;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯å¦‚ä½•å¯¹åˆ›å»ºå¥½çš„ServerSocketChannelè¿›è¡Œåˆå§‹åŒ–çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Channel channel)</span> {</span><br><span class="line">    setChannelOptions(channel, <span class="built_in">this</span>.newOptionsArray(), logger);</span><br><span class="line">    setAttributes(channel, <span class="built_in">this</span>.newAttributesArray());</span><br><span class="line">    <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> channel.pipeline();</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åœ¨æµæ°´çº¿ä¸Šæ·»åŠ ä¸€ä¸ªHandlerï¼Œåœ¨Handleråˆå§‹åŒ–çš„æ—¶å€™å‘EventLoopä¸­æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå°†ServerBootstrapAcceptoræ·»åŠ åˆ°æµæ°´çº¿ä¸Š</span></span><br><span class="line">    <span class="comment">//è¿™æ ·æˆ‘ä»¬çš„ServerSocketChannelåœ¨å®¢æˆ·ç«¯è¿æ¥æ—¶å°±èƒ½Acceptäº†</span></span><br><span class="line">    p.addLast(<span class="keyword">new</span> <span class="title class_">ChannelHandler</span>[]{<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() {</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(<span class="keyword">final</span> Channel ch)</span> {</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">            <span class="type">ChannelHandler</span> <span class="variable">handler</span> <span class="operator">=</span> ServerBootstrap.<span class="built_in">this</span>.config.handler();</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="literal">null</span>) {</span><br><span class="line">                pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ChannelHandler</span>[]{handler});</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            ch.eventLoop().execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                  	<span class="comment">//è¿™é‡Œæäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå°†ServerBootstrapAcceptoræ·»åŠ åˆ°ServerSocketChannelçš„pipelineä¸­</span></span><br><span class="line">                    pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ChannelHandler</span>[]{<span class="keyword">new</span> <span class="title class_">ServerBootstrapAcceptor</span>(ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs)});</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">    }});</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼ŒServerBootstrapAcceptoræ€ä¹ˆå¤„ç†çš„ï¼Œç›´æ¥çœ‹åˆ°å®ƒçš„<code>channelRead</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“åº•å±‚NIOçš„ServerSocketChannelçš„Selectoræœ‰OP_ACCEPTäº‹ä»¶åˆ°è¾¾æ—¶ï¼ŒNioEventLoopä¼šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ›å»ºSocketChannelï¼Œå¹¶è§¦å‘channelReadå›è°ƒ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> {</span><br><span class="line">  	<span class="comment">//æ­¤æ—¶msgå°±æ˜¯Acceptè¿æ¥åˆ›å»ºä¹‹åçš„Channelå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">child</span> <span class="operator">=</span> (Channel)msg;</span><br><span class="line">  	<span class="comment">//è¿™é‡Œç›´æ¥å°†æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„childHandleræ·»åŠ åˆ°æ–°åˆ›å»ºçš„å®¢æˆ·ç«¯è¿æ¥çš„æµæ°´çº¿ä¸­ï¼ˆæ˜¯ä¸æ˜¯æ„Ÿè§‰çªç„¶å°±é€šäº†ï¼‰</span></span><br><span class="line">    child.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">ChannelHandler</span>[]{<span class="built_in">this</span>.childHandler});</span><br><span class="line">    AbstractBootstrap.setChannelOptions(child, <span class="built_in">this</span>.childOptions, ServerBootstrap.logger);</span><br><span class="line">    AbstractBootstrap.setAttributes(child, <span class="built_in">this</span>.childAttrs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      	<span class="comment">//ç›´æ¥å‘workGroupä¸­çš„ä¸€ä¸ªEventLoopæ³¨å†Œæ–°åˆ›å»ºå¥½çš„å®¢æˆ·ç«¯è¿æ¥Channelï¼Œç­‰å¾…è¯»å†™äº‹ä»¶</span></span><br><span class="line">        <span class="built_in">this</span>.childGroup.register(child).addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() {</span><br><span class="line">          	<span class="comment">//å¼‚æ­¥æ“ä½œå®Œæˆåï¼Œå¦‚æœæ²¡æœ‰æ³¨å†ŒæˆåŠŸï¼Œå°±å¼ºåˆ¶å…³é—­è¿™ä¸ªChannel</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                <span class="keyword">if</span> (!future.isSuccess()) {</span><br><span class="line">                    ServerBootstrap.ServerBootstrapAcceptor.forceClose(child, future.cause());</span><br><span class="line">                	...</span><br></pre></td></tr></tbody></table></figure>

<p>æ‰€ä»¥ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¹‹å‰è®²è§£çš„ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹ï¼Œåªè¦å‰é¢ç†è§£äº†ï¼Œè¿™é‡Œå…¶å®å¾ˆå¥½æ¨æ–­ã€‚</p>
<p>åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ³¨å†Œï¼Œåœ¨ä¹‹å‰NIOé˜¶æ®µæˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦å°†Channelæ³¨å†Œåˆ°å¯¹åº”çš„Selectoræ‰å¯ä»¥å¼€å§‹é€‰æ‹©ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">register</span><span class="params">(Channel channel)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.register((ChannelPromise)(<span class="keyword">new</span> <span class="title class_">DefaultChannelPromise</span>(channel, <span class="built_in">this</span>)));  <span class="comment">//è½¬æ¢æˆChannelPromiseç»§ç»­</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ChannelFuture <span class="title function_">register</span><span class="params">(ChannelPromise promise)</span> {</span><br><span class="line">    ObjectUtil.checkNotNull(promise, <span class="string">"promise"</span>);</span><br><span class="line">    promise.channel().unsafe().register(<span class="built_in">this</span>, promise);   <span class="comment">//è°ƒç”¨Channelçš„Unsafeæ¥å£å®ç°è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç»§ç»­å‘ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> {</span><br><span class="line">    ...</span><br><span class="line">        AbstractChannel.<span class="built_in">this</span>.eventLoop = eventLoop;</span><br><span class="line">        <span class="keyword">if</span> (eventLoop.inEventLoop()) {</span><br><span class="line">            <span class="built_in">this</span>.register0(promise);    <span class="comment">//è¿™é‡Œæ˜¯ç»§ç»­è°ƒç”¨register0æ–¹æ³•åœ¨è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">        }</span><br><span class="line">  	...</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç»§ç»­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register0</span><span class="params">(ChannelPromise promise)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">firstRegistration</span> <span class="operator">=</span> <span class="built_in">this</span>.neverRegistered;</span><br><span class="line">        AbstractChannel.<span class="built_in">this</span>.doRegister();    <span class="comment">//è¿™é‡Œå¼€å§‹æ‰§è¡ŒAbstractNioChannelä¸­çš„doRegisteræ–¹æ³•è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">      	AbstractChannel.<span class="built_in">this</span>.registered = <span class="literal">true</span>;</span><br><span class="line">        AbstractChannel.<span class="built_in">this</span>.pipeline.invokeHandlerAddedIfNeeded();</span><br><span class="line">        <span class="built_in">this</span>.safeSetSuccess(promise);</span><br><span class="line">      	<span class="keyword">if</span> (AbstractChannel.<span class="built_in">this</span>.isActive()) {</span><br><span class="line">            <span class="keyword">if</span> (firstRegistration) {</span><br><span class="line">                AbstractChannel.<span class="built_in">this</span>.pipeline.fireChannelActive();   <span class="comment">//è¿™é‡Œæ˜¯å…³é”®</span></span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (AbstractChannel.<span class="built_in">this</span>.config().isAutoRead()) {</span><br><span class="line">                <span class="built_in">this</span>.beginRead();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥åˆ°æœ€åä¸€çº§ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">selected</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">          	<span class="comment">//å¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œç»ˆäºæ˜¯çœŸæ­£çš„è¿›è¡Œäº†æ³¨å†Œï¼ŒjavaChannel()å¾—åˆ°NIOçš„Channelå¯¹è±¡ï¼Œç„¶åè°ƒç”¨registeræ–¹æ³•</span></span><br><span class="line">          	<span class="comment">//è¿™é‡Œå°±å’Œæˆ‘ä»¬ä¹‹å‰NIOä¸€æ ·äº†ï¼Œå°†Channelæ³¨å†Œåˆ°Selectorä¸­ï¼Œå¯ä»¥çœ‹åˆ°Selectorä¹Ÿæ˜¯EventLoopä¸­çš„</span></span><br><span class="line">          	<span class="comment">//ä½†æ˜¯æ³¨æ„ï¼Œè¿™é‡Œçš„opså‚æ•°æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ä¸ç›‘å¬ä»»ä½•äº‹ä»¶</span></span><br><span class="line">            <span class="built_in">this</span>.selectionKey = <span class="built_in">this</span>.javaChannel().register(<span class="built_in">this</span>.eventLoop().unwrappedSelector(), <span class="number">0</span>, <span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        ...</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å›åˆ°ä¸Šä¸€çº§ï¼Œåœ¨doRegisterå®Œæˆä¹‹åï¼Œä¼šæ‹¿åˆ°selectionKeyï¼Œä½†æ˜¯æ³¨æ„è¿™æ—¶è¿˜æ²¡æœ‰ç›‘å¬ä»»ä½•äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥ç€çœ‹åˆ°ä¸‹é¢çš„fireChannelActiveæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title function_">fireChannelActive</span><span class="params">()</span> {</span><br><span class="line">    AbstractChannelHandlerContext.invokeChannelActive(<span class="built_in">this</span>.head);   <span class="comment">//ä¼ çš„æ˜¯æµæ°´çº¿ä¸Šçš„é»˜è®¤å¤´ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeChannelActive</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next)</span> {</span><br><span class="line">    <span class="type">EventExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> next.executor();</span><br><span class="line">    <span class="keyword">if</span> (executor.inEventLoop()) {</span><br><span class="line">        next.invokeChannelActive();   <span class="comment">//ç»§ç»­å‘ä¸‹</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                next.invokeChannelActive();</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokeChannelActive</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.invokeHandler()) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            ((ChannelInboundHandler)<span class="built_in">this</span>.handler()).channelActive(<span class="built_in">this</span>);   <span class="comment">//ä¾ç„¶æ˜¯è°ƒç”¨çš„å¤´ç»“ç‚¹çš„channelActiveæ–¹æ³•è¿›è¡Œå¤„ç†</span></span><br><span class="line">        } <span class="keyword">catch</span> (Throwable var2) {</span><br><span class="line">            <span class="built_in">this</span>.invokeExceptionCaught(var2);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="built_in">this</span>.fireChannelActive();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> {   <span class="comment">//è¿™é‡Œæ˜¯å¤´ç»“ç‚¹çš„</span></span><br><span class="line">    ctx.fireChannelActive();    </span><br><span class="line">    <span class="built_in">this</span>.readIfIsAutoRead();   <span class="comment">//ç»§ç»­å‘ä¸‹</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readIfIsAutoRead</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">if</span> (DefaultChannelPipeline.<span class="built_in">this</span>.channel.config().isAutoRead()) {</span><br><span class="line">        DefaultChannelPipeline.<span class="built_in">this</span>.channel.read();    <span class="comment">//ç»§ç»­ä¸æ–­å‘ä¸‹</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">(ChannelHandlerContext ctx)</span> {</span><br><span class="line">    <span class="built_in">this</span>.unsafe.beginRead();   <span class="comment">//æœ€åè¿™é‡Œä¼šè°ƒç”¨beginReadæ–¹æ³•</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">beginRead</span><span class="params">()</span> {</span><br><span class="line">    <span class="built_in">this</span>.assertEventLoop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        AbstractChannel.<span class="built_in">this</span>.doBeginRead();    <span class="comment">//è¿™é‡Œå°±æ˜¯è°ƒç”¨AbstractNioChannelçš„doBeginReadæ–¹æ³•äº†</span></span><br><span class="line">    } <span class="keyword">catch</span> (<span class="keyword">final</span> Exception var2) {</span><br><span class="line">        <span class="built_in">this</span>.invokeLater(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                AbstractChannel.<span class="built_in">this</span>.pipeline.fireExceptionCaught(var2);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        <span class="built_in">this</span>.close(<span class="built_in">this</span>.voidPromise());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="type">SelectionKey</span> <span class="variable">selectionKey</span> <span class="operator">=</span> <span class="built_in">this</span>.selectionKey;    <span class="comment">//å…ˆæ‹¿åˆ°ä¹‹å‰æ³¨å†Œå¥½çš„selectionKey</span></span><br><span class="line">    <span class="keyword">if</span> (selectionKey.isValid()) {</span><br><span class="line">        <span class="built_in">this</span>.readPending = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">interestOps</span> <span class="operator">=</span> selectionKey.interestOps();   <span class="comment">//æŠŠç›‘å¬çš„æ“ä½œå–å‡ºæ¥</span></span><br><span class="line">        <span class="keyword">if</span> ((interestOps &amp; <span class="built_in">this</span>.readInterestOp) == <span class="number">0</span>) {    <span class="comment">//å¦‚æœæ²¡æœ‰ç›‘å¬ä»»ä½•æ“ä½œ</span></span><br><span class="line">            selectionKey.interestOps(interestOps | <span class="built_in">this</span>.readInterestOp);   <span class="comment">//é‚£å°±æŠŠreadInterestOpäº‹ä»¶è¿›è¡Œç›‘å¬ï¼Œè¿™é‡Œçš„readInterestOpå®é™…ä¸Šå°±æ˜¯OP_ACCEPT</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·ï¼ŒChannelåœ¨åˆå§‹åŒ–å®Œæˆä¹‹åä¹Ÿå®Œæˆäº†åº•å±‚çš„æ³¨å†Œï¼Œå·²ç»å¯ä»¥å¼€å§‹ç­‰å¾…äº‹ä»¶äº†ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å›åˆ°ä¹‹å‰çš„<code>doBind</code>æ–¹æ³•çš„æ³¨å†Œä½ç½®ï¼Œç°åœ¨æ³¨å†Œå®Œæˆä¹‹åï¼ŒåŸºæœ¬ä¸Šæ•´ä¸ªä¸»ä»Reactorç»“æ„å°±å·²ç»å‡ºæ¥äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿˜è¦åšäº›ä»€ä¹ˆï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ChannelFuture <span class="title function_">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">regFuture</span> <span class="operator">=</span> <span class="built_in">this</span>.initAndRegister();  <span class="comment">//ç›®å‰åˆå§‹åŒ–å’Œæ³¨å†Œéƒ½å·²ç»æˆåŠŸäº†</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> regFuture.channel();    <span class="comment">//ç”±äºæ˜¯å¼‚æ­¥æ“ä½œï¼Œæˆ‘ä»¬é€šè¿‡ChannelFutureæ‹¿åˆ°å¯¹åº”çš„ServerSocketChannelå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> regFuture;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (regFuture.isDone()) {   <span class="comment">//å¦‚æœè¯´åˆå§‹åŒ–å·²ç»å®Œæˆäº†</span></span><br><span class="line">        <span class="type">ChannelPromise</span> <span class="variable">promise</span> <span class="operator">=</span> channel.newPromise();</span><br><span class="line">        doBind0(regFuture, channel, localAddress, promise);   <span class="comment">//ç›´æ¥å¼€å§‹è¿›è¡Œè¿›ä¸€æ­¥çš„ç»‘å®š</span></span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      	<span class="comment">//å¦‚æœè¿˜æ²¡æå®Œï¼Œé‚£å°±åˆ›Promisç»§ç»­ç­‰å¾…ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PendingRegistrationPromise</span> <span class="variable">promise</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PendingRegistrationPromise</span>(channel);</span><br><span class="line">        regFuture.addListener(<span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() {</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> future.cause();</span><br><span class="line">                <span class="keyword">if</span> (cause != <span class="literal">null</span>) {</span><br><span class="line">                    promise.setFailure(cause);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    promise.registered();</span><br><span class="line">                    AbstractBootstrap.doBind0(regFuture, channel, localAddress, promise);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> promise;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ€åéƒ½ä¼šèµ°åˆ°<code>doBind0</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doBind0</span><span class="params">(<span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> {</span><br><span class="line">  	<span class="comment">//æœ€åä¼šå‘Channelå·²ç»æ³¨å†Œåˆ°çš„EventLoopä¸­æäº¤ä¸€ä¸ªæ–°çš„ä»»åŠ¡</span></span><br><span class="line">    channel.eventLoop().execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">if</span> (regFuture.isSuccess()) {</span><br><span class="line">              	<span class="comment">//è¿™é‡Œæ‰æ˜¯çœŸæ­£è°ƒç”¨Channelåº•å±‚è¿›è¡Œç»‘å®šæ“ä½œ</span></span><br><span class="line">                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                promise.setFailure(regFuture.cause());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è‡³æ­¤ï¼ŒæœåŠ¡ç«¯çš„å¯åŠ¨æµç¨‹ç»“æŸã€‚æˆ‘ä»¬å‰é¢è¿˜æåˆ°äº†NIOçš„ç©ºè½®è¯¢é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥çœ‹çœ‹Nettyæ˜¯å¦‚ä½•è§£å†³çš„ï¼Œæˆ‘ä»¬ç›´æ¥å®šä½åˆ°NioEventLoopä¸­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”±äºä»£ç å¤ªå¤šï¼Œè¿™é‡Œçœç•¥å¤§éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) {</span><br><span class="line">    <span class="type">boolean</span> var34;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        	...</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="keyword">if</span> (!<span class="built_in">this</span>.hasTasks()) {</span><br><span class="line">                                strategy = <span class="built_in">this</span>.select(curDeadlineNanos);   <span class="comment">//é¦–å…ˆä¼šåœ¨è¿™é‡Œè¿›è¡ŒSelector.select()æ“ä½œï¼Œè·ŸNIOæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">                            }</span><br><span class="line">           ...</span><br><span class="line"></span><br><span class="line">            ++selectCnt;    <span class="comment">//æ¯æ¬¡å”¤é†’éƒ½ä¼šè®©selectCntè‡ªå¢</span></span><br><span class="line">            <span class="built_in">this</span>.cancelledKeys = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">          	...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!ranTasks &amp;&amp; strategy &lt;= <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.unexpectedSelectorWakeup(selectCnt)) {   <span class="comment">//è¿™é‡Œä¼šè¿›è¡Œåˆ¤æ–­æ˜¯å¦å‡ºç°ç©ºè½®è¯¢BUG</span></span><br><span class="line">           	...</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆè¿›è¡Œåˆ¤æ–­çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">unexpectedSelectorWakeup</span><span class="params">(<span class="type">int</span> selectCnt)</span> {</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted()) {</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">            logger.debug(<span class="string">"Selector.select() returned prematurely because Thread.currentThread().interrupt() was called. Use NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop."</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœselectCntå¤§äºç­‰äºSELECTOR_AUTO_REBUILD_THRESHOLDï¼ˆé»˜è®¤ä¸º512ï¼‰é‚£ä¹ˆä¼šç›´æ¥é‡å»ºSelector</span></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; <span class="number">0</span> &amp;&amp; selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) {</span><br><span class="line">        logger.warn(<span class="string">"Selector.select() returned prematurely {} times in a row; rebuilding Selector {}."</span>, selectCnt, <span class="built_in">this</span>.selector);</span><br><span class="line">        <span class="built_in">this</span>.rebuildSelector();   <span class="comment">//å½“å‰çš„Selectorå‡ºç°BUGäº†ï¼Œå¾—é‡å»ºä¸€ä¸ªSelector</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å®é™…ä¸Šï¼Œå½“æ¯æ¬¡ç©ºè½®è¯¢å‘ç”Ÿæ—¶ä¼šæœ‰ä¸“é—¨çš„è®¡æ•°å™¨+1ï¼Œå¦‚æœç©ºè½®è¯¢çš„æ¬¡æ•°è¶…è¿‡äº†512æ¬¡ï¼Œå°±è®¤ä¸ºå…¶è§¦å‘äº†ç©ºè½®è¯¢bugï¼Œè§¦å‘bugåï¼ŒNettyç›´æ¥é‡å»ºä¸€ä¸ªSelectorï¼Œå°†åŸæ¥çš„Channelé‡æ–°æ³¨å†Œåˆ°æ–°çš„ Selectorä¸Šï¼Œå°†æ—§çš„ Selectorå…³æ‰ï¼Œè¿™æ ·å°±é˜²æ­¢äº†æ— é™å¾ªç¯ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h></h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://alanyaeer.fun/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/">http://alanyaeer.fun/2024/03/17/Java NIOç¬”è®°ï¼ˆäºŒï¼‰/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>è€¶æ ¼å°”</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2024-03-17</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2024-04-19</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/04/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•"><img class="cover" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202406042201773.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">è€¶æ ¼å°”</div><div class="author-info__description">TTK</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Alanyaeer"><i class="fab fa-github"></i><span>Follow Me<i class="faa-passing animated" style="padding-left:20px;display:inline-block;vertical-align:middle;"><svg class="icon" style="height:28px;width:28px;fill:currentColor;position:relative;top:5px"><use xlink:href="#icon-xiaoqiche"></use></svg></i></span></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="/assets/QRCode.jpg" target="_blank" title="å¾®ä¿¡"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wechat"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://res.abeim.cn/api/qq/?qq=1563085328" target="_blank" title="QQ"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-qq"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1199523404" target="_blank" title="Bç«™"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://github.com/Alanyaeer" target="_blank" title="github"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-github"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://leetcode.cn/u/sao-hei-chu-e-wei-dang-yu-min" target="_blank" title="åŠ›æ‰£"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-leetcode1"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:25px;width:25px;fill:currentColor;position:relative;top:5px" aria-hidden="true"><use xlink:href="#icon-gonggao"></use></svg></a><span>å…¬å‘Š</span></div><div class="announcement_content">åšå®¢æ­£åœ¨å¼€å‘ä¸­ã€‚ã€‚ã€‚</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Netty%E6%A1%86%E6%9E%B6"><span class="toc-number">1.</span> <span class="toc-text">Nettyæ¡†æ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NIO%E6%A1%86%E6%9E%B6%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">NIOæ¡†æ¶å­˜åœ¨çš„é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%B3%E9%97%AD%E5%AF%BC%E8%87%B4%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A9%BA%E8%BD%AE%E8%AF%A2"><span class="toc-number">1.1.1.</span> <span class="toc-text">å®¢æˆ·ç«¯å…³é—­å¯¼è‡´æœåŠ¡ç«¯ç©ºè½®è¯¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%98%E5%8C%85-%E6%8B%86%E5%8C%85%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.2.</span> <span class="toc-text">ç²˜åŒ…/æ‹†åŒ…é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B0%E8%BF%9BNetty%E6%A1%86%E6%9E%B6"><span class="toc-number">1.2.</span> <span class="toc-text">èµ°è¿›Nettyæ¡†æ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ByteBuf%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">ByteBufä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">é›¶æ‹·è´ç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netty%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">Nettyå·¥ä½œæ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Channel%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.4.</span> <span class="toc-text">Channelè¯¦è§£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventLoop%E5%92%8C%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-number">1.2.5.</span> <span class="toc-text">EventLoopå’Œä»»åŠ¡è°ƒåº¦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Future%E5%92%8CPromise"><span class="toc-number">1.2.6.</span> <span class="toc-text">Futureå’ŒPromise</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%99%A8%E5%92%8C%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="toc-number">1.2.7.</span> <span class="toc-text">ç¼–ç å™¨å’Œè§£ç å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0HTTP%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1"><span class="toc-number">1.2.8.</span> <span class="toc-text">å®ç°HTTPåè®®é€šä¿¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%86%85%E7%BD%AEHandler%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.9.</span> <span class="toc-text">å…¶ä»–å†…ç½®Handlerä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="toc-number">1.2.10.</span> <span class="toc-text">å¯åŠ¨æµç¨‹æºç è§£è¯»</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:25px;width:25px;fill:currentColor;position:relative;top:5px" aria-hidden="true"><use xlink:href="#icon--shijian"></use></svg></a><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/04/Netty%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="Nettyå­¦ä¹ è®°å½•"><img src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202406042208033.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nettyå­¦ä¹ è®°å½•"></a><div class="content"><a class="title" href="/2024/06/04/Netty%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="Nettyå­¦ä¹ è®°å½•">Nettyå­¦ä¹ è®°å½•</a><time datetime="2024-06-04T14:04:51.167Z" title="å‘è¡¨äº 2024-06-04 22:04:51">2024-06-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/04/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•"><img src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202406042201773.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•"></a><div class="content"><a class="title" href="/2024/06/04/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•">javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•</a><time datetime="2024-06-04T14:04:32.697Z" title="å‘è¡¨äº 2024-06-04 22:04:32">2024-06-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/" title="æ— é¢˜">æ— é¢˜</a><time datetime="2024-03-17T13:05:20.700Z" title="å‘è¡¨äº 2024-03-17 21:05:20">2024-03-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="æ— é¢˜">æ— é¢˜</a><time datetime="2024-03-17T13:04:56.001Z" title="å‘è¡¨äº 2024-03-17 21:04:56">2024-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/21/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="è®¾è®¡æ¨¡å¼"><img src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202312212341286.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¾è®¡æ¨¡å¼"></a><div class="content"><a class="title" href="/2023/12/21/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</a><time datetime="2023-12-21T15:21:41.000Z" title="å‘è¡¨äº 2023-12-21 23:21:41">2023-12-21</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">Â©2020 - 2024 By è€¶æ ¼å°”</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"><span id="percent">0<span>%</span></span></i></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/jquery.js"></script><script src="/js/foot.js"></script><script async="" src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script src="/js/sun_moon.js" async=""></script><script async="" src="/js/fps.js"></script><script async="" src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async="" src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script defer="" data-pjax="" src="/js/readPercent.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script src="/js/share.js"></script><script async="" src="//at.alicdn.com/t/c/font_4310562_r2j4rpxkbn.js"></script><script async="" src="/js/title.js"></script><script async="" src="/js/runtime_min.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --> <script data-pjax="">if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/Hexo/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“š hexoæŒ‡å— (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/Java/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ® JavaæŒ‡å— (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/å‰åç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ±â€ğŸ‘“ å‰åç«¯æŒ‡å— (18)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/æ“ä½œç³»ç»Ÿ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“’ æ“ä½œç³»ç»ŸæŒ‡å— (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="http://alanyaeer.fun/categories" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #69e8f2}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style>opacity: 0.1;</style><script data-pjax="">
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310291935375.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Java/&quot;);" href="javascript:void(0);">Java</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">HexoæŒ‡å—</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292110565.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Hexo/&quot;);" href="javascript:void(0);">Hexo</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">JavaæŒ‡å—</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292110569.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/å‰åç«¯/&quot;);" href="javascript:void(0);">å‰åç«¯</a><span class="categoryBar-list-count">18</span><span class="categoryBar-list-descr">å‰åç«¯æŒ‡å—</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292131968.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/åç«¯/&quot;);" href="javascript:void(0);">åç«¯</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">æ“ä½œç³»ç»Ÿ</span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/æ“ä½œç³»ç»Ÿ/&quot;);" href="javascript:void(0);">æ“ä½œç³»ç»Ÿ</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/å‰ç«¯/&quot;);" href="javascript:void(0);">å‰ç«¯</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/ç®—æ³•/&quot;);" href="javascript:void(0);">ç®—æ³•</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('å·²æŒ‚è½½butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax="">
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = '0d70a707189f48a8b262edfc710e07e9';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax="" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax="">
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/12/knife4jçš„é…ç½®/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311121830288.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/12/knife4jçš„é…ç½®/&quot;);" href="javascript:void(0);" alt="">knife4jçš„é…ç½®</a><div class="blog-slider__text">knife4jåœ¨ä¸åŒspringbootç‰ˆæœ¬çš„é…ç½®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/12/knife4jçš„é…ç½®/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/10/31/Java-Juc/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310312009843.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-31</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/10/31/Java-Juc/&quot;);" href="javascript:void(0);" alt="">Java_Juc</a><div class="blog-slider__text">Java_Juc</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/10/31/Java-Juc/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/12/springsecurityçš„å­¦ä¹ /&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311122356745.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/12/springsecurityçš„å­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">springsecurityçš„å­¦ä¹ </a><div class="blog-slider__text">è¿™æ˜¯æˆ‘çš„springsecurityçš„å­¦ä¹ è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/12/springsecurityçš„å­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/07/linux-ftpè®¾ç½®/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311081142035.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/07/linux-ftpè®¾ç½®/&quot;);" href="javascript:void(0);" alt="">linux-ftpè®¾ç½®</a><div class="blog-slider__text">è¿œç¨‹linuxè®¾ç½®rootç”¨æˆ·çš„ftp</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/07/linux-ftpè®¾ç½®/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/18/rediså®æˆ˜ç¯‡/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311181702738.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/18/rediså®æˆ˜ç¯‡/&quot;);" href="javascript:void(0);" alt="">rediså®æˆ˜ç¯‡</a><div class="blog-slider__text">rediså®æˆ˜ç¯‡è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/18/rediså®æˆ˜ç¯‡/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/10/28/javaå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292110572.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/10/28/javaå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½/&quot;);" href="javascript:void(0);" alt="">æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½</a><div class="blog-slider__text">springboot+vueå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/10/28/javaå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/18/elasticsearchå­¦ä¹ /&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311182039973.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/18/elasticsearchå­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">elasticsearchå­¦ä¹ </a><div class="blog-slider__text">è¿™æ˜¯ elasticsearch çš„å­¦ä¹ è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/18/elasticsearchå­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/08/dockerçš„å„ç§é…ç½®/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311091613623.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-08</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/08/dockerçš„å„ç§é…ç½®/&quot;);" href="javascript:void(0);" alt="">dockerçš„é…ç½®</a><div class="blog-slider__text">dockerå„ç§æœåŠ¡çš„é…ç½®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/08/dockerçš„å„ç§é…ç½®/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/10/31/Netty/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310312016673.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-31</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/10/31/Netty/&quot;);" href="javascript:void(0);" alt=""></a><div class="blog-slider__text">Nettyå­¦ä¹ è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/10/31/Netty/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer="" data-pjax="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax="">
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo_v5.4.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.2.2" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" title=""><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('å·²æŒ‚è½½butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async="" src="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer="" src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer="" src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>