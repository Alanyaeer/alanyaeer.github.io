<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Haoçš„ç©ºé—´ğŸ¥ | Haoçš„ç©ºé—´ğŸ¥</title><meta name="author" content="è€¶æ ¼å°”"><meta name="copyright" content="è€¶æ ¼å°”"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="NIOåŸºç¡€æ³¨æ„ï¼šæ¨èå®ŒæˆJavaSEç¯‡ã€JavaWebç¯‡çš„å­¦ä¹ å†å¼€å¯è¿™ä¸€éƒ¨åˆ†çš„å­¦ä¹ ï¼Œå¦‚æœåœ¨è¿™ä¹‹å‰å®Œæˆäº†JVMç¯‡ï¼Œé‚£ä¹ˆçœ‹èµ·æ¥å°±ä¼šæ¯”è¾ƒè½»æ¾äº†ã€‚ åœ¨JavaSEçš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨IOè¿›è¡Œæ•°æ®ä¼ è¾“ï¼ŒJava IOæ˜¯é˜»å¡çš„ï¼Œå¦‚æœåœ¨ä¸€æ¬¡è¯»å†™æ•°æ®è°ƒç”¨æ—¶æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæˆ–è€…ç›®å‰ä¸å¯å†™ï¼Œé‚£ä¹ˆè¯»å†™æ“ä½œå°±ä¼šè¢«é˜»å¡ç›´åˆ°æ•°æ®å‡†å¤‡å¥½æˆ–ç›®æ ‡å¯å†™ä¸ºæ­¢ã€‚Java NIOåˆ™æ˜¯éé˜»å¡çš„ï¼Œæ¯ä¸€æ¬¡æ•°æ®è¯»å†™è°ƒç”¨éƒ½ä¼šç«‹å³è¿”å›ï¼Œå¹¶">
<meta property="og:type" content="article">
<meta property="og:title" content="Haoçš„ç©ºé—´ğŸ¥">
<meta property="og:url" content="http://alanyaeer.fun/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="Haoçš„ç©ºé—´ğŸ¥">
<meta property="og:description" content="NIOåŸºç¡€æ³¨æ„ï¼šæ¨èå®ŒæˆJavaSEç¯‡ã€JavaWebç¯‡çš„å­¦ä¹ å†å¼€å¯è¿™ä¸€éƒ¨åˆ†çš„å­¦ä¹ ï¼Œå¦‚æœåœ¨è¿™ä¹‹å‰å®Œæˆäº†JVMç¯‡ï¼Œé‚£ä¹ˆçœ‹èµ·æ¥å°±ä¼šæ¯”è¾ƒè½»æ¾äº†ã€‚ åœ¨JavaSEçš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨IOè¿›è¡Œæ•°æ®ä¼ è¾“ï¼ŒJava IOæ˜¯é˜»å¡çš„ï¼Œå¦‚æœåœ¨ä¸€æ¬¡è¯»å†™æ•°æ®è°ƒç”¨æ—¶æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæˆ–è€…ç›®å‰ä¸å¯å†™ï¼Œé‚£ä¹ˆè¯»å†™æ“ä½œå°±ä¼šè¢«é˜»å¡ç›´åˆ°æ•°æ®å‡†å¤‡å¥½æˆ–ç›®æ ‡å¯å†™ä¸ºæ­¢ã€‚Java NIOåˆ™æ˜¯éé˜»å¡çš„ï¼Œæ¯ä¸€æ¬¡æ•°æ®è¯»å†™è°ƒç”¨éƒ½ä¼šç«‹å³è¿”å›ï¼Œå¹¶">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://alanyaeer.fun/img/avatar.jpg">
<meta property="article:published_time" content="2024-03-17T13:04:56.001Z">
<meta property="article:modified_time" content="2024-06-04T15:43:49.259Z">
<meta property="article:author" content="è€¶æ ¼å°”">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://alanyaeer.fun/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://alanyaeer.fun/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Haoçš„ç©ºé—´ğŸ¥',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-04 23:43:49'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4310562_upfi60u88s.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/progress_bar.css" media="defer" onload="this.media='all'"></head><body><span id="fps"></span><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/progress_bar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">7</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon fas fa-home" aria-hidden="true"><use xlink:href="#icon-home"></use></svg><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon fas fa-archive" aria-hidden="true"><use xlink:href="#icon-guidang"></use></svg><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-sekuaibiaoqian"></i><svg class="icon fas fa-tags" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon fas fa-folder-open" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon hide" aria-hidden="true"><use xlink:href="#icon-liebiao1"></use></svg><span> åˆ—è¡¨</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon fas fa-music" aria-hidden="true"><use xlink:href="#icon-yinle">                   </use></svg><span> éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon fas fa-video" aria-hidden="true"><use xlink:href="#icon-dianying">                   </use></svg><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-a-027_kecheng"></i><svg class="icon fas fa-envelope-open" aria-hidden="true"><use xlink:href="#icon-a-027_kecheng"></use></svg><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon fas fa-link" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-a-027_huodong"></i><svg class="icon fas fa-heart" aria-hidden="true"><use xlink:href="#icon-a-027_huodong"></use></svg><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Haoçš„ç©ºé—´ğŸ¥"><span class="site-name">Haoçš„ç©ºé—´ğŸ¥</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon fas fa-home" aria-hidden="true"><use xlink:href="#icon-home"></use></svg><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon fas fa-archive" aria-hidden="true"><use xlink:href="#icon-guidang"></use></svg><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-sekuaibiaoqian"></i><svg class="icon fas fa-tags" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon fas fa-folder-open" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon hide" aria-hidden="true"><use xlink:href="#icon-liebiao1"></use></svg><span> åˆ—è¡¨</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon fas fa-music" aria-hidden="true"><use xlink:href="#icon-yinle">                   </use></svg><span> éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon fas fa-video" aria-hidden="true"><use xlink:href="#icon-dianying">                   </use></svg><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-a-027_kecheng"></i><svg class="icon fas fa-envelope-open" aria-hidden="true"><use xlink:href="#icon-a-027_kecheng"></use></svg><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon fas fa-link" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-a-027_huodong"></i><svg class="icon fas fa-heart" aria-hidden="true"><use xlink:href="#icon-a-027_huodong"></use></svg><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">æ— é¢˜</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2024-03-17T13:04:56.001Z" title="å‘è¡¨äº 2024-03-17 21:04:56">2024-03-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-06-04T15:43:49.259Z" title="æ›´æ–°äº 2024-06-04 23:43:49">2024-06-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">19.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>74åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1ixd6z9kxj21hi0dmab5.jpg" alt="image-20220422233930778"></p>
<h1 id="NIOåŸºç¡€"><a href="#NIOåŸºç¡€" class="headerlink" title="NIOåŸºç¡€"></a>NIOåŸºç¡€</h1><p><strong>æ³¨æ„ï¼š</strong>æ¨èå®ŒæˆJavaSEç¯‡ã€JavaWebç¯‡çš„å­¦ä¹ å†å¼€å¯è¿™ä¸€éƒ¨åˆ†çš„å­¦ä¹ ï¼Œå¦‚æœåœ¨è¿™ä¹‹å‰å®Œæˆäº†JVMç¯‡ï¼Œé‚£ä¹ˆçœ‹èµ·æ¥å°±ä¼šæ¯”è¾ƒè½»æ¾äº†ã€‚</p>
<p>åœ¨JavaSEçš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†å¦‚ä½•ä½¿ç”¨IOè¿›è¡Œæ•°æ®ä¼ è¾“ï¼ŒJava IOæ˜¯é˜»å¡çš„ï¼Œå¦‚æœåœ¨ä¸€æ¬¡è¯»å†™æ•°æ®è°ƒç”¨æ—¶æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæˆ–è€…ç›®å‰ä¸å¯å†™ï¼Œé‚£ä¹ˆè¯»å†™æ“ä½œå°±ä¼šè¢«é˜»å¡ç›´åˆ°æ•°æ®å‡†å¤‡å¥½æˆ–ç›®æ ‡å¯å†™ä¸ºæ­¢ã€‚Java NIOåˆ™æ˜¯éé˜»å¡çš„ï¼Œæ¯ä¸€æ¬¡æ•°æ®è¯»å†™è°ƒç”¨éƒ½ä¼šç«‹å³è¿”å›ï¼Œå¹¶å°†ç›®å‰å¯è¯»ï¼ˆæˆ–å¯å†™ï¼‰çš„å†…å®¹å†™å…¥ç¼“å†²åŒºæˆ–è€…ä»ç¼“å†²åŒºä¸­è¾“å‡ºï¼Œå³ä½¿å½“å‰æ²¡æœ‰å¯ç”¨æ•°æ®ï¼Œè°ƒç”¨ä»ç„¶ä¼šç«‹å³è¿”å›å¹¶ä¸”ä¸å¯¹ç¼“å†²åŒºåšä»»ä½•æ“ä½œã€‚</p>
<p>NIOæ¡†æ¶æ˜¯åœ¨JDK1.4æ¨å‡ºçš„ï¼Œå®ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³ä¼ ç»ŸIOçš„ä¸è¶³ï¼Œè¿™ä¸€æœŸè§†é¢‘ï¼Œæˆ‘</p>
<p>ä»¬å°±å°†å›´ç»•ç€NIOå¼€å§‹è®²è§£ã€‚</p>
<h2 id="ç¼“å†²åŒº"><a href="#ç¼“å†²åŒº" class="headerlink" title="ç¼“å†²åŒº"></a>ç¼“å†²åŒº</h2><p>ä¸€åˆ‡çš„ä¸€åˆ‡è¿˜è¦ä»ç¼“å†²åŒºå¼€å§‹è®²èµ·ï¼ŒåŒ…æ‹¬æºç åœ¨å†…ï¼Œå…¶å®è¿™ä¸ªä¸æ˜¯å¾ˆéš¾ï¼Œåªæ˜¯éœ€è¦ç†æ¸…æ€è·¯ã€‚</p>
<h3 id="Bufferç±»åŠå…¶å®ç°"><a href="#Bufferç±»åŠå…¶å®ç°" class="headerlink" title="Bufferç±»åŠå…¶å®ç°"></a>Bufferç±»åŠå…¶å®ç°</h3><p>Bufferç±»æ˜¯ç¼“å†²åŒºçš„å®ç°ï¼Œç±»ä¼¼äºJavaä¸­çš„æ•°ç»„ï¼Œä¹Ÿæ˜¯ç”¨äºå­˜æ”¾å’Œè·å–æ•°æ®çš„ã€‚ä½†æ˜¯Bufferç›¸æ¯”Javaä¸­çš„æ•°ç»„ï¼ŒåŠŸèƒ½å°±éå¸¸å¼ºå¤§äº†ï¼Œå®ƒåŒ…å«ä¸€ç³»åˆ—å¯¹äºæ•°ç»„çš„å¿«æ·æ“ä½œã€‚</p>
<p>Bufferæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„æ ¸å¿ƒå†…å®¹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Buffer</span> {</span><br><span class="line">    <span class="comment">// è¿™å››ä¸ªå˜é‡çš„å…³ç³»: mark &lt;= position &lt;= limit &lt;= capacity</span></span><br><span class="line">  	<span class="comment">// è¿™äº›å˜é‡å°±æ˜¯Bufferæ“ä½œçš„æ ¸å¿ƒäº†ï¼Œä¹‹åæˆ‘ä»¬å­¦ä¹ çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹æºç æ˜¯å¦‚ä½•æ“ä½œè¿™äº›å˜é‡çš„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mark</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> limit;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›´æ¥ç¼“å†²åŒºå®ç°å­ç±»çš„æ•°æ®å†…å­˜åœ°å€ï¼ˆä¹‹åä¼šè®²è§£ï¼‰</span></span><br><span class="line">    <span class="type">long</span> address;</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹Bufferç±»çš„å­ç±»ï¼ŒåŒ…æ‹¬æˆ‘ä»¬è®¤è¯†åˆ°çš„æ‰€æœ‰åŸºæœ¬ç±»å‹ï¼ˆé™¤äº†<code>boolean</code>ç±»å‹ä¹‹å¤–ï¼‰ï¼š</p>
<ul>
<li>IntBuffer   -   intç±»å‹çš„ç¼“å†²åŒºã€‚</li>
<li>ShortBuffer   -   shortç±»å‹çš„ç¼“å†²åŒºã€‚</li>
<li>LongBuffer   -   longç±»å‹çš„ç¼“å†²åŒºã€‚</li>
<li>FloatBuffer   -   floatç±»å‹çš„ç¼“å†²åŒºã€‚</li>
<li>DoubleBuffer   -   doubleç±»å‹çš„ç¼“å†²åŒºã€‚</li>
<li>ByteBuffer   -   byteç±»å‹çš„ç¼“å†²åŒºã€‚</li>
<li>CharBuffer   -   charç±»å‹çš„ç¼“å†²åŒºã€‚</li>
</ul>
<p>ï¼ˆæ³¨æ„æˆ‘ä»¬ä¹‹å‰åœ¨JavaSEä¸­å­¦ä¹ è¿‡çš„StringBufferè™½ç„¶ä¹Ÿæ˜¯è¿™ç§å‘½åæ–¹å¼ï¼Œä½†æ˜¯ä¸å±äºBufferä½“ç³»ï¼Œè¿™é‡Œä¸ä¼šè¿›è¡Œä»‹ç»ï¼‰</p>
<p>è¿™é‡Œæˆ‘ä»¬ä»¥IntBufferä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºä¸€ä¸ªBufferç±»ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">  	<span class="comment">//åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºä¸èƒ½ç›´æ¥newï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨é™æ€æ–¹æ³•å»ç”Ÿæˆï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</span></span><br><span class="line">    <span class="comment">//1. ç”³è¯·ä¸€ä¸ªå®¹é‡ä¸º10çš„intç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">//2. å¯ä»¥å°†ç°æœ‰çš„æ•°ç»„ç›´æ¥è½¬æ¢ä¸ºç¼“å†²åŒºï¼ˆåŒ…æ‹¬æ•°ç»„ä¸­çš„æ•°æ®ï¼‰</span></span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>};</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(arr);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆå®ƒçš„å†…éƒ¨æ˜¯æœ¬è´¨ä¸Šå¦‚ä½•è¿›è¡Œæ“ä½œçš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IntBuffer <span class="title function_">allocate</span><span class="params">(<span class="type">int</span> capacity)</span> {</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>)   <span class="comment">//å¦‚æœç”³è¯·çš„å®¹é‡å°äº0ï¼Œé‚£è¿˜æœ‰å•¥æ„æ€</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapIntBuffer</span>(capacity, capacity);   <span class="comment">//å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„IntBufferå®ç°ç±»</span></span><br><span class="line">  	<span class="comment">//HeapIntBufferæ˜¯åœ¨å †å†…å­˜ä¸­å­˜æ”¾æ•°æ®ï¼Œæœ¬è´¨ä¸Šå°±æ•°ç»„ï¼Œä¸€ä¼šæˆ‘ä»¬å¯ä»¥åœ¨æ·±å…¥çœ‹ä¸€ä¸‹</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IntBuffer <span class="title function_">wrap</span><span class="params">(<span class="type">int</span>[] array, <span class="type">int</span> offset, <span class="type">int</span> length)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      	<span class="comment">//å¯ä»¥çœ‹åˆ°è¿™ä¸ªä¹Ÿæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„HeapIntBufferå¯¹è±¡ï¼Œå¹¶ä¸”ç»™äº†åˆå§‹æ•°ç»„ä»¥åŠæˆªå–çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapIntBuffer</span>(array, offset, length);</span><br><span class="line">    } <span class="keyword">catch</span> (IllegalArgumentException x) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IntBuffer <span class="title function_">wrap</span><span class="params">(<span class="type">int</span>[] array)</span> {</span><br><span class="line">    <span class="keyword">return</span> wrap(array, <span class="number">0</span>, array.length);   <span class="comment">//è°ƒç”¨çš„æ˜¯ä¸Šé¢çš„wrapæ–¹æ³•</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆè¿™ä¸ªHeapIntBufferåˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HeapIntBuffer(<span class="type">int</span>[] buf, <span class="type">int</span> off, <span class="type">int</span> len) { <span class="comment">// æ³¨æ„è¿™ä¸ªæ„é€ æ–¹æ³•ä¸æ˜¯publicï¼Œæ˜¯é»˜è®¤çš„è®¿é—®æƒé™</span></span><br><span class="line">    <span class="built_in">super</span>(-<span class="number">1</span>, off, off + len, buf.length, buf, <span class="number">0</span>);   <span class="comment">//ä½ ä¼šå‘ç°è¿™æ€ä¹ˆåˆå»è°ƒçˆ¶ç±»çš„æ„é€ æ–¹æ³•äº†ï¼Œç»•æ¥ç»•å»</span></span><br><span class="line">  	<span class="comment">//markæ˜¯æ ‡è®°ï¼Œoffæ˜¯å½“å‰èµ·å§‹ä¸‹æ ‡ä½ç½®ï¼Œoff+lenæ˜¯æœ€å¤§ä¸‹æ ‡ä½ç½®ï¼Œbuf.lengthæ˜¯åº•å±‚ç»´æŠ¤çš„æ•°ç»„çœŸæ­£é•¿åº¦ï¼Œbufå°±æ˜¯æ•°ç»„ï¼Œæœ€åä¸€ä¸ª0æ˜¯èµ·å§‹åç§»ä½ç½®</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬åˆæ¥çœ‹çœ‹IntBufferä¸­çš„æ„é€ æ–¹æ³•æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span>[] hb;                  <span class="comment">// åªæœ‰åœ¨å †ç¼“å†²åŒºå®ç°æ—¶æ‰ä¼šä½¿ç”¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> offset;</span><br><span class="line"><span class="type">boolean</span> isReadOnly;                 <span class="comment">// åªæœ‰åœ¨å †ç¼“å†²åŒºå®ç°æ—¶æ‰ä¼šä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line">IntBuffer(<span class="type">int</span> mark, <span class="type">int</span> pos, <span class="type">int</span> lim, <span class="type">int</span> cap,   <span class="comment">// æ³¨æ„è¿™ä¸ªæ„é€ æ–¹æ³•ä¸æ˜¯publicï¼Œæ˜¯é»˜è®¤çš„è®¿é—®æƒé™</span></span><br><span class="line">             <span class="type">int</span>[] hb, <span class="type">int</span> offset)</span><br><span class="line">{</span><br><span class="line">    <span class="built_in">super</span>(mark, pos, lim, cap);  <span class="comment">//è°ƒç”¨Bufferç±»çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="built_in">this</span>.hb = hb;    <span class="comment">//hbå°±æ˜¯çœŸæ­£æˆ‘ä»¬è¦å­˜æ”¾æ•°æ®çš„æ•°ç»„ï¼Œå †ç¼“å†²åŒºåº•å±‚å…¶å®å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªæ•°ç»„</span></span><br><span class="line">    <span class="built_in">this</span>.offset = offset;   <span class="comment">//èµ·å§‹åç§»ä½ç½®</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹Bufferä¸­çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Buffer(<span class="type">int</span> mark, <span class="type">int</span> pos, <span class="type">int</span> lim, <span class="type">int</span> cap) {       <span class="comment">// æ³¨æ„è¿™ä¸ªæ„é€ æ–¹æ³•ä¸æ˜¯publicï¼Œæ˜¯é»˜è®¤çš„è®¿é—®æƒé™</span></span><br><span class="line">    <span class="keyword">if</span> (cap &lt; <span class="number">0</span>)  <span class="comment">//å®¹é‡ä¸èƒ½å°äº0ï¼Œå°äº0è¿˜ç©ä¸ªé”¤å­</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"Negative capacity: "</span> + cap);</span><br><span class="line">    <span class="built_in">this</span>.capacity = cap;   <span class="comment">//è®¾å®šç¼“å†²åŒºå®¹é‡</span></span><br><span class="line">    limit(lim);    <span class="comment">//è®¾å®šæœ€å¤§positionä½ç½®</span></span><br><span class="line">    position(pos);   <span class="comment">//è®¾å®šèµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (mark &gt;= <span class="number">0</span>) {  <span class="comment">//å¦‚æœèµ·å§‹æ ‡è®°å¤§äºç­‰äº0</span></span><br><span class="line">        <span class="keyword">if</span> (mark &gt; pos)  <span class="comment">//å¹¶ä¸”æ ‡è®°ä½ç½®å¤§äºèµ·å§‹ä½ç½®ï¼Œé‚£ä¹ˆå°±æŠ›å¼‚å¸¸ï¼ˆè‡³äºä¸ºå•¥ä¸èƒ½å¤§äºæˆ‘ä»¬åé¢å†è¯´ï¼‰</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"mark &gt; position: ("</span></span><br><span class="line">                                               + mark + <span class="string">" &gt; "</span> + pos + <span class="string">")"</span>);</span><br><span class="line">        <span class="built_in">this</span>.mark = mark;   <span class="comment">//å¦åˆ™è®¾å®šmarkä½ç½®ï¼ˆmarké»˜è®¤ä¸º-1ï¼‰</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡å¯¹æºç çš„è§‚å¯Ÿï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“æ„äº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kkaatg47j21kk0bgmyp.jpg" alt="image-20220424093805677"></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ä¸Šé¢è¿™äº›ç»“æ„çš„å„è‡ªèŒè´£åˆ’åˆ†ï¼š</p>
<ul>
<li>Bufferï¼šç¼“å†²åŒºçš„ä¸€äº›åŸºæœ¬å˜é‡å®šä¹‰ï¼Œæ¯”å¦‚å½“å‰çš„ä½ç½®ï¼ˆpositionï¼‰ã€å®¹é‡ (capacity)ã€æœ€å¤§é™åˆ¶ (limit)ã€æ ‡è®° (mark)ç­‰ï¼Œä½ è‚¯å®šä¼šç–‘æƒ‘è¿™äº›å˜é‡æœ‰å•¥ç”¨ï¼Œåˆ«ç€æ€¥ï¼Œè¿™äº›å˜é‡ä¼šåœ¨åé¢çš„æ“ä½œä¸­ç”¨åˆ°ï¼Œæˆ‘ä»¬é€æ­¥è®²è§£ã€‚</li>
<li>IntBufferç­‰å­ç±»ï¼šå®šä¹‰äº†å­˜æ”¾æ•°æ®çš„æ•°ç»„ï¼ˆåªæœ‰å †ç¼“å†²åŒºå®ç°å­ç±»æ‰ä¼šç”¨åˆ°ï¼‰ã€æ˜¯å¦åªè¯»ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®çš„å­˜æ”¾ä½ç½®ã€ä»¥åŠå¯¹äºåº•å±‚æ•°ç»„çš„ç›¸å…³æ“ä½œéƒ½åœ¨è¿™é‡Œå·²ç»å®šä¹‰å¥½äº†ï¼Œå¹¶ä¸”å·²ç»å®ç°äº†Comparableæ¥å£ã€‚</li>
<li>HeapIntBufferå †ç¼“å†²åŒºå®ç°å­ç±»ï¼šæ•°æ®å­˜æ”¾åœ¨å †ä¸­ï¼Œå®é™…ä¸Šå°±æ˜¯ç”¨çš„çˆ¶ç±»çš„æ•°ç»„åœ¨ä¿å­˜æ•°æ®ï¼Œå¹¶ä¸”å°†çˆ¶ç±»å®šä¹‰çš„æ‰€æœ‰åº•å±‚æ“ä½œå…¨éƒ¨å®ç°äº†ã€‚</li>
</ul>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å¯¹äºBufferç±»çš„åŸºæœ¬ç»“æ„å°±æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„è®¤è¯†ã€‚</p>
<h3 id="ç¼“å†²åŒºå†™æ“ä½œ"><a href="#ç¼“å†²åŒºå†™æ“ä½œ" class="headerlink" title="ç¼“å†²åŒºå†™æ“ä½œ"></a>ç¼“å†²åŒºå†™æ“ä½œ</h3><p>å‰é¢æˆ‘ä»¬äº†è§£äº†Bufferç±»çš„åŸºæœ¬æ“ä½œï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å‘ç¼“å†²åŒºä¸­å­˜æ”¾æ•°æ®ä»¥åŠè·å–æ•°æ®ï¼Œæ•°æ®çš„å­˜æ”¾åŒ…æ‹¬ä»¥ä¸‹å››ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li>public abstract IntBuffer put(int i);   -   åœ¨å½“å‰positionä½ç½®æ’å…¥æ•°æ®ï¼Œç”±å…·ä½“å­ç±»å®ç°</li>
<li>public abstract IntBuffer put(int index, int i);   -   åœ¨æŒ‡å®šä½ç½®å­˜æ”¾æ•°æ®ï¼Œä¹Ÿæ˜¯ç”±å…·ä½“å­ç±»å®ç°</li>
<li>public final IntBuffer put(int[] src);   -   ç›´æ¥å­˜æ”¾æ‰€æœ‰æ•°ç»„ä¸­çš„å†…å®¹ï¼ˆæ•°ç»„é•¿åº¦ä¸èƒ½è¶…å‡ºç¼“å†²åŒºå¤§å°ï¼‰</li>
<li>public IntBuffer put(int[] src, int offset, int length);   -   ç›´æ¥å­˜æ”¾æ•°ç»„ä¸­çš„å†…å®¹ï¼ŒåŒä¸Šï¼Œä½†æ˜¯å¯ä»¥æŒ‡å®šå­˜æ”¾ä¸€æ®µèŒƒå›´</li>
<li>public IntBuffer put(IntBuffer src);   -   ç›´æ¥å­˜æ”¾å¦ä¸€ä¸ªç¼“å†²åŒºä¸­çš„å†…å®¹</li>
</ul>
<p>æˆ‘ä»¬ä»æœ€ç®€çš„å¼€å§‹çœ‹ï¼Œæ˜¯åœ¨å½“å‰ä½ç½®æ’å…¥ä¸€ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªå½“å‰ä½ç½®æ˜¯æ€ä¹ˆå®šä¹‰çš„å‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æºç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">    hb[ix(nextPutIndex())] = x;   <span class="comment">//è¿™ä¸ªixå’ŒnextPutIndex()å¾ˆçµæ€§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“å®ç°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">ix</span><span class="params">(<span class="type">int</span> i)</span> {</span><br><span class="line">    <span class="keyword">return</span> i + offset;   <span class="comment">//å°†içš„å€¼åŠ ä¸Šæˆ‘ä»¬ä¹‹å‰è®¾å®šçš„offsetåç§»é‡å€¼ï¼Œä½†æ˜¯é»˜è®¤æ˜¯0ï¼ˆé0çš„æƒ…å†µåé¢ä¼šä»‹ç»ï¼‰</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nextPutIndex</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> position;    <span class="comment">//è·å–Bufferç±»ä¸­çš„positionä½ç½®ï¼ˆä¸€å¼€å§‹ä¹Ÿæ˜¯0ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (p &gt;= limit)    <span class="comment">//ä½ç½®è‚¯å®šä¸èƒ½è¶…è¿‡åº•å±‚æ•°ç»„æœ€å¤§é•¿åº¦ï¼Œå¦åˆ™è¶Šç•Œ</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BufferOverflowException</span>();</span><br><span class="line">    position = p + <span class="number">1</span>;   <span class="comment">//è·å–ä¹‹åä¼šä½¿å¾—Bufferç±»ä¸­çš„position+1</span></span><br><span class="line">    <span class="keyword">return</span> p;   <span class="comment">//è¿”å›å½“å‰çš„ä½ç½®</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ‰€ä»¥putæ“ä½œå®é™…ä¸Šæ˜¯å°†åº•å±‚æ•°ç»„<code>hb</code>åœ¨positionä½ç½®ä¸Šçš„æ•°æ®è¿›è¡Œè®¾å®šã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1knn61e76j21ra08it8y.jpg" alt="image-20220424113417640"></p>
<p>è®¾å®šå®Œæˆåï¼Œpositionè‡ªåŠ¨åç§»ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1knnkm8omj21ro08gjrs.jpg" alt="image-20220424113440765"></p>
<p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä»£ç æ¥çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    buffer</span><br><span class="line">            .put(<span class="number">1</span>)</span><br><span class="line">            .put(<span class="number">2</span>)</span><br><span class="line">            .put(<span class="number">3</span>);   <span class="comment">//æˆ‘ä»¬ä¾æ¬¡å­˜æ”¾ä¸‰ä¸ªæ•°æ®è¯•è¯•çœ‹</span></span><br><span class="line">    System.out.println(buffer);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡æ–­ç‚¹è°ƒè¯•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®é™…çš„æ“ä½œæƒ…å†µï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kmdmh8ypj21ks0b8gmx.jpg" alt="image-20220424105031549"></p>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸æ–­åœ°putæ“ä½œï¼Œpositionä¼šä¸€ç›´å‘åç§»åŠ¨ï¼Œå½“ç„¶å¦‚æœè¶…å‡ºæœ€å¤§é•¿åº¦ï¼Œé‚£ä¹ˆä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kmenwakbj21lu04kwfk.jpg" alt="image-20220424105131279"></p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬äºŒä¸ªputæ“ä½œæ˜¯å¦‚ä½•è¿›è¡Œï¼Œå®ƒèƒ½å¤Ÿåœ¨æŒ‡å®šä½ç½®æ’å…¥æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> x)</span> {</span><br><span class="line">    hb[ix(checkIndex(i))] = x;  <span class="comment">//è¿™é‡Œä¾ç„¶ä¼šä½¿ç”¨ixï¼Œä½†æ˜¯ä¼šæ£€æŸ¥ä½ç½®æ˜¯å¦åˆæ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">checkIndex</span><span class="params">(<span class="type">int</span> i)</span> {                       <span class="comment">// package-private</span></span><br><span class="line">    <span class="keyword">if</span> ((i &lt; <span class="number">0</span>) || (i &gt;= limit))    <span class="comment">//æ’å…¥çš„ä½ç½®ä¸èƒ½å°äº0å¹¶ä¸”ä¸èƒ½å¤§äºç­‰äºåº•å±‚æ•°ç»„æœ€å¤§é•¿åº¦</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>();</span><br><span class="line">    <span class="keyword">return</span> i;   <span class="comment">//æ²¡æœ‰é—®é¢˜å°±æŠŠiè¿”å›</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å®é™…ä¸Šè¿™ä¸ªæ¯”æˆ‘ä»¬ä¹‹å‰çš„è¦å¥½ç†è§£ä¸€äº›ï¼Œæ³¨æ„å…¨ç¨‹ä¸ä¼šæ“ä½œpositionçš„å€¼ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ç¬¬ä¸‰ä¸ªputæ“ä½œï¼Œå®ƒæ˜¯ç›´æ¥åœ¨IntBufferä¸­å®ç°çš„ï¼Œæ˜¯åŸºäºå‰ä¸¤ä¸ªputæ–¹æ³•çš„å­ç±»å®ç°æ¥å®Œæˆçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(<span class="type">int</span>[] src, <span class="type">int</span> offset, <span class="type">int</span> length)</span> {</span><br><span class="line">    checkBounds(offset, length, src.length);   <span class="comment">//æ£€æŸ¥æˆªå–èŒƒå›´æ˜¯å¦åˆæ³•ï¼Œç»™offsetã€è°ƒç”¨è€…æŒ‡å®šé•¿åº¦ã€æ•°ç»„å®é™…é•¿åº¦</span></span><br><span class="line">    <span class="keyword">if</span> (length &gt; remaining())   <span class="comment">//æ¥ç€åˆ¤æ–­è¦æ’å…¥çš„æ•°æ®é‡åœ¨ç¼“å†²åŒºæ˜¯å¦å®¹å¾—ä¸‹ï¼Œè£…ä¸ä¸‹ä¹Ÿä¸è¡Œ</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BufferOverflowException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> offset + length;   <span class="comment">//è®¡ç®—å‡ºæœ€ç»ˆè¯»å–ä½ç½®ï¼Œä¸‹é¢å¼€å§‹for</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> offset; i &lt; end; i++)</span><br><span class="line">        <span class="built_in">this</span>.put(src[i]);   <span class="comment">//æ³¨æ„æ˜¯ç›´æ¥ä»postionä½ç½®å¼€å§‹æ’å…¥ï¼Œç›´åˆ°æŒ‡å®šèŒƒå›´ç»“æŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;   <span class="comment">//ojbk</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> IntBuffer <span class="title function_">put</span><span class="params">(<span class="type">int</span>[] src)</span> {</span><br><span class="line">    <span class="keyword">return</span> put(src, <span class="number">0</span>, src.length);   <span class="comment">//å› ä¸ºä¸éœ€è¦æŒ‡å®šèŒƒå›´ï¼Œæ‰€ä»¥ç›´æ¥0å’Œlengthï¼Œç„¶åè°ƒä¸Šé¢çš„ï¼Œå¤šæå“¦</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">remaining</span><span class="params">()</span> {  <span class="comment">//è®¡ç®—å¹¶è·å–å½“å‰ç¼“å†²åŒºçš„å‰©ä½™ç©ºé—´</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> limit - position;   <span class="comment">//æœ€å¤§å®¹é‡å‡å»å½“å‰ä½ç½®ï¼Œå°±æ˜¯å‰©ä½™ç©ºé—´</span></span><br><span class="line">    <span class="keyword">return</span> rem &gt; <span class="number">0</span> ? rem : <span class="number">0</span>;  <span class="comment">//æ²¡å®¹é‡å°±è¿”å›0</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkBounds</span><span class="params">(<span class="type">int</span> off, <span class="type">int</span> len, <span class="type">int</span> size)</span> { <span class="comment">// package-private</span></span><br><span class="line">    <span class="keyword">if</span> ((off | len | (off + len) | (size - (off + len))) &lt; <span class="number">0</span>)  <span class="comment">//è®©æˆ‘çŒœçŒœï¼Œçœ‹ä¸æ‡‚äº†æ˜¯å§</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>();</span><br><span class="line">  	<span class="comment">//å®é™…ä¸Šå°±æ˜¯çœ‹ç»™å®šçš„æ•°ç»„èƒ½ä¸èƒ½æˆªå–å‡ºæŒ‡å®šçš„è¿™æ®µæ•°æ®ï¼Œå¦‚æœéƒ½ä¸å¤Ÿäº†é‚£è‚¯å®šä¸è¡Œå•Š</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼Œé¦–å…ˆæ¥äº†ä¸€ä¸ªæ•°ç»„è¦å–ä¸€æ®µæ•°æ®å…¨éƒ¨ä¸¢è¿›ç¼“å†²åŒºï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1knmgx4rfj21qy0j6wga.jpg" alt="image-20220424113337189"></p>
<p>åœ¨æ£€æŸ¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜å¹¶ä¸”ç¼“å†²åŒºæœ‰å®¹é‡æ—¶ï¼Œå°±å¯ä»¥å¼€å§‹æ’å…¥äº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1knm0wy6bj21rq0jaac6.jpg" alt="Img"></p>
<p>æœ€åæˆ‘ä»¬é€šè¿‡ä»£ç æ¥çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>};</span><br><span class="line">    buffer.put(arr, <span class="number">3</span>, <span class="number">4</span>);  <span class="comment">//ä»ä¸‹æ ‡3å¼€å§‹ï¼Œæˆªå–4ä¸ªå…ƒç´ </span></span><br><span class="line"></span><br><span class="line">    System.out.println(Arrays.toString(buffer.array()));  <span class="comment">//arrayæ–¹æ³•å¯ä»¥ç›´æ¥è·å–åˆ°æ•°ç»„</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ€åç»“æœä¸ºï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1knjeatbjj219y01kmx1.jpg" alt="image-20220424113040485"></p>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¸€ä¸ªç¼“å†²åŒºçš„å†…å®¹ä¿å­˜åˆ°å¦ä¸€ä¸ªç¼“å†²åŒºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(IntBuffer src)</span> {</span><br><span class="line">    <span class="keyword">if</span> (src == <span class="built_in">this</span>)   <span class="comment">//ä¸ä¼šå§ä¸ä¼šå§ï¼Œä¸ä¼šæœ‰äººä¿å­˜è‡ªå·±å§</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (isReadOnly())   <span class="comment">//å¦‚æœæ˜¯åªè¯»çš„è¯ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ä¸å…è®¸æ’å…¥æ“ä½œçš„ï¼ˆæˆ‘çŒœä½ ä»¬è‚¯å®šä¼šé—®ä¸ºå•¥å°±è¿™é‡Œä¼šåˆ¤æ–­åªè¯»ï¼Œå‰é¢å››ä¸ªå‘¢ï¼‰</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyBufferException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> src.remaining();  <span class="comment">//ç»™è¿›æ¥çš„srcçœ‹çœ‹å®¹é‡ï¼ˆæ³¨æ„è¿™é‡Œä¸remainingçš„ç»“æœä¸æ˜¯å‰©ä½™å®¹é‡ï¼Œæ˜¯è½¬æ¢åçš„ï¼Œä¹‹åä¼šè¯´ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (n &gt; remaining())    <span class="comment">//è¿™é‡Œåˆ¤æ–­å½“å‰å‰©ä½™å®¹é‡æ˜¯å¦å°äºsrcå®¹é‡</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BufferOverflowException</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++)   <span class="comment">//ä¹Ÿæ˜¯ä»positionä½ç½®å¼€å§‹ç»§ç»­å†™å…¥</span></span><br><span class="line">        put(src.get());   <span class="comment">//é€šè¿‡getæ–¹æ³•ä¸€ä¸ªä¸€ä¸ªè¯»å–æ•°æ®å‡ºæ¥ï¼Œå…·ä½“è¿‡ç¨‹åé¢è®²è§£</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ•ˆæœï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">src</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>});</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    buffer.put(src);</span><br><span class="line">    System.out.println(Arrays.toString(buffer.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä½†æ˜¯å¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œä¼šå‡ºç°é—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">src</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) src.put(i);   <span class="comment">//æ‰‹åŠ¨æ’å…¥æ•°æ®</span></span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    buffer.put(src);</span><br><span class="line">    System.out.println(Arrays.toString(buffer.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œç»“æœå’Œä¸Šé¢çš„ä¸ä¸€æ ·ï¼Œå¹¶æ²¡æœ‰æˆåŠŸåœ°å°†æ•°æ®å¡«åˆ°ä¸‹é¢çš„IntBufferä¸­ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå®é™…ä¸Šå°±æ˜¯å› ä¸º<code>remaining()</code>çš„è®¡ç®—é—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ç›´æ¥è®¡ç®—postionçš„ä½ç½®ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬åœ¨å†™æ“ä½œå®Œæˆä¹‹åï¼Œpositionè·‘åˆ°åé¢å»äº†ï¼Œä¹Ÿå°±å¯¼è‡´<code>remaining()</code>ç»“æœæœ€åç®—å‡ºæ¥ä¸º0ã€‚</p>
<p>å› ä¸ºè¿™é‡Œä¸æ˜¯å†™æ“ä½œï¼Œæ˜¯æ¥ä¸‹æ¥éœ€è¦ä»å¤´å¼€å§‹è¿›è¡Œè¯»æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—æƒ³ä¸ªåŠæ³•æŠŠpositionç»™é€€å›åˆ°ä¸€å¼€å§‹çš„ä½ç½®ï¼Œè¿™æ ·æ‰å¯ä»¥ä»å¤´å¼€å§‹è¯»å–ï¼Œé‚£ä¹ˆæ€ä¹ˆåšå‘¢ï¼Ÿä¸€èˆ¬æˆ‘ä»¬åœ¨å†™å…¥å®Œæˆåéœ€è¦è¿›è¡Œè¯»æ“ä½œæ—¶ï¼ˆåé¢éƒ½æ˜¯è¿™æ ·ï¼Œä¸åªæ˜¯è¿™é‡Œï¼‰ï¼Œä¼šä½¿ç”¨<code>flip()</code>æ–¹æ³•è¿›è¡Œç¿»è½¬ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">flip</span><span class="params">()</span> {</span><br><span class="line">    limit = position;    <span class="comment">//ä¿®æ”¹limitå€¼ï¼Œå½“å‰å†™åˆ°å“ªé‡Œï¼Œä¸‹æ¬¡è¯»çš„æœ€ç»ˆä½ç½®å°±æ˜¯è¿™é‡Œï¼Œlimitçš„ä½œç”¨å¼€å§‹æ…¢æ…¢ä½“ç°äº†</span></span><br><span class="line">    position = <span class="number">0</span>;    <span class="comment">//positionå½’é›¶</span></span><br><span class="line">    mark = -<span class="number">1</span>;    <span class="comment">//æ ‡è®°è¿˜åŸä¸º-1ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬è¿˜æ²¡ç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·ï¼Œå†æ¬¡è®¡ç®—<code>remaining()</code>çš„ç»“æœå°±æ˜¯æˆ‘ä»¬éœ€è¦è¯»å–çš„æ•°é‡äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆputæ–¹æ³•ä¸­è¦ç”¨<code>remaining()</code>æ¥è®¡ç®—çš„åŸå› ï¼Œæˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">src</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) src.put(i);</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.allocate(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    src.flip();   <span class="comment">//æˆ‘ä»¬å¯ä»¥é€šè¿‡flipæ¥ç¿»è½¬ç¼“å†²åŒº</span></span><br><span class="line">    buffer.put(src);</span><br><span class="line">    System.out.println(Arrays.toString(buffer.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç¿»è½¬ä¹‹åå†æ¬¡è¿›è¡Œè½¬ç§»ï¼Œå°±æ­£å¸¸äº†ã€‚</p>
<h3 id="ç¼“å†²åŒºè¯»æ“ä½œ"><a href="#ç¼“å†²åŒºè¯»æ“ä½œ" class="headerlink" title="ç¼“å†²åŒºè¯»æ“ä½œ"></a>ç¼“å†²åŒºè¯»æ“ä½œ</h3><p>å‰é¢æˆ‘ä»¬çœ‹å®Œäº†å†™æ“ä½œï¼Œç°åœ¨æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹è¯»æ“ä½œã€‚è¯»æ“ä½œæœ‰å››ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>public abstract int get();</code>    -    ç›´æ¥è·å–å½“å‰positionä½ç½®çš„æ•°æ®ï¼Œç”±å­ç±»å®ç°</li>
<li><code>public abstract int get(int index); </code>  -    è·å–æŒ‡å®šä½ç½®çš„æ•°æ®ï¼Œä¹Ÿæ˜¯å­ç±»å®ç°</li>
<li><code>public IntBuffer get(int[] dst)</code>  -   å°†æ•°æ®è¯»å–åˆ°ç»™å®šçš„æ•°ç»„ä¸­</li>
<li><code>public IntBuffer get(int[] dst, int offset, int length)</code>  -   åŒä¸Šï¼ŒåŠ äº†ä¸ªèŒƒå›´</li>
</ul>
<p>æˆ‘ä»¬è¿˜æ˜¯ä»æœ€ç®€å•çš„å¼€å§‹çœ‹ï¼Œç¬¬ä¸€ä¸ªgetæ–¹æ³•çš„å®ç°åœ¨IntBufferç±»ä¸­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> hb[ix(nextGetIndex())];    <span class="comment">//ç›´æ¥ä»æ•°ç»„ä¸­å–å°±å®Œäº‹</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nextGetIndex</span><span class="params">()</span> {                          <span class="comment">// å¥½å®¶ä¼™ï¼Œè¿™ä¸è·Ÿå‰é¢é‚£ä¸ªä¸€æ¨¡ä¸€æ ·å—</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> position;</span><br><span class="line">  <span class="keyword">if</span> (p &gt;= limit)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BufferUnderflowException</span>();</span><br><span class="line">  position = p + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ¯æ¬¡è¯»å–æ“ä½œä¹‹åï¼Œä¹Ÿä¼šå°†postion+1ï¼Œç›´åˆ°æœ€åä¸€ä¸ªä½ç½®ï¼Œå¦‚æœè¿˜è¦ç»§ç»­è¯»ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kph5va26j21ry07ut94.jpg" alt="image-20220424123743020"></p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬äºŒä¸ªï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> i)</span> {</span><br><span class="line">    <span class="keyword">return</span> hb[ix(checkIndex(i))];   <span class="comment">//è¿™é‡Œä¾ç„¶æ˜¯ä½¿ç”¨checkIndexæ¥æ£€æŸ¥ä½ç½®æ˜¯å¦éæ³•</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬ä¸‰ä¸ªå’Œç¬¬å››ä¸ªï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">get</span><span class="params">(<span class="type">int</span>[] dst, <span class="type">int</span> offset, <span class="type">int</span> length)</span> {</span><br><span class="line">    checkBounds(offset, length, dst.length);   <span class="comment">//è·Ÿputæ“ä½œä¸€æ ·ï¼Œä¹Ÿæ˜¯éœ€è¦æ£€æŸ¥æ˜¯å¦è¶Šç•Œ</span></span><br><span class="line">    <span class="keyword">if</span> (length &gt; remaining())   <span class="comment">//å¦‚æœè¯»å–çš„é•¿åº¦æ¯”å¯ä»¥è¯»çš„é•¿åº¦å¤§ï¼Œé‚£è‚¯å®šæ˜¯ä¸è¡Œçš„</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BufferUnderflowException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> offset + length;    <span class="comment">//è®¡ç®—å‡ºæœ€ç»ˆè¯»å–ä½ç½®</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> offset; i &lt; end; i++)</span><br><span class="line">        dst[i] = get();   <span class="comment">//å¼€å§‹ä»positionæŠŠæ•°æ®è¯»åˆ°æ•°ç»„ä¸­ï¼Œæ³¨æ„æ˜¯åœ¨æ•°ç»„çš„offsetä½ç½®å¼€å§‹</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">get</span><span class="params">(<span class="type">int</span>[] dst)</span> {</span><br><span class="line">    <span class="keyword">return</span> get(dst, <span class="number">0</span>, dst.length);   <span class="comment">//ä¸æŒ‡å®šèŒƒå›´çš„è¯ï¼Œé‚£å°±ç›´æ¥ç”¨ä¸Šé¢çš„</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ•ˆæœï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>});</span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>];</span><br><span class="line">    buffer.get(arr, <span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">    System.out.println(Arrays.toString(arr));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kpw3b24fj21d601aq2t.jpg" alt="image-20220424125203822"></p>
<p>å¯ä»¥çœ‹åˆ°æˆåŠŸåœ°å°†æ•°æ®è¯»å–åˆ°äº†æ•°ç»„ä¸­ã€‚</p>
<p>å½“ç„¶å¦‚æœæˆ‘ä»¬éœ€è¦ç›´æ¥è·å–æ•°ç»„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>array()</code>æ–¹æ³•æ¥æ‹¿åˆ°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span>[] array() {</span><br><span class="line">    <span class="keyword">if</span> (hb == <span class="literal">null</span>)   <span class="comment">//ä¸ºç©ºé‚£è¯´æ˜åº•å±‚ä¸æ˜¯æ•°ç»„å®ç°çš„ï¼Œè‚¯å®šå°±æ²¡æ³•è½¬æ¢äº†</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">    <span class="keyword">if</span> (isReadOnly)   <span class="comment">//åªè¯»ä¹Ÿæ˜¯ä¸è®©ç›´æ¥å–å‡ºçš„ï¼Œå› ä¸ºä¸€æ—¦å–å‡ºå»å²‚ä¸æ˜¯å°±èƒ½è¢«ä¿®æ”¹äº†</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyBufferException</span>();</span><br><span class="line">    <span class="keyword">return</span> hb;   <span class="comment">//ç›´æ¥è¿”å›hb</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥è¯•è¯•çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>});</span><br><span class="line">    System.out.println(Arrays.toString(buffer.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å½“ç„¶ï¼Œæ—¢ç„¶éƒ½å·²ç»æ‹¿åˆ°äº†åº•å±‚çš„<code>hb</code>äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚æœç›´æ¥ä¿®æ”¹ä¹‹åæ˜¯ä¸æ˜¯è¯»å–åˆ°çš„å°±æ˜¯æˆ‘ä»¬çš„ä¿®æ”¹ä¹‹åçš„ç»“æœäº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>});</span><br><span class="line">    <span class="type">int</span>[] arr = buffer.array();</span><br><span class="line">    arr[<span class="number">0</span>] = <span class="number">99999</span>;   <span class="comment">//æ‹¿åˆ°æ•°ç»„å¯¹è±¡ç›´æ¥æ”¹</span></span><br><span class="line">    System.out.println(buffer.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ç§æ–¹å¼ç”±äºæ˜¯ç›´æ¥æ‹¿åˆ°çš„åº•å±‚æ•°ç»„ï¼Œæ‰€æœ‰ä¿®æ”¹ä¼šç›´æ¥ç”Ÿæ•ˆåœ¨ç¼“å†²åŒºä¸­ã€‚</p>
<p>å½“ç„¶é™¤äº†å¸¸è§„çš„è¯»å–æ–¹å¼ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>mark()</code>æ¥å®ç°è·³è½¬è¯»å–ï¼Œè¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹å‡ ä¸ªæ“ä½œï¼š</p>
<ul>
<li><code>public final Buffer mark()</code>   -   æ ‡è®°å½“å‰ä½ç½®</li>
<li><code>public final Buffer reset()</code>   -   è®©å½“å‰çš„positionä½ç½®è·³è½¬åˆ°markå½“æ—¶æ ‡è®°çš„ä½ç½®</li>
</ul>
<p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹æ ‡è®°æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">mark</span><span class="params">()</span> {</span><br><span class="line">    mark = position;   <span class="comment">//ç›´æ¥æ ‡è®°åˆ°å½“å‰ä½ç½®ï¼Œmarkå˜é‡ç»ˆäºæ´¾ä¸Šç”¨åœºäº†ï¼Œå½“ç„¶è¿™é‡Œä»…ä»…æ˜¯æ ‡è®°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹é‡ç½®æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">reset</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> mark;   <span class="comment">//å­˜ä¸€ä¸‹å½“å‰çš„markä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (m &lt; <span class="number">0</span>)    <span class="comment">//å› ä¸ºmarké»˜è®¤æ˜¯-1ï¼Œè¦æ˜¯æ²¡æœ‰è¿›è¡Œè¿‡ä»»ä½•æ ‡è®°æ“ä½œï¼Œé‚£resetä¸ªæ¯›</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidMarkException</span>();</span><br><span class="line">    position = m;   <span class="comment">//ç›´æ¥è®©positionå˜æˆmarkä½ç½®</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£æ¯”å¦‚æˆ‘ä»¬åœ¨è¯»å–åˆ°1å·ä½ç½®æ—¶è¿›è¡Œæ ‡è®°ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1krtfdjjxj21qw082t96.jpg" alt="image-20220424135842228"></p>
<p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨resetæ–¹æ³•å°±å¯ä»¥ç›´æ¥å›é€€å›å»äº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kru5ys1aj21ru096dgg.jpg" alt="image-20220424135925501"></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>});</span><br><span class="line">    buffer.get();   <span class="comment">//è¯»å–ä¸€ä½ï¼Œé‚£ä¹ˆpositionå°±å˜æˆ1äº†</span></span><br><span class="line">    buffer.mark();   <span class="comment">//è¿™æ—¶æ ‡è®°ï¼Œé‚£ä¹ˆmark = 1</span></span><br><span class="line">    buffer.get();   <span class="comment">//åˆè¯»å–ä¸€ä½ï¼Œé‚£ä¹ˆpositionå°±å˜æˆ2äº†</span></span><br><span class="line">    buffer.reset();    <span class="comment">//ç›´æ¥å°†position = markï¼Œä¹Ÿå°±æ˜¯å˜å›1</span></span><br><span class="line">    System.out.println(buffer.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¯»å–çš„ä½ç½®æ ¹æ®æˆ‘ä»¬çš„æ“ä½œè¿›è¡Œäº†å˜åŒ–ï¼Œæœ‰å…³ç¼“å†²åŒºçš„è¯»æ“ä½œï¼Œå°±æš‚æ—¶è®²åˆ°è¿™é‡Œã€‚</p>
<h3 id="ç¼“å†²åŒºå…¶ä»–æ“ä½œ"><a href="#ç¼“å†²åŒºå…¶ä»–æ“ä½œ" class="headerlink" title="ç¼“å†²åŒºå…¶ä»–æ“ä½œ"></a>ç¼“å†²åŒºå…¶ä»–æ“ä½œ</h3><p>å‰é¢æˆ‘ä»¬å¤§è‡´äº†è§£äº†ä¸€ä¸‹ç¼“å†²åŒºçš„è¯»å†™æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹ï¼Œé™¤äº†å¸¸è§„çš„è¯»å†™æ“ä½œä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›å…¶ä»–çš„æ“ä½œï¼š</p>
<ul>
<li><code>public abstract IntBuffer compact()</code>   -   å‹ç¼©ç¼“å†²åŒºï¼Œç”±å…·ä½“å®ç°ç±»å®ç°</li>
<li><code>public IntBuffer duplicate()</code>   -   å¤åˆ¶ç¼“å†²åŒºï¼Œä¼šç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®ç›¸åŒçš„ç¼“å†²åŒº</li>
<li><code>public abstract IntBuffer slice()</code>   -    åˆ’åˆ†ç¼“å†²åŒºï¼Œä¼šå°†åŸæœ¬çš„å®¹é‡å¤§å°çš„ç¼“å†²åŒºåˆ’åˆ†ä¸ºæ›´å°çš„å‡ºæ¥è¿›è¡Œæ“ä½œ</li>
<li><code>public final Buffer rewind()</code>  -   é‡ç»•ç¼“å†²åŒºï¼Œå…¶å®å°±æ˜¯æŠŠpositionå½’é›¶ï¼Œç„¶åmarkå˜å›-1</li>
<li><code>public final Buffer clear()</code>  -   å°†ç¼“å†²åŒºæ¸…ç©ºï¼Œæ‰€æœ‰çš„å˜é‡å˜å›æœ€åˆçš„çŠ¶æ€</li>
</ul>
<p>æˆ‘ä»¬å…ˆä»å‹ç¼©ç¼“å†²åŒºå¼€å§‹çœ‹èµ·ï¼Œå®ƒä¼šå°†æ•´ä¸ªç¼“å†²åŒºçš„å¤§å°å’Œæ•°æ®å†…å®¹å˜æˆpositionä½ç½®åˆ°limitä¹‹é—´çš„æ•°æ®ï¼Œå¹¶ç§»åŠ¨åˆ°æ•°ç»„å¤´éƒ¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">compact</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> position();   <span class="comment">//è·å–å½“å‰ä½ç½®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">lim</span> <span class="operator">=</span> limit();    <span class="comment">//è·å–å½“å‰æœ€å¤§positionä½ç½®</span></span><br><span class="line">    <span class="keyword">assert</span> (pos &lt;= lim);   <span class="comment">//æ–­è¨€è¡¨è¾¾å¼ï¼Œpositionå¿…é¡»å°äºæœ€å¤§ä½ç½®ï¼Œè‚¯å®šçš„</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> (pos &lt;= lim ? lim - pos : <span class="number">0</span>);  <span class="comment">//è®¡ç®—posè·ç¦»æœ€å¤§ä½ç½®çš„é•¿åº¦</span></span><br><span class="line">    System.arraycopy(hb, ix(pos), hb, ix(<span class="number">0</span>), rem);   <span class="comment">//ç›´æ¥å°†hbæ•°ç»„å½“å‰positionä½ç½®çš„æ•°æ®æ‹·è´åˆ°å¤´éƒ¨å»ï¼Œç„¶åé•¿åº¦æ”¹æˆåˆšåˆšè®¡ç®—å‡ºæ¥çš„ç©ºé—´</span></span><br><span class="line">    position(rem);   <span class="comment">//ç›´æ¥å°†positionç§»åŠ¨åˆ°remä½ç½®</span></span><br><span class="line">    limit(capacity());   <span class="comment">//posæœ€å¤§ä½ç½®ä¿®æ”¹ä¸ºæœ€å¤§å®¹é‡</span></span><br><span class="line">    discardMark();   <span class="comment">//markå˜å›-1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¯”å¦‚ç°åœ¨çš„çŠ¶æ€æ˜¯ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1krvhots6j21s0088aar.jpg" alt="image-20220424140040711"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬åœ¨æ‰§è¡Œ<code> compact()</code>æ–¹æ³•ä¹‹åï¼Œä¼šè¿›è¡Œæˆªå–ï¼Œæ­¤æ—¶<code>limit - position = 6</code>ï¼Œé‚£ä¹ˆå°±ä¼šæˆªå–ç¬¬<code>4ã€5ã€6ã€7ã€8ã€9</code>è¿™6ä¸ªæ•°æ®ç„¶åä¸¢åˆ°æœ€å‰é¢ï¼Œæ¥ç€positionè·‘åˆ°<code>7</code>è¡¨ç¤ºè¿™æ˜¯ä¸‹ä¸€ä¸ªç»§ç»­çš„ä½ç½®ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1krycqrmej21ri080wfb.jpg" alt="image-20220424140326373"></p>
<p>ç°åœ¨æˆ‘ä»¬é€šè¿‡ä»£ç æ¥æ£€éªŒä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>});</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) buffer.get();   <span class="comment">//å…ˆæ­£å¸¸è¯»4ä¸ª</span></span><br><span class="line">    buffer.compact();   <span class="comment">//å‹ç¼©ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"å‹ç¼©ä¹‹åçš„æƒ…å†µï¼š"</span>+Arrays.toString(buffer.array()));</span><br><span class="line">    System.out.println(<span class="string">"å½“å‰positionä½ç½®ï¼š"</span>+buffer.position());</span><br><span class="line">    System.out.println(<span class="string">"å½“å‰limitä½ç½®ï¼š"</span>+buffer.limit());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ€åçš„ç»“æœæ²¡æœ‰é—®é¢˜ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1ksetaccij21b603oq35.jpg" alt="image-20220424141916082"></p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç°åœ¨éœ€è¦å¤åˆ¶ä¸€ä¸ªå†…å®¹ä¸€æ¨¡ä¸€æ ·çš„çš„ç¼“å†²åŒºï¼Œè¯¥æ€ä¹ˆåšï¼Ÿç›´æ¥ä½¿ç”¨<code>duplicate()</code>æ–¹æ³•å°±å¯ä»¥å¤åˆ¶äº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">duplicate</span><span class="params">()</span> {   <span class="comment">//ç›´æ¥newä¸€ä¸ªæ–°çš„ï¼Œä½†æ˜¯æ˜¯å§hbç»™ä¸¢è¿›å»äº†ï¼Œè€Œä¸æ˜¯æ‹·è´ä¸€ä¸ªæ–°çš„</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapIntBuffer</span>(hb,</span><br><span class="line">                                    <span class="built_in">this</span>.markValue(),</span><br><span class="line">                                    <span class="built_in">this</span>.position(),</span><br><span class="line">                                    <span class="built_in">this</span>.limit(),</span><br><span class="line">                                    <span class="built_in">this</span>.capacity(),</span><br><span class="line">                                    offset);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆå„ä½çŒœæƒ³ä¸€ä¸‹ï¼Œå¦‚æœé€šè¿‡è¿™ç§æ–¹å¼åˆ›äº†ä¸€ä¸ªæ–°çš„IntBufferï¼Œé‚£ä¹ˆä¸‹é¢çš„ä¾‹å­ä¼šå‡ºç°ä»€ä¹ˆç»“æœï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>});</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">duplicate</span> <span class="operator">=</span> buffer.duplicate();</span><br><span class="line"></span><br><span class="line">    System.out.println(buffer == duplicate);</span><br><span class="line">    System.out.println(buffer.array() == duplicate.array());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç”±äºbufferæ˜¯é‡æ–°newçš„ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªä¸ºfalseï¼Œè€Œåº•å±‚çš„æ•°ç»„ç”±äºåœ¨æ„é€ çš„æ—¶å€™æ²¡æœ‰è¿›è¡Œä»»ä½•çš„æ‹·è´è€Œæ˜¯ç›´æ¥ä¼ é€’ï¼Œå› æ­¤å®é™…ä¸Šä¸¤ä¸ªç¼“å†²åŒºçš„åº•å±‚æ•°ç»„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ªå‘ç”Ÿä¿®æ”¹ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªå°±è·Ÿç€å˜äº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>});</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">duplicate</span> <span class="operator">=</span> buffer.duplicate();</span><br><span class="line"></span><br><span class="line">    buffer.put(<span class="number">0</span>, <span class="number">66666</span>);</span><br><span class="line">    System.out.println(duplicate.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬æ¥ç€æ¥çœ‹ä¸‹ä¸€ä¸ªæ–¹æ³•ï¼Œ<code>slice()</code>æ–¹æ³•ä¼šå°†ç¼“å†²åŒºè¿›è¡Œåˆ’åˆ†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">slice</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="built_in">this</span>.position();   <span class="comment">//è·å–å½“å‰position</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">lim</span> <span class="operator">=</span> <span class="built_in">this</span>.limit();     <span class="comment">//è·å–positionæœ€å¤§ä½ç½®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> (pos &lt;= lim ? lim - pos : <span class="number">0</span>);   <span class="comment">//æ±‚å¾—å‰©ä½™ç©ºé—´</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapIntBuffer</span>(hb,    <span class="comment">//è¿”å›ä¸€ä¸ªæ–°çš„åˆ’åˆ†å‡ºçš„ç¼“å†²åŒºï¼Œä½†æ˜¯åº•å±‚çš„æ•°ç»„ç”¨çš„è¿˜æ˜¯åŒä¸€ä¸ª</span></span><br><span class="line">                                    -<span class="number">1</span>,</span><br><span class="line">                                    <span class="number">0</span>,</span><br><span class="line">                                    rem,    <span class="comment">//æ–°çš„å®¹é‡å˜æˆäº†å‰©ä½™ç©ºé—´çš„å¤§å°</span></span><br><span class="line">                                    rem,</span><br><span class="line">                                    pos + offset);   <span class="comment">//å¯ä»¥çœ‹åˆ°offsetçš„åœ°å€ä¸å†æ˜¯0äº†ï¼Œè€Œæ˜¯å½“å‰çš„positionåŠ ä¸ŠåŸæœ‰çš„offsetå€¼</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è™½ç„¶ç°åœ¨åº•å±‚ä¾ç„¶ä½¿ç”¨çš„æ˜¯ä¹‹å‰çš„æ•°ç»„ï¼Œä½†æ˜¯ç”±äºè®¾å®šäº†offsetå€¼ï¼Œæˆ‘ä»¬ä¹‹å‰çš„æ“ä½œä¼¼ä¹å˜å¾—ä¸å¤ªä¸€æ ·äº†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1ksmjx76ij21ru07u75a.jpg" alt="image-20220424142642088"></p>
<p>å›é¡¾å‰é¢æˆ‘ä»¬æ‰€è®²è§£çš„å†…å®¹ï¼Œåœ¨è¯»å–å’Œå­˜æ”¾æ—¶ï¼Œä¼šè¢«<code>ix</code>æ–¹æ³•è¿›è¡Œè°ƒæ•´ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">ix</span><span class="params">(<span class="type">int</span> i)</span> {</span><br><span class="line">    <span class="keyword">return</span> i + offset;   <span class="comment">//ç°åœ¨offsetä¸º4ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´é€»è¾‘ä¸Šçš„iæ˜¯0ä½†æ˜¯å¾—åˆ°çœŸå®ä½ç½®å´æ˜¯4</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> hb[ix(nextGetIndex())];   <span class="comment">//æœ€åä¼šç»è¿‡ixæ–¹æ³•è½¬æ¢ä¸ºçœŸæ­£åœ¨æ•°ç»„ä¸­çš„ä½ç½®</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å½“ç„¶ï¼Œåœ¨é€»è¾‘ä¸Šæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1ksq30gzij21pw08gt9b.jpg" alt="image-20220424143002885"></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>});</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) buffer.get();</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">slice</span> <span class="operator">=</span> buffer.slice();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"åˆ’åˆ†ä¹‹åçš„æƒ…å†µï¼š"</span>+Arrays.toString(slice.array()));</span><br><span class="line">    System.out.println(<span class="string">"åˆ’åˆ†ä¹‹åçš„åç§»åœ°å€ï¼š"</span>+slice.arrayOffset());</span><br><span class="line">    System.out.println(<span class="string">"å½“å‰positionä½ç½®ï¼š"</span>+slice.position());</span><br><span class="line">    System.out.println(<span class="string">"å½“å‰limitä½ç½®ï¼š"</span>+slice.limit());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (slice.hasRemaining()) {   <span class="comment">//å°†æ‰€æœ‰çš„æ•°æ®å…¨éƒ¨æŒ¨ç€æ‰“å°å‡ºæ¥</span></span><br><span class="line">        System.out.print(slice.get()+<span class="string">", "</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆç»“æœï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1ksqmk9smj21dw05q3yy.jpg" alt="image-20220424143036449"></p>
<p>æœ€åä¸¤ä¸ªæ–¹æ³•å°±æ¯”è¾ƒç®€å•äº†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹<code>rewind()</code>ï¼Œå®ƒç›¸å½“äºæ˜¯å¯¹positionå’Œmarkè¿›è¡Œäº†ä¸€æ¬¡é‡ç½®ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">rewind</span><span class="params">()</span> {</span><br><span class="line">    position = <span class="number">0</span>;</span><br><span class="line">    mark = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ç€æ˜¯<code>clear()</code>ï¼Œå®ƒç›¸å½“äºæ˜¯å°†æ•´ä¸ªç¼“å†²åŒºå›å½’åˆ°æœ€åˆçš„çŠ¶æ€äº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title function_">clear</span><span class="params">()</span> {</span><br><span class="line">    position = <span class="number">0</span>;    <span class="comment">//åŒä¸Š</span></span><br><span class="line">    limit = capacity;   <span class="comment">//limitå˜å›capacity</span></span><br><span class="line">    mark = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åˆ°è¿™é‡Œï¼Œå…³äºç¼“å†²åŒºçš„ä¸€äº›å…¶ä»–æ“ä½œï¼Œæˆ‘ä»¬å°±è®²è§£åˆ°æ­¤ã€‚</p>
<h3 id="ç¼“å†²åŒºæ¯”è¾ƒ"><a href="#ç¼“å†²åŒºæ¯”è¾ƒ" class="headerlink" title="ç¼“å†²åŒºæ¯”è¾ƒ"></a>ç¼“å†²åŒºæ¯”è¾ƒ</h3><p>ç¼“å†²åŒºä¹‹é—´æ˜¯å¯ä»¥è¿›è¡Œæ¯”è¾ƒçš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°equalsæ–¹æ³•å’ŒcompareToæ–¹æ³•éƒ½æ˜¯è¢«é‡å†™äº†çš„ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹<code>equals</code>æ–¹æ³•ï¼Œæ³¨æ„ï¼Œå®ƒæ˜¯åˆ¤æ–­ä¸¤ä¸ªç¼“å†²åŒºå‰©ä½™çš„å†…å®¹æ˜¯å¦ä¸€è‡´ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object ob)</span> {</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span> == ob)   <span class="comment">//è¦æ˜¯ä¸¤ä¸ªç¼“å†²åŒºæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè‚¯å®šä¸€æ ·</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(ob <span class="keyword">instanceof</span> IntBuffer))  <span class="comment">//ç±»å‹ä¸æ˜¯IntBufferé‚£ä¹Ÿä¸ç”¨æ¯”äº†</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">that</span> <span class="operator">=</span> (IntBuffer)ob;   <span class="comment">//è½¬æ¢ä¸ºIntBuffer</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">thisPos</span> <span class="operator">=</span> <span class="built_in">this</span>.position();  <span class="comment">//è·å–å½“å‰ç¼“å†²åŒºçš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">thisLim</span> <span class="operator">=</span> <span class="built_in">this</span>.limit();</span><br><span class="line">    <span class="type">int</span> <span class="variable">thatPos</span> <span class="operator">=</span> that.position();  <span class="comment">//è·å–å¦ä¸€ä¸ªç¼“å†²åŒºçš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">thatLim</span> <span class="operator">=</span> that.limit();</span><br><span class="line">    <span class="type">int</span> <span class="variable">thisRem</span> <span class="operator">=</span> thisLim - thisPos; </span><br><span class="line">    <span class="type">int</span> <span class="variable">thatRem</span> <span class="operator">=</span> thatLim - thatPos;</span><br><span class="line">    <span class="keyword">if</span> (thisRem &lt; <span class="number">0</span> || thisRem != thatRem)   <span class="comment">//å¦‚æœå‰©ä½™å®¹é‡å°äº0æˆ–æ˜¯ä¸¤ä¸ªç¼“å†²åŒºçš„å‰©ä½™å®¹é‡ä¸ä¸€æ ·ï¼Œä¹Ÿä¸è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  	<span class="comment">//æ³¨æ„æ¯”è¾ƒçš„æ˜¯å‰©ä½™çš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> thisLim - <span class="number">1</span>, j = thatLim - <span class="number">1</span>; i &gt;= thisPos; i--, j--)  <span class="comment">//ä»æœ€åä¸€ä¸ªå¼€å§‹å€’ç€å¾€å›æ¯”å‰©ä½™çš„åŒºåŸŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!equals(<span class="built_in">this</span>.get(i), that.get(j)))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;   <span class="comment">//åªè¦å‘ç°ä¸ä¸€æ ·çš„å°±ä¸ç”¨ç»§ç»­äº†ï¼Œç›´æ¥false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;   <span class="comment">//ä¸Šé¢çš„æ¯”è¾ƒéƒ½æ²¡é—®é¢˜ï¼Œé‚£ä¹ˆå°±true</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> {</span><br><span class="line">    <span class="keyword">return</span> x == y;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬æŒ‰ç…§å®ƒçš„æ€è·¯æ¥éªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer1</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>});</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer2</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>});</span><br><span class="line">    System.out.println(buffer1.equals(buffer2));   <span class="comment">//ç›´æ¥æ¯”è¾ƒ</span></span><br><span class="line">    </span><br><span class="line">    buffer1.position(<span class="number">6</span>);</span><br><span class="line">    buffer2.position(<span class="number">6</span>);</span><br><span class="line">    System.out.println(buffer1.equals(buffer2));   <span class="comment">//æ¯”è¾ƒä»ä¸‹æ ‡6å¼€å§‹çš„å‰©ä½™å†…å®¹</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç»“æœå°±æ˜¯æˆ‘ä»¬æ‰€æƒ³çš„é‚£æ ·ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1ktaynv7nj21kw02gglg.jpg" alt="image-20220424145009464"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥ç€æ¥çœ‹æ¯”è¾ƒï¼Œ<code>compareTo</code>æ–¹æ³•ï¼Œå®ƒå®é™…ä¸Šæ˜¯<code>Comparable</code>æ¥å£æä¾›çš„æ–¹æ³•ï¼Œå®ƒå®é™…ä¸Šæ¯”è¾ƒçš„ä¹Ÿæ˜¯poså¼€å§‹å‰©ä½™çš„å†…å®¹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(IntBuffer that)</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">thisPos</span> <span class="operator">=</span> <span class="built_in">this</span>.position();    <span class="comment">//è·å–å¹¶è®¡ç®—ä¸¤ä¸ªç¼“å†²åŒºçš„poså’Œremain</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">thisRem</span> <span class="operator">=</span> <span class="built_in">this</span>.limit() - thisPos;</span><br><span class="line">    <span class="type">int</span> <span class="variable">thatPos</span> <span class="operator">=</span> that.position();</span><br><span class="line">    <span class="type">int</span> <span class="variable">thatRem</span> <span class="operator">=</span> that.limit() - thatPos;</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> Math.min(thisRem, thatRem);   <span class="comment">//é€‰å–ä¸€ä¸ªå‰©ä½™ç©ºé—´æœ€å°çš„å‡ºæ¥</span></span><br><span class="line">    <span class="keyword">if</span> (length &lt; <span class="number">0</span>)   <span class="comment">//å¦‚æœæœ€å°çš„å°äº0ï¼Œé‚£å°±è¿”å›-1</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> thisPos + Math.min(thisRem, thatRem);  <span class="comment">//è®¡ç®—nçš„å€¼å½“å‰çš„posåŠ ä¸Šå‰©ä½™çš„æœ€å°ç©ºé—´</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> thisPos, j = thatPos; i &lt; n; i++, j++) {  <span class="comment">//ä»ä¸¤ä¸ªç¼“å†²åŒºçš„å½“å‰ä½ç½®å¼€å§‹ï¼Œä¸€ç›´åˆ°nç»“æŸ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> compare(<span class="built_in">this</span>.get(i), that.get(j));  <span class="comment">//æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (cmp != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> cmp;   <span class="comment">//åªè¦å‡ºç°ä¸ç›¸åŒçš„ï¼Œé‚£ä¹ˆå°±è¿”å›æ¯”è¾ƒå‡ºæ¥çš„å€¼</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> thisRem - thatRem; <span class="comment">//å¦‚æœæ²¡æ¯”å‡ºæ¥ä¸ªæ‰€ä»¥ç„¶ï¼Œé‚£ä¹ˆå°±æ¯”é•¿åº¦</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> {</span><br><span class="line">    <span class="keyword">return</span> Integer.compare(x, y);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬å°±ä¸å¤šåšä»‹ç»äº†ã€‚</p>
<h3 id="åªè¯»ç¼“å†²åŒº"><a href="#åªè¯»ç¼“å†²åŒº" class="headerlink" title="åªè¯»ç¼“å†²åŒº"></a>åªè¯»ç¼“å†²åŒº</h3><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹åªè¯»ç¼“å†²åŒºï¼Œåªè¯»ç¼“å†²åŒºå°±åƒå…¶åç§°ä¸€æ ·ï¼Œå®ƒåªèƒ½è¿›è¡Œè¯»æ“ä½œï¼Œè€Œä¸å…è®¸è¿›è¡Œå†™æ“ä½œã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆåˆ›å»ºåªè¯»ç¼“å†²åŒºå‘¢ï¼Ÿ</p>
<ul>
<li><code>public abstract IntBuffer asReadOnlyBuffer();</code>   -   åŸºäºå½“å‰ç¼“å†²åŒºç”Ÿæˆä¸€ä¸ªåªè¯»çš„ç¼“å†²åŒºã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ­¤æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">asReadOnlyBuffer</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HeapIntBufferR</span>(hb,    <span class="comment">//æ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯ç›´æ¥åˆ›å»ºäº†HeapIntBufferï¼Œè€Œæ˜¯HeapIntBufferRï¼Œå¹¶ä¸”ç›´æ¥å¤åˆ¶çš„hbæ•°ç»„</span></span><br><span class="line">                                 <span class="built_in">this</span>.markValue(),</span><br><span class="line">                                 <span class="built_in">this</span>.position(),</span><br><span class="line">                                 <span class="built_in">this</span>.limit(),</span><br><span class="line">                                 <span class="built_in">this</span>.capacity(),</span><br><span class="line">                                 offset);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆè¿™ä¸ªHeapIntBufferRç±»è·Ÿæˆ‘ä»¬æ™®é€šçš„HeapIntBufferæœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„å‘¢ï¼Ÿ</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1ktrvyy39j221e0f8ac2.jpg" alt="image-20220424150625847"></p>
<p>å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ç»§æ‰¿è‡ªHeapIntBufferçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®ç°æœ‰ä»€ä¹ˆä¸åŒï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">HeapIntBufferR</span><span class="params">(<span class="type">int</span>[] buf,</span></span><br><span class="line"><span class="params">                               <span class="type">int</span> mark, <span class="type">int</span> pos, <span class="type">int</span> lim, <span class="type">int</span> cap,</span></span><br><span class="line"><span class="params">                               <span class="type">int</span> off)</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">super</span>(buf, mark, pos, lim, cap, off);</span><br><span class="line">    <span class="built_in">this</span>.isReadOnly = <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨å…¶æ„é€ æ–¹æ³•ä¸­ï¼Œé™¤äº†ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•å¤–ï¼Œè¿˜ä¼šå°†<code>isReadOnly</code>æ ‡è®°ä¿®æ”¹ä¸ºtrueï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹putæ“ä½œæœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isReadOnly</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyBufferException</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> x)</span> {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyBufferException</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(<span class="type">int</span>[] src, <span class="type">int</span> offset, <span class="type">int</span> length)</span> {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyBufferException</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> IntBuffer <span class="title function_">put</span><span class="params">(IntBuffer src)</span> {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyBufferException</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„putæ–¹æ³•å…¨éƒ¨å‡‰å‡‰ï¼Œåªè¦è°ƒç”¨å°±ä¼šç›´æ¥æŠ›å‡ºReadOnlyBufferExceptionå¼‚å¸¸ã€‚ä½†æ˜¯å…¶ä»–getæ–¹æ³•ä¾ç„¶æ²¡æœ‰è¿›è¡Œé‡å†™ï¼Œä¹Ÿå°±æ˜¯è¯´getæ“ä½œè¿˜æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„ï¼Œä½†æ˜¯åªè¦æ˜¯å†™æ“ä½œå°±éƒ½ä¸è¡Œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> IntBuffer.wrap(<span class="keyword">new</span> <span class="title class_">int</span>[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>});</span><br><span class="line">    <span class="type">IntBuffer</span> <span class="variable">readBuffer</span> <span class="operator">=</span> buffer.asReadOnlyBuffer();</span><br><span class="line"></span><br><span class="line">    System.out.println(readBuffer.isReadOnly());</span><br><span class="line">    System.out.println(readBuffer.get());</span><br><span class="line">    readBuffer.put(<span class="number">0</span>, <span class="number">666</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç»“æœä¸ºï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1ktz4pkhtj21ue04oab1.jpg" alt="image-20220424151322831"></p>
<p>è¿™å°±æ˜¯åªè¯»çŠ¶æ€ä¸‹çš„ç¼“å†²åŒºã€‚</p>
<h3 id="ByteBufferå’ŒCharBuffer"><a href="#ByteBufferå’ŒCharBuffer" class="headerlink" title="ByteBufferå’ŒCharBuffer"></a>ByteBufferå’ŒCharBuffer</h3><p>é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå·²ç»äº†è§£äº†ç¼“å†²åŒºçš„ä½¿ç”¨ï¼Œä½†æ˜¯éƒ½æ˜¯åŸºäºIntBufferè¿›è¡Œè®²è§£ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹å¦å¤–ä¸¤ç§åŸºæœ¬ç±»å‹çš„ç¼“å†²åŒºByteBufferå’ŒCharBufferï¼Œå› ä¸ºByteBufferåº•å±‚å­˜æ”¾çš„æ˜¯å¾ˆå¤šå•ä¸ªbyteå­—èŠ‚ï¼Œæ‰€ä»¥ä¼šæœ‰æ›´å¤šçš„ç©æ³•ï¼ŒåŒæ ·CharBufferæ˜¯ä¸€ç³»åˆ—å­—èŠ‚ï¼Œæ‰€ä»¥ä¹Ÿæœ‰å¾ˆå¤šä¾¿æ·æ“ä½œã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ByteBufferï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç‚¹è¿›å»çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ByteBuffer</span> <span class="keyword">extends</span> <span class="title class_">Buffer</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;ByteBuffer&gt; {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] hb;                  <span class="comment">// Non-null only for heap buffers</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> offset;</span><br><span class="line">    <span class="type">boolean</span> isReadOnly;                 <span class="comment">// Valid only for heap buffers</span></span><br><span class="line">  	....</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°å¦‚æœä¹Ÿæ˜¯ä½¿ç”¨å †ç¼“å†²åŒºå­ç±»å®ç°ï¼Œé‚£ä¹ˆä¾ç„¶æ˜¯ä¸€ä¸ª<code>byte[]</code>çš„å½¢å¼ä¿å­˜æ•°æ®ã€‚æˆ‘ä»¬æ¥å°è¯•ä½¿ç”¨ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">//é™¤äº†ç›´æ¥ä¸¢byteè¿›å»ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸¢å…¶ä»–çš„åŸºæœ¬ç±»å‹ï¼ˆæ³¨æ„å®¹é‡æ¶ˆè€—ï¼‰</span></span><br><span class="line">    buffer.putInt(Integer.MAX_VALUE);  <span class="comment">//ä¸¢ä¸ªintçš„æœ€å¤§å€¼è¿›å»ï¼Œæ³¨æ„ä¸€ä¸ªintå 4å­—èŠ‚</span></span><br><span class="line">    System.out.println(<span class="string">"å½“å‰ç¼“å†²åŒºå‰©ä½™å­—èŠ‚æ•°ï¼š"</span>+buffer.remaining());  <span class="comment">//åªå‰©6ä¸ªå­—èŠ‚äº†</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æˆ‘ä»¬æ¥å°è¯•è¯»å–ä¸€ä¸‹ï¼Œè®°å¾—å…ˆç¿»è½¬</span></span><br><span class="line">    buffer.flip();</span><br><span class="line">    <span class="keyword">while</span> (buffer.hasRemaining()) {</span><br><span class="line">        System.out.println(buffer.get());   <span class="comment">//ä¸€å…±å››ä¸ªå­—èŠ‚</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ€åçš„ç»“æœä¸ºï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kulzci1zj21cc05kaa3.jpg" alt="image-20220424153520843"></p>
<p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªbyteä¸º127ã€ç„¶åä¸‰ä¸ªéƒ½æ˜¯-1ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š</p>
<ul>
<li><code>127</code> è½¬æ¢ä¸ºäºŒè¿›åˆ¶è¡¥ç å½¢å¼å°±æ˜¯ <code>01111111</code>ï¼Œè€Œ<code>-1</code>è½¬æ¢ä¸ºäºŒè¿›åˆ¶è¡¥ç å½¢å¼ä¸º<code>11111111</code></li>
</ul>
<p>é‚£ä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯01111111ï¼Œè€Œåç»­å­—èŠ‚å°±æ˜¯11111111ï¼ŒæŠŠå®ƒä»¬æ‹¼æ¥åœ¨ä¸€èµ·ï¼š</p>
<ul>
<li>äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤º<code>01111111 11111111 11111111 11111111</code> è½¬æ¢ä¸ºåè¿›åˆ¶å°±æ˜¯<code>2147483647</code>ï¼Œä¹Ÿå°±æ˜¯intçš„æœ€å¤§å€¼ã€‚</li>
</ul>
<p>é‚£ä¹ˆæ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„æ¨å¯¼ï¼Œå„ä½èƒ½å¦è®¡ç®—å¾—åˆ°ä¸‹é¢çš„ç»“æœå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    buffer.put((<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">    buffer.put((<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">    buffer.put((<span class="type">byte</span>) <span class="number">1</span>);</span><br><span class="line">    buffer.put((<span class="type">byte</span>) -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    buffer.flip();   <span class="comment">//ç¿»è½¬ä¸€ä¸‹</span></span><br><span class="line">    System.out.println(buffer.getInt());  <span class="comment">//ä»¥intå½¢å¼è·å–ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€æ¬¡æ€§è·å–4ä¸ªå­—èŠ‚</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç»è¿‡ä¸Šé¢çš„è®¡ç®—ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯ï¼š</p>
<ul>
<li>ä¸Šé¢çš„æ•°æ®ä»¥äºŒè¿›åˆ¶è¡¥ç çš„å½¢å¼è¡¨ç¤ºä¸ºï¼š<code>00000000 00000000 00000001 11111111</code></li>
<li>å°†å…¶è½¬æ¢ä¸ºåè¿›åˆ¶é‚£ä¹ˆå°±æ˜¯ï¼š256 + 255 = 511</li>
</ul>
<p>å¥½å§ï¼Œå†æ¥ä¸ªé­”é¬¼é—®é¢˜ï¼ŒæŠŠç¬¬ä¸€ä¸ªæ¢æˆ1å‘¢ï¼š<code>10000000 00000000 00000001 11111111</code>ï¼Œè‡ªå·±ç®—ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹CharBufferï¼Œè¿™ç§ç¼“å†²åŒºå®é™…ä¸Šä¹Ÿæ˜¯ä¿å­˜ä¸€å¤§å †charç±»å‹çš„æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">CharBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> CharBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    buffer.put(<span class="string">"lbwnb"</span>);  <span class="comment">//é™¤äº†å¯ä»¥ç›´æ¥ä¸¢charä¹‹å¤–ï¼Œå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§ä¸¢è¿›å…¥</span></span><br><span class="line">    System.out.println(Arrays.toString(buffer.array()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä½†æ˜¯æ­£æ˜¯å¾—ç›Šäºcharæ•°ç»„ï¼Œå®ƒåŒ…å«äº†å¾ˆå¤šçš„å­—ç¬¦ä¸²æ“ä½œï¼Œå¯ä»¥ä¸€æ¬¡æ€§å­˜æ”¾ä¸€æ•´ä¸ªå­—ç¬¦ä¸²ã€‚æˆ‘ä»¬ç”šè‡³è¿˜å¯ä»¥å°†å…¶å½“åšä¸€ä¸ªStringæ¥è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">CharBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> CharBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    buffer.put(<span class="string">"lbwnb"</span>);</span><br><span class="line">    buffer.append(<span class="string">"!"</span>);   <span class="comment">//å¯ä»¥åƒStringBuilderä¸€æ ·ä½¿ç”¨appendæ¥ç»§ç»­æ·»åŠ æ•°æ®</span></span><br><span class="line">  </span><br><span class="line">  	System.out.println(<span class="string">"å‰©ä½™å®¹é‡ï¼š"</span>+buffer.remaining());  <span class="comment">//å·²ç»ç”¨äº†6ä¸ªå­—ç¬¦äº†</span></span><br><span class="line"></span><br><span class="line">    buffer.flip();</span><br><span class="line">    System.out.println(<span class="string">"æ•´ä¸ªå­—ç¬¦ä¸²ä¸ºï¼š"</span>+buffer);   <span class="comment">//ç›´æ¥å°†å†…å®¹è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">    System.out.println(<span class="string">"ç¬¬3ä¸ªå­—ç¬¦æ˜¯ï¼š"</span>+buffer.charAt(<span class="number">2</span>));  <span class="comment">//ç›´æ¥åƒStringä¸€æ ·charAt</span></span><br><span class="line"></span><br><span class="line">    buffer   <span class="comment">//ä¹Ÿå¯ä»¥è½¬æ¢ä¸ºIntStreamè¿›è¡Œæ“ä½œ</span></span><br><span class="line">            .chars()</span><br><span class="line">            .filter(i -&gt; i &lt; <span class="string">'l'</span>)</span><br><span class="line">            .forEach(i -&gt; System.out.print((<span class="type">char</span>) i));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å½“ç„¶é™¤äº†ä¸€äº›å¸¸è§„æ“ä½œä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°åˆ›å»ºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//å¯ä»¥ç›´æ¥ä½¿ç”¨wrapåŒ…è£…ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯æ³¨æ„ï¼ŒåŒ…è£…å‡ºæ¥ä¹‹åæ˜¯åªè¯»çš„</span></span><br><span class="line">    <span class="type">CharBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> CharBuffer.wrap(<span class="string">"æ”¶è—ç­‰äºå­¦ä¼š~"</span>);</span><br><span class="line">    System.out.println(buffer);</span><br><span class="line"></span><br><span class="line">    buffer.put(<span class="string">"111"</span>);  <span class="comment">//è¿™é‡Œå°è¯•è¿›è¡Œä¸€ä¸‹å†™æ“ä½œ</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç»“æœä¹Ÿæ˜¯æˆ‘ä»¬é¢„æ–™ä¸­çš„ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kvvus5tej219a06c0u1.jpg" alt="image-20220424161925938"></p>
<p>å¯¹äºè¿™ä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„ç¼“å†²åŒºï¼Œæˆ‘ä»¬å°±æš‚æ—¶è®²è§£åˆ°è¿™é‡Œã€‚</p>
<h3 id="ç›´æ¥ç¼“å†²åŒº"><a href="#ç›´æ¥ç¼“å†²åŒº" class="headerlink" title="ç›´æ¥ç¼“å†²åŒº"></a>ç›´æ¥ç¼“å†²åŒº</h3><p><strong>æ³¨æ„ï¼š</strong>æ¨èå­¦ä¹ å®ŒæˆJVMç¯‡å†æ¥å­¦ä¹ è¿™ä¸€éƒ¨åˆ†ã€‚</p>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç›´æ¥ç¼“å†²åŒºï¼Œæˆ‘ä»¬å‰é¢ä¸€ç›´ä½¿ç”¨çš„éƒ½æ˜¯å †ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯è¯´å®é™…ä¸Šæ•°æ®æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­çš„ï¼Œå¦‚æœä½ å·²ç»å®Œæˆäº†JVMç¯‡çš„å­¦ä¹ ï¼Œä¸€å®šçŸ¥é“å®é™…ä¸Šå ç”¨çš„æ˜¯å †å†…å­˜ï¼Œè€Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªç›´æ¥ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯ç”³è¯·å †å¤–å†…å­˜è¿›è¡Œæ•°æ®ä¿å­˜ï¼Œé‡‡ç”¨æ“ä½œç³»ç»Ÿæœ¬åœ°çš„IOï¼Œç›¸æ¯”å †ç¼“å†²åŒºä¼šå¿«ä¸€äº›ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆä½¿ç”¨ç›´æ¥ç¼“å†²åŒºå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>allocateDirect</code>æ–¹æ³•æ¥åˆ›å»ºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//è¿™é‡Œæˆ‘ä»¬ç”³è¯·ä¸€ä¸ªç›´æ¥ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">10</span>);</span><br><span class="line">  	<span class="comment">//ä½¿ç”¨æ–¹å¼åŸºæœ¬å’Œä¹‹å‰æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">    buffer.put((<span class="type">byte</span>) <span class="number">66</span>);</span><br><span class="line">    buffer.flip();</span><br><span class="line">    System.out.println(buffer.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ª<code>allocateDirect</code>æ–¹æ³•æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªç›´æ¥ç¼“å†²åŒºçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title function_">allocateDirect</span><span class="params">(<span class="type">int</span> capacity)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectByteBuffer</span>(capacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™ä¸ªæ–¹æ³•ç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„DirectByteBufferå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»åˆæ˜¯æ€ä¹ˆè¿›è¡Œåˆ›å»ºçš„å‘¢ï¼Ÿ</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1kw7cc7vnj223y0f80v0.jpg" alt="image-20220424163028578"></p>
<p>å¯ä»¥çœ‹åˆ°å®ƒå¹¶ä¸æ˜¯ç›´æ¥ç»§æ‰¿è‡ªByteBufferï¼Œè€Œæ˜¯MappedByteBufferï¼Œå¹¶ä¸”å®ç°äº†æ¥å£DirectBufferï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªæ¥å£ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DirectBuffer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">address</span><span class="params">()</span>;   <span class="comment">//è·å–å†…å­˜åœ°å€</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">attachment</span><span class="params">()</span>;   <span class="comment">//é™„åŠ å¯¹è±¡ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯æŸäº›æƒ…å†µä¸‹å†…å­˜ä¸è¢«é‡Šæ”¾ï¼Œæˆ‘ä»¬åé¢ç»†è°ˆ</span></span><br><span class="line">    <span class="keyword">public</span> Cleaner <span class="title function_">cleaner</span><span class="params">()</span>;   <span class="comment">//å†…å­˜æ¸…ç†ç±»</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MappedByteBuffer</span> <span class="keyword">extends</span> <span class="title class_">ByteBuffer</span> {</span><br><span class="line">  	<span class="comment">//è¿™ä¸‰ä¸ªæ–¹æ³•ç›®å‰æš‚æ—¶ç”¨ä¸åˆ°ï¼Œåé¢æ–‡ä»¶å†è¯´</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> MappedByteBuffer <span class="title function_">load</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isLoaded</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> MappedByteBuffer <span class="title function_">force</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹DirectByteBufferç±»çš„æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠŠUnsafeç±»å–å‡ºæ¥</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Bits.unsafe();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å†…å­˜ä¸­ç›´æ¥åˆ›å»ºçš„å†…å­˜ç©ºé—´åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">arrayBaseOffset</span> <span class="operator">=</span> (<span class="type">long</span>)unsafe.arrayBaseOffset(<span class="type">byte</span>[].class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦å…·æœ‰éå¯¹é½è®¿é—®èƒ½åŠ›ï¼Œæ ¹æ®CPUæ¶æ„è€Œå®šï¼Œintelã€AMDã€AppleSilicon éƒ½æ˜¯æ”¯æŒçš„</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">unaligned</span> <span class="operator">=</span> Bits.unaligned();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥ç¼“å†²åŒºçš„å†…å­˜åœ°å€ï¼Œä¸ºäº†æå‡é€Ÿåº¦å°±æ”¾åˆ°Bufferç±»ä¸­å»äº†</span></span><br><span class="line"><span class="comment">//    protected long address;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™„åŠ å¯¹è±¡ï¼Œä¸€ä¼šæœ‰å¤§ä½œç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object att;</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DirectByteBuffer(<span class="type">int</span> cap) {                   <span class="comment">// package-private</span></span><br><span class="line">    <span class="built_in">super</span>(-<span class="number">1</span>, <span class="number">0</span>, cap, cap);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">pa</span> <span class="operator">=</span> VM.isDirectMemoryPageAligned();   <span class="comment">//æ˜¯å¦ç›´æ¥å†…å­˜åˆ†é¡µå¯¹é½ï¼Œéœ€è¦é¢å¤–è®¡ç®—</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ps</span> <span class="operator">=</span> Bits.pageSize();</span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> Math.max(<span class="number">1L</span>, (<span class="type">long</span>)cap + (pa ? ps : <span class="number">0</span>));   <span class="comment">//è®¡ç®—å‡ºæœ€ç»ˆéœ€è¦ç”³è¯·çš„å¤§å°</span></span><br><span class="line">  	<span class="comment">//åˆ¤æ–­å †å¤–å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¤Ÿçš„è¯å°±ä½œä¸ºä¿ç•™å†…å­˜</span></span><br><span class="line">    Bits.reserveMemory(size, cap);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      	<span class="comment">//é€šè¿‡Unsafeç”³è¯·å†…å­˜ç©ºé—´ï¼Œå¹¶å¾—åˆ°å†…å­˜åœ°å€</span></span><br><span class="line">        base = unsafe.allocateMemory(size);</span><br><span class="line">    } <span class="keyword">catch</span> (OutOfMemoryError x) {</span><br><span class="line">      	<span class="comment">//ç”³è¯·å¤±è´¥å°±å–æ¶ˆä¸€å¼€å§‹çš„ä¿ç•™å†…å­˜</span></span><br><span class="line">        Bits.unreserveMemory(size, cap);</span><br><span class="line">        <span class="keyword">throw</span> x;</span><br><span class="line">    }</span><br><span class="line">  	<span class="comment">//æ‰¹é‡å°†ç”³è¯·åˆ°çš„è¿™ä¸€æ®µå†…å­˜æ¯ä¸ªå­—èŠ‚éƒ½è®¾å®šä¸º0</span></span><br><span class="line">    unsafe.setMemory(base, size, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) {</span><br><span class="line">        <span class="comment">// Round up to page boundary</span></span><br><span class="line">        address = base + ps - (base &amp; (ps - <span class="number">1</span>));</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      	<span class="comment">//å°†addresså˜é‡ï¼ˆåœ¨Bufferä¸­å®šä¹‰ï¼‰è®¾å®šä¸ºbaseçš„åœ°å€</span></span><br><span class="line">        address = base;</span><br><span class="line">    }</span><br><span class="line">  	<span class="comment">//åˆ›å»ºä¸€ä¸ªé’ˆå¯¹äºæ­¤ç¼“å†²åŒºçš„Cleanerï¼Œç”±äºæ˜¯å †å¤–å†…å­˜ï¼Œæ‰€ä»¥ç°åœ¨ç”±å®ƒæ¥è¿›è¡Œå†…å­˜æ¸…ç†</span></span><br><span class="line">    cleaner = Cleaner.create(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">Deallocator</span>(base, size, cap));</span><br><span class="line">    att = <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæ˜¯ç›´æ¥é€šè¿‡Unsafeç±»æ¥ç”³è¯·è¶³å¤Ÿçš„å †å¤–å†…å­˜ä¿å­˜æ•°æ®ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ä¸ä½¿ç”¨æ­¤ç¼“å†²åŒºæ—¶ï¼Œå†…å­˜ä¼šè¢«å¦‚ä½•æ¸…ç†å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªCleanerï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cleaner</span> <span class="keyword">extends</span> <span class="title class_">PhantomReference</span>&lt;Object&gt;{ <span class="comment">//ç»§æ‰¿è‡ªé¬¼å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤å¯¹è±¡ä¼šå­˜æ”¾ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å¼•ç”¨çš„å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼•ç”¨é˜Ÿåˆ—ï¼ŒPhantomReferenceæ„é€ æ–¹æ³•éœ€è¦</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; dummyQueue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">  	</span><br><span class="line">  	<span class="comment">//æ‰§è¡Œæ¸…ç†çš„å…·ä½“æµç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable thunk;</span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">static</span> <span class="keyword">private</span> <span class="type">Cleaner</span> <span class="variable">first</span> <span class="operator">=</span> <span class="literal">null</span>;  <span class="comment">//CleaneråŒå‘é“¾è¡¨ï¼Œæ¯åˆ›å»ºä¸€ä¸ªCleanerå¯¹è±¡éƒ½ä¼šæ·»åŠ ä¸€ä¸ªç»“ç‚¹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Cleaner</span></span><br><span class="line">        <span class="variable">next</span> <span class="operator">=</span> <span class="literal">null</span>,</span><br><span class="line">        prev = <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Cleaner <span class="title function_">add</span><span class="params">(Cleaner cl)</span> {   <span class="comment">//æ·»åŠ æ“ä½œä¼šè®©æ–°æ¥çš„å˜æˆæ–°çš„å¤´ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>) {</span><br><span class="line">            cl.next = first;</span><br><span class="line">            first.prev = cl;</span><br><span class="line">        }</span><br><span class="line">        first = cl;</span><br><span class="line">        <span class="keyword">return</span> cl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//å¯ä»¥çœ‹åˆ°åˆ›å»ºé¬¼å¼•ç”¨çš„å¯¹è±¡å°±æ˜¯ä¼ è¿›çš„ç¼“å†²åŒºå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Cleaner</span><span class="params">(Object referent, Runnable thunk)</span> {</span><br><span class="line">        <span class="built_in">super</span>(referent, dummyQueue);</span><br><span class="line">      	<span class="comment">//æ¸…ç†æµç¨‹å®é™…ä¸Šæ˜¯å¤–é¢çš„Deallocator</span></span><br><span class="line">        <span class="built_in">this</span>.thunk = thunk;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">   	<span class="comment">//é€šè¿‡æ­¤æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„Cleaner</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Cleaner <span class="title function_">create</span><span class="params">(Object ob, Runnable thunk)</span> {</span><br><span class="line">        <span class="keyword">if</span> (thunk == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> add(<span class="keyword">new</span> <span class="title class_">Cleaner</span>(ob, thunk));   <span class="comment">//è°ƒç”¨addæ–¹æ³•å°†Cleaneræ·»åŠ åˆ°é˜Ÿåˆ—</span></span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">//æ¸…ç†æ“ä½œ</span></span><br><span class="line">  	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (!remove(<span class="built_in">this</span>))</span><br><span class="line">            <span class="keyword">return</span>;    <span class="comment">//è¿›è¡Œæ¸…ç†æ“ä½œæ—¶ä¼šä»åŒå‘é˜Ÿåˆ—ä¸­ç§»é™¤å½“å‰Cleanerï¼Œfalseè¯´æ˜å·²ç»ç§»é™¤è¿‡äº†ï¼Œç›´æ¥return</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            thunk.run();   <span class="comment">//è¿™é‡Œå°±æ˜¯ç›´æ¥æ‰§è¡Œå…·ä½“æ¸…ç†æµç¨‹</span></span><br><span class="line">        } <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable x) {</span><br><span class="line">            ...</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å…·ä½“çš„æ¸…ç†ç¨‹åºåœ¨åšäº›ä»€ä¹ˆï¼ŒDeallocatoræ˜¯åœ¨ç›´æ¥ç¼“å†²åŒºä¸­å£°æ˜çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Deallocator</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> address;   <span class="comment">//å†…å­˜åœ°å€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> size;    <span class="comment">//å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;   <span class="comment">//ç”³è¯·çš„å®¹é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Deallocator</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> size, <span class="type">int</span> capacity)</span> {</span><br><span class="line">        <span class="keyword">assert</span> (address != <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {   <span class="comment">//å…·ä½“çš„æ¸…ç†æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (address == <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// Paranoia</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        unsafe.freeMemory(address);   <span class="comment">//è¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨äº†Unsafeè¿›è¡Œå†…å­˜é‡Šæ”¾æ“ä½œ</span></span><br><span class="line">        address = <span class="number">0</span>;   <span class="comment">//å†…å­˜åœ°å€æ”¹ä¸º0ï¼ŒNULL</span></span><br><span class="line">        Bits.unreserveMemory(size, capacity);   <span class="comment">//å–æ¶ˆä¸€å¼€å§‹çš„ä¿ç•™å†…å­˜</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ˜ç¡®åœ¨æ¸…ç†çš„æ—¶å€™å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨Unsafeç±»è¿›è¡Œå†…å­˜é‡Šæ”¾æ“ä½œï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªæ¸…ç†æ“ä½œå…·ä½“æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¿›è¡Œçš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ï¼Œå¦‚æœæ˜¯æ™®é€šçš„å †ç¼“å†²åŒºï¼Œç”±äºä½¿ç”¨çš„æ•°ç»„ï¼Œé‚£ä¹ˆä¸€æ—¦æ­¤å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨æ—¶ï¼Œå°±éšæ—¶éƒ½ä¼šè¢«GCç»™å›æ”¶æ‰ï¼Œä½†æ˜¯ç°åœ¨æ˜¯å †å¤–å†…å­˜ï¼Œåªèƒ½æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œå†…å­˜å›æ”¶ï¼Œé‚£ä¹ˆå½“DirectByteBufferä¹Ÿå¤±å»å¼•ç”¨æ—¶ï¼Œä¼šä¸ä¼šè§¦å‘å†…å­˜å›æ”¶å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œè¿˜è®°å¾—æˆ‘ä»¬åˆšåˆšçœ‹åˆ°Cleaneræ˜¯PhantomReferenceçš„å­ç±»å—ï¼Œè€ŒDirectByteBufferæ˜¯è¢«é¬¼å¼•ç”¨çš„å¯¹è±¡ï¼Œè€Œå…·ä½“çš„æ¸…ç†æ“ä½œæ˜¯Cleanerç±»çš„cleanæ–¹æ³•ï¼Œè«éè¿™ä¸¤è€…æœ‰ä»€ä¹ˆè”ç³»å—ï¼Ÿ</p>
<p>ä½ åˆ«è¯´ï¼Œè¿˜çœŸæœ‰ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹åˆ°PhantomReferenceçš„çˆ¶ç±»Referenceï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™æ ·ä¸€ä¸ªç±»ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReferenceHandler</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">  ...</span><br><span class="line">	<span class="keyword">static</span> {</span><br><span class="line">            <span class="comment">// é¢„åŠ è½½å¹¶åˆå§‹åŒ– InterruptedException å’Œ Cleaner ç±»</span></span><br><span class="line">        		<span class="comment">// ä»¥é¿å…å‡ºç°åœ¨å¾ªç¯è¿è¡Œè¿‡ç¨‹ä¸­æ—¶ç”±äºå†…å­˜ä¸è¶³è€Œæ— æ³•åŠ è½½</span></span><br><span class="line">            ensureClassInitialized(InterruptedException.class);</span><br><span class="line">            ensureClassInitialized(Cleaner.class);</span><br><span class="line">    }</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            tryHandlePending(<span class="literal">true</span>);   <span class="comment">//è¿™é‡Œæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯è°ƒç”¨tryHandlePendingæ–¹æ³•</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T referent;         <span class="comment">/* ä¼šè¢«GCå›æ”¶çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»™è¿‡æ¥è¢«å¼•ç”¨çš„å¯¹è±¡ */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> ReferenceQueue&lt;? <span class="built_in">super</span> T&gt; queue;  <span class="comment">//å¼•ç”¨é˜Ÿåˆ—ï¼Œå¯ä»¥å’Œä¸‹é¢çš„nextæ­é…ä½¿ç”¨ï¼Œå½¢æˆé“¾è¡¨</span></span><br><span class="line"><span class="comment">//Referenceå¯¹è±¡ä¹Ÿæ˜¯ä¸€ä¸ªä¸€ä¸ªè¿èµ·æ¥çš„èŠ‚ç‚¹ï¼Œè¿™æ ·æ‰èƒ½æ”¾åˆ°ReferenceQueueä¸­å½¢æˆé“¾è¡¨</span></span><br><span class="line"><span class="keyword">volatile</span> Reference next;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å³å°†è¢«GCçš„å¼•ç”¨é“¾è¡¨</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">private</span> Reference&lt;T&gt; discovered;  <span class="comment">/* ç”±è™šæ‹Ÿæœºæ“ä½œ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pendingä¸discoveredä¸€èµ·æ„æˆäº†ä¸€ä¸ªpendingå•å‘é“¾è¡¨ï¼Œæ ‡è®°ä¸ºstaticç±»æ‰€æœ‰ï¼Œpendingä¸ºé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œdiscoveredä¸ºé“¾è¡¨å½“å‰</span></span><br><span class="line"><span class="comment">//ReferenceèŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯ç”±JVMæ„å»ºçš„ï¼Œå½“å¯¹è±¡é™¤äº†è¢«referenceå¼•ç”¨ä¹‹å¤–æ²¡æœ‰å…¶å®ƒå¼ºå¼•ç”¨äº†ï¼ŒJVMå°±ä¼šå°†æŒ‡å‘</span></span><br><span class="line"><span class="comment">//éœ€è¦å›æ”¶çš„å¯¹è±¡çš„Referenceå¯¹è±¡éƒ½æ”¾å…¥åˆ°è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¼šç”±ä¸‹é¢çš„ Reference Hander çº¿ç¨‹æ¥å¤„ç†ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Reference&lt;Object&gt; pending = <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> {    <span class="comment">//Referenceç±»çš„é™æ€ä»£ç å—</span></span><br><span class="line">    <span class="type">ThreadGroup</span> <span class="variable">tg</span> <span class="operator">=</span> Thread.currentThread().getThreadGroup();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">ThreadGroup</span> <span class="variable">tgn</span> <span class="operator">=</span> tg;</span><br><span class="line">         tgn != <span class="literal">null</span>;</span><br><span class="line">         tg = tgn, tgn = tg.getParent());</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceHandler</span>(tg, <span class="string">"Reference Handler"</span>);   <span class="comment">//åœ¨ä¸€å¼€å§‹çš„æ—¶å€™å°±ä¼šåˆ›å»º</span></span><br><span class="line">    handler.setPriority(Thread.MAX_PRIORITY);   <span class="comment">//ä»¥æœ€é«˜ä¼˜å…ˆçº§å¯åŠ¨</span></span><br><span class="line">    handler.setDaemon(<span class="literal">true</span>);    <span class="comment">//æ­¤çº¿ç¨‹ç›´æ¥ä½œä¸ºä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">    handler.start();    <span class="comment">//ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€å¼€å§‹çš„æ—¶å€™è¿™ä¸ªå®ˆæŠ¤çº¿ç¨‹å°±ä¼šå¯åŠ¨</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´Reference Handlerçº¿ç¨‹æ˜¯åœ¨ä¸€å¼€å§‹å°±å¯åŠ¨äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å…³æ³¨ç‚¹å¯ä»¥æ”¾åœ¨<code>tryHandlePending</code>æ–¹æ³•ä¸Šï¼Œçœ‹çœ‹è¿™ç©æ„åˆ°åº•åœ¨åšä¸ªå•¥ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">tryHandlePending</span><span class="params">(<span class="type">boolean</span> waitForNotify)</span> {</span><br><span class="line">    Reference&lt;Object&gt; r;</span><br><span class="line">    Cleaner c;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) {   <span class="comment">//åŠ é”åŠäº‹</span></span><br><span class="line">          	<span class="comment">//å½“Cleanerå¼•ç”¨çš„DirectByteBufferå¯¹è±¡å³å°†è¢«å›æ”¶æ—¶ï¼Œpendingä¼šå˜æˆæ­¤Cleanerå¯¹è±¡</span></span><br><span class="line">          	<span class="comment">//è¿™é‡Œåˆ¤æ–­åˆ°pendingä¸ä¸ºnullæ—¶å°±éœ€è¦å¤„ç†ä¸€ä¸‹å¯¹è±¡é”€æ¯äº†</span></span><br><span class="line">            <span class="keyword">if</span> (pending != <span class="literal">null</span>) {</span><br><span class="line">                r = pending;</span><br><span class="line">                <span class="comment">// 'instanceof' æœ‰æ—¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºï¼Œæ‰€ä»¥å°†rä»é“¾è¡¨ä¸­ç§»é™¤ä¹‹å‰å°±è¿›è¡Œç±»å‹åˆ¤æ–­</span></span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯Cleanerç±»å‹å°±ç»™åˆ°c</span></span><br><span class="line">                c = r <span class="keyword">instanceof</span> Cleaner ? (Cleaner) r : <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// å°†pendingæ›´æ–°ä¸ºé“¾è¡¨ä¸‹ä¸€ä¸ªå¾…å›æ”¶å…ƒç´ </span></span><br><span class="line">                pending = r.discovered;</span><br><span class="line">                r.discovered = <span class="literal">null</span>;   <span class="comment">//rä¸å†å¼•ç”¨ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">              	<span class="comment">//å¦åˆ™å°±è¿›å…¥ç­‰å¾…</span></span><br><span class="line">                <span class="keyword">if</span> (waitForNotify) {</span><br><span class="line">                    lock.wait();</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> waitForNotify;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (OutOfMemoryError x) {</span><br><span class="line">        Thread.<span class="keyword">yield</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException x) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå…ƒç´ æ˜¯Cleanerç±»å‹ï¼Œcåœ¨ä¸Šé¢å°±ä¼šè¢«èµ‹å€¼ï¼Œè¿™é‡Œå°±ä¼šæ‰§è¡Œå…¶cleanæ–¹æ³•ï¼ˆç ´æ¡ˆäº†ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="literal">null</span>) {</span><br><span class="line">        c.clean();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ReferenceQueue&lt;? <span class="built_in">super</span> Object&gt; q = r.queue;</span><br><span class="line">    <span class="keyword">if</span> (q != ReferenceQueue.NULL) q.enqueue(r);  <span class="comment">//è¿™ä¸ªæ˜¯å¼•ç”¨é˜Ÿåˆ—ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¹‹å‰åœ¨JVMç¯‡ä¸­è®²è§£çš„å…¥é˜Ÿæœºåˆ¶</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€šè¿‡å¯¹æºç çš„è§£è¯»ï¼Œæˆ‘ä»¬å°±äº†è§£äº†ç›´æ¥ç¼“å†²åŒºçš„å†…å­˜åŠ è½½é‡Šæ”¾æ•´ä¸ªæµç¨‹ã€‚å’Œå †ç¼“å†²åŒºä¸€æ ·ï¼Œå½“ç›´æ¥ç¼“å†²åŒºæ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æ—¶ï¼Œå°±æœ‰æœºä¼šè¢«GCæ­£å¸¸å›æ”¶æ‰å¹¶è‡ªåŠ¨é‡Šæ”¾ç”³è¯·çš„å†…å­˜ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹ç›´æ¥ç¼“å†²åŒºçš„è¯»å†™æ“ä½œæ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> ((unsafe.getByte(ix(nextGetIndex()))));   <span class="comment">//ç›´æ¥é€šè¿‡Unsafeç±»è¯»å–å¯¹åº”åœ°å€ä¸Šçš„byteæ•°æ®</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">ix</span><span class="params">(<span class="type">int</span> i)</span> {</span><br><span class="line">    <span class="keyword">return</span> address + ((<span class="type">long</span>)i &lt;&lt; <span class="number">0</span>);   <span class="comment">//ixç°åœ¨æ˜¯å†…å­˜åœ°å€å†åŠ ä¸Ši</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹å†™æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ByteBuffer <span class="title function_">put</span><span class="params">(<span class="type">byte</span> x)</span> {</span><br><span class="line">    unsafe.putByte(ix(nextPutIndex()), ((x)));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯è¯»å–è¿˜æ˜¯å†™å…¥æ“ä½œéƒ½æ˜¯é€šè¿‡Unsafeç±»æ“ä½œå¯¹åº”çš„å†…å­˜åœ°å€å®Œæˆçš„ã€‚</p>
<p>é‚£ä¹ˆå®ƒçš„å¤åˆ¶æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ByteBuffer <span class="title function_">duplicate</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectByteBuffer</span>(<span class="built_in">this</span>,</span><br><span class="line">                                          <span class="built_in">this</span>.markValue(),</span><br><span class="line">                                          <span class="built_in">this</span>.position(),</span><br><span class="line">                                          <span class="built_in">this</span>.limit(),</span><br><span class="line">                                          <span class="built_in">this</span>.capacity(),</span><br><span class="line">                                          <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DirectByteBuffer(DirectBuffer db,         <span class="comment">// è¿™é‡Œç»™çš„dbæ˜¯è¿›è¡Œå¤åˆ¶æ“ä½œçš„DirectByteBufferå¯¹è±¡</span></span><br><span class="line">                           <span class="type">int</span> mark, <span class="type">int</span> pos, <span class="type">int</span> lim, <span class="type">int</span> cap,</span><br><span class="line">                           <span class="type">int</span> off) {</span><br><span class="line">    <span class="built_in">super</span>(mark, pos, lim, cap);</span><br><span class="line">    address = db.address() + off;   <span class="comment">//ç›´æ¥ç»§ç»­ä½¿ç”¨ä¹‹å‰ç”³è¯·çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">    cleaner = <span class="literal">null</span>;   <span class="comment">//å› ä¸ºç”¨çš„æ˜¯ä¹‹å‰çš„å†…å­˜ç©ºé—´ï¼Œå·²ç»æœ‰å¯¹åº”çš„Cleaneräº†ï¼Œè¿™é‡Œä¸éœ€è¦å†æä¸€ä¸ª</span></span><br><span class="line">    att = db;   <span class="comment">//å°†attè®¾å®šä¸ºæ­¤å¯¹è±¡</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯è¿›è¡Œå¤åˆ¶æ“ä½œï¼Œé‚£ä¹ˆä¼šç›´æ¥ä¼šç»§ç»­ä½¿ç”¨æ‰§è¡Œå¤åˆ¶æ“ä½œçš„DirectByteBufferç”³è¯·çš„å†…å­˜ç©ºé—´ã€‚ä¸çŸ¥é“å„ä½æ˜¯å¦èƒ½å¤Ÿé©¬ä¸Šè”æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœæ‰§è¡Œå¤åˆ¶æ“ä½œçš„DirectByteBufferå¯¹è±¡å¤±å»äº†å¼ºå¼•ç”¨è¢«å›æ”¶ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘Cleanerå¹¶è¿›è¡Œå†…å­˜é‡Šæ”¾ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿™æ®µå†…å­˜ç©ºé—´å¯èƒ½å¤åˆ¶å‡ºæ¥çš„DirectByteBufferå¯¹è±¡è¿˜éœ€è¦ç»§ç»­ä½¿ç”¨ï¼Œè¿™æ—¶è‚¯å®šæ˜¯ä¸èƒ½è¿›è¡Œå›æ”¶çš„ï¼Œæ‰€ä»¥è¯´è¿™é‡Œä½¿ç”¨äº†attå˜é‡å°†ä¹‹å‰çš„DirectByteBufferå¯¹è±¡è¿›è¡Œå¼•ç”¨ï¼Œä»¥é˜²æ­¢å…¶å¤±å»å¼ºå¼•ç”¨è¢«åƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥åªè¦ä¸æ˜¯åŸæ¥çš„DirectByteBufferå¯¹è±¡å’Œå¤åˆ¶å‡ºæ¥çš„DirectByteBufferå¯¹è±¡éƒ½å¤±å»å¼ºå¼•ç”¨æ—¶ï¼Œå°±ä¸ä¼šå¯¼è‡´è¿™æ®µå†…å­˜ç©ºé—´è¢«å›æ”¶ã€‚</p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬ä¹‹å‰çš„æœªè§£ä¹‹è°œä¸ºå•¥æœ‰ä¸ª<code>att</code>ä¹Ÿå°±å¾—åˆ°ç­”æ¡ˆäº†ï¼Œæœ‰å…³ç›´æ¥ç¼“å†²åŒºçš„ä»‹ç»ï¼Œå°±åˆ°è¿™é‡Œä¸ºæ­¢ã€‚</p>
<hr>
<h2 id="é€šé“"><a href="#é€šé“" class="headerlink" title="é€šé“"></a>é€šé“</h2><p>å‰é¢æˆ‘ä»¬å­¦ä¹ äº†NIOçš„åŸºçŸ³â€”â€”ç¼“å†²åŒºï¼Œé‚£ä¹ˆç¼“å†²åŒºå…·ä½“ç”¨åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Œåœ¨æœ¬æ¿å—æˆ‘ä»¬å­¦ä¹ é€šé“ä¹‹åï¼Œç›¸ä¿¡å„ä½å°±èƒ½çŸ¥é“äº†ã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯é€šé“å‘¢ï¼Ÿ</p>
<p>åœ¨ä¼ ç»ŸIOä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯é€šè¿‡æµè¿›è¡Œä¼ è¾“ï¼Œæ•°æ®ä¼šæºæºä¸æ–­ä»æµä¸­ä¼ å‡ºï¼›è€Œåœ¨NIOä¸­ï¼Œæ•°æ®æ˜¯æ”¾åœ¨ç¼“å†²åŒºä¸­è¿›è¡Œç®¡ç†ï¼Œå†ä½¿ç”¨é€šé“å°†ç¼“å†²åŒºä¸­çš„æ•°æ®ä¼ è¾“åˆ°ç›®çš„åœ°ã€‚</p>
<h3 id="é€šé“æ¥å£å±‚æ¬¡"><a href="#é€šé“æ¥å£å±‚æ¬¡" class="headerlink" title="é€šé“æ¥å£å±‚æ¬¡"></a>é€šé“æ¥å£å±‚æ¬¡</h3><p>é€šé“çš„æ ¹åŸºæ¥å£æ˜¯<code>Channel</code>ï¼Œæ‰€ä»¥çš„æ´¾ç”Ÿæ¥å£å’Œç±»éƒ½æ˜¯ä»è¿™é‡Œå¼€å§‹çš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå®šä¹‰äº†å“ªäº›åŸºæœ¬åŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Channel</span> <span class="keyword">extends</span> <span class="title class_">Closeable</span> {</span><br><span class="line">    <span class="comment">//é€šé“æ˜¯å¦å¤„äºå¼€å¯çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOpen</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å› ä¸ºé€šé“å¼€å¯ä¹Ÿéœ€è¦å…³é—­ï¼Œæ‰€ä»¥å®ç°äº†Closeableæ¥å£ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ‡‚çš„éƒ½æ‡‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹å®ƒçš„ä¸€äº›å­æ¥å£ï¼Œé¦–å…ˆæ˜¯æœ€åŸºæœ¬çš„è¯»å†™æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReadableByteChannel</span> <span class="keyword">extends</span> <span class="title class_">Channel</span> {</span><br><span class="line">    <span class="comment">//å°†é€šé“ä¸­çš„æ•°æ®è¯»å–åˆ°ç»™å®šçš„ç¼“å†²åŒºä¸­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(ByteBuffer dst)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WritableByteChannel</span> <span class="keyword">extends</span> <span class="title class_">Channel</span> {</span><br><span class="line">  	<span class="comment">//å°†ç»™å®šç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°é€šé“ä¸­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">write</span><span class="params">(ByteBuffer src)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ‰äº†è¯»å†™åŠŸèƒ½åï¼Œæœ€åæ•´åˆä¸ºäº†ä¸€ä¸ªByteChannelæ¥å£ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ByteChannel</span> <span class="keyword">extends</span> <span class="title class_">ReadableByteChannel</span>, WritableByteChannel{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1lphvijimj223g0lajug.jpg" alt="image-20220425092355354"></p>
<p>åœ¨ByteChannelä¹‹ä¸‹ï¼Œè¿˜æœ‰æ›´å¤šçš„æ´¾ç”Ÿæ¥å£ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…è®¸ä¿ç•™positionå’Œæ›´æ”¹positionçš„é€šé“ï¼Œä»¥åŠå¯¹é€šé“è¿æ¥å®ä½“çš„ç›¸å…³æ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SeekableByteChannel</span> <span class="keyword">extends</span> <span class="title class_">ByteChannel</span> {</span><br><span class="line">   	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–å½“å‰çš„position</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">position</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¿®æ”¹å½“å‰çš„position</span></span><br><span class="line">    SeekableByteChannel <span class="title function_">position</span><span class="params">(<span class="type">long</span> newPosition)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å›æ­¤é€šé“è¿æ¥åˆ°çš„å®ä½“ï¼ˆæ¯”å¦‚æ–‡ä»¶ï¼‰çš„å½“å‰å¤§å°</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">size</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ­¤é€šé“è¿æ¥åˆ°çš„å®ä½“æˆªæ–­ï¼ˆæ¯”å¦‚æ–‡ä»¶ï¼Œæˆªæ–­ä¹‹åï¼Œæ–‡ä»¶åé¢ä¸€åŠå°±æ²¡äº†ï¼‰ä¸ºç»™å®šå¤§å°</span></span><br><span class="line">    SeekableByteChannel <span class="title function_">truncate</span><span class="params">(<span class="type">long</span> size)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹ï¼Œé™¤äº†è¯»å†™ä¹‹å¤–ï¼ŒChannelè¿˜å¯ä»¥å…·æœ‰å“åº”ä¸­æ–­çš„èƒ½åŠ›ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InterruptibleChannel</span> <span class="keyword">extends</span> <span class="title class_">Channel</span> {</span><br><span class="line">  	<span class="comment">//å½“å…¶ä»–çº¿ç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œåœ¨æ­¤é€šé“ä¸Šå¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹ä¼šç›´æ¥æŠ›å‡º AsynchronousCloseException å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™æ˜¯InterruptibleChannelçš„æŠ½è±¡å®ç°ï¼Œå®Œæˆäº†ä¸€éƒ¨åˆ†åŠŸèƒ½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractInterruptibleChannel</span> <span class="keyword">implements</span> <span class="title class_">Channel</span>, InterruptibleChannel {</span><br><span class="line">		<span class="comment">//åŠ é”å…³é—­æ“ä½œç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">closeLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">  	<span class="comment">//å½“å‰Channelçš„å¼€å¯çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">open</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractInterruptibleChannel</span><span class="params">()</span> { }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…³é—­æ“ä½œå®ç°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="keyword">synchronized</span> (closeLock) {   <span class="comment">//åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ­¤æ“ä½œï¼ŒåŠ é”</span></span><br><span class="line">            <span class="keyword">if</span> (!open)   <span class="comment">//å¦‚æœå·²ç»å…³é—­äº†ï¼Œé‚£ä¹ˆå°±ä¸ç”¨ç»§ç»­äº†</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            open = <span class="literal">false</span>;   <span class="comment">//å¼€å¯çŠ¶æ€å˜æˆfalse</span></span><br><span class="line">            implCloseChannel();   <span class="comment">//å¼€å§‹å…³é—­é€šé“</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯¥æ–¹æ³•ç”± close æ–¹æ³•è°ƒç”¨ï¼Œä»¥æ‰§è¡Œå…³é—­é€šé“çš„å…·ä½“æ“ä½œï¼Œä»…å½“é€šé“å°šæœªå…³é—­æ—¶æ‰è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä¸ä¼šå¤šæ¬¡è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">implCloseChannel</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isOpen</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> open;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€å§‹é˜»å¡ï¼ˆæœ‰å¯èƒ½ä¸€ç›´é˜»å¡ä¸‹å»ï¼‰æ“ä½œä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨æ­¤æ–¹æ³•è¿›è¡Œæ ‡è®°ï¼Œ</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> {</span><br><span class="line">        ...</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//é˜»å¡æ“ä½œç»“æŸä¹‹åï¼Œä¹Ÿéœ€è¦éœ€è¦è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä¸ºäº†é˜²æ­¢å¼‚å¸¸æƒ…å†µå¯¼è‡´æ­¤æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå»ºè®®æ”¾åœ¨finallyä¸­</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">end</span><span class="params">(<span class="type">boolean</span> completed)</span></span><br><span class="line">				...</span><br><span class="line">    }</span><br><span class="line">		</span><br><span class="line">		...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è€Œä¹‹åçš„ä¸€äº›å®ç°ç±»ï¼Œéƒ½æ˜¯åŸºäºè¿™äº›æ¥å£å®šä¹‰çš„æ–¹æ³•å»è¿›è¡Œå®ç°çš„ï¼Œæ¯”å¦‚FileChannelï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1muofbqbmj22520pe0yu.jpg" alt="image-20220426090845530"></p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¤§è‡´äº†è§£äº†ä¸€ä¸‹é€šé“ç›¸å…³çš„æ¥å£å®šä¹‰ï¼Œé‚£ä¹ˆæˆ‘æ¥çœ‹çœ‹å…·ä½“æ˜¯å¦‚ä½•å¦‚ä½•ä½¿ç”¨çš„ã€‚</p>
<p>æ¯”å¦‚ç°åœ¨æˆ‘ä»¬è¦å®ç°ä»è¾“å…¥æµä¸­è¯»å–æ•°æ®ç„¶åæ‰“å°å‡ºæ¥ï¼Œé‚£ä¹ˆä¹‹å‰ä¼ ç»ŸIOçš„å†™æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">  	<span class="comment">//æ•°ç»„åˆ›å»ºå¥½ï¼Œä¸€ä¼šç”¨æ¥å­˜æ”¾ä»æµä¸­è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line">  	<span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span>];</span><br><span class="line">  	<span class="comment">//ç›´æ¥ä½¿ç”¨è¾“å…¥æµ</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> System.in;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = in.read(data)) &gt;= <span class="number">0</span>) {  <span class="comment">//å°†è¾“å…¥æµä¸­çš„æ•°æ®ä¸€æ¬¡æ€§è¯»å–åˆ°æ•°ç»„ä¸­</span></span><br><span class="line">            System.out.print(<span class="string">"è¯»å–åˆ°ä¸€æ‰¹æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(data, <span class="number">0</span>, len));  <span class="comment">//è¯»å–äº†å¤šå°‘æ‰“å°å¤šå°‘</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è€Œç°åœ¨æˆ‘ä»¬ä½¿ç”¨é€šé“ä¹‹åï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">  	<span class="comment">//ç¼“å†²åŒºåˆ›å»ºå¥½ï¼Œä¸€ä¼šå°±é å®ƒæ¥ä¼ è¾“æ•°æ®</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">//å°†System.inä½œä¸ºè¾“å…¥æºï¼Œä¸€ä¼šChannelå°±å¯ä»¥ä»è¿™é‡Œè¯»å–æ•°æ®ï¼Œç„¶åé€šè¿‡ç¼“å†²åŒºè£…è½½ä¸€æ¬¡æ€§ä¼ é€’æ•°æ®</span></span><br><span class="line">    <span class="type">ReadableByteChannel</span> <span class="variable">readChannel</span> <span class="operator">=</span> Channels.newChannel(System.in);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        <span class="comment">//å°†é€šé“ä¸­çš„æ•°æ®å†™åˆ°ç¼“å†²åŒºä¸­ï¼Œç¼“å†²åŒºæœ€å¤šä¸€æ¬¡è£…10ä¸ª</span></span><br><span class="line">        readChannel.read(buffer);</span><br><span class="line">        <span class="comment">//å†™å…¥æ“ä½œç»“æŸä¹‹åï¼Œéœ€è¦è¿›è¡Œç¿»è½¬ï¼Œä»¥ä¾¿æ¥ä¸‹æ¥çš„è¯»å–æ“ä½œ</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="comment">//æœ€åè½¬æ¢æˆStringæ‰“å°å‡ºæ¥åº·åº·</span></span><br><span class="line">        System.out.println(<span class="string">"è¯»å–åˆ°ä¸€æ‰¹æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">        <span class="comment">//å›åˆ°æœ€å¼€å§‹çš„çŠ¶æ€</span></span><br><span class="line">        buffer.clear();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¹ä¸€çœ‹ï¼Œå¥½åƒæ„Ÿè§‰ä¹Ÿæ²¡å•¥åŒºåˆ«ï¼Œä¸å°±æ˜¯æŠŠæ•°ç»„æ¢æˆç¼“å†²åŒºäº†å—ï¼Œæ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ•°æ®ä¹Ÿæ˜¯ä»Channelä¸­è¯»å–å¾—åˆ°ï¼Œå¹¶ä¸”é€šè¿‡ç¼“å†²åŒºè¿›è¡Œæ•°æ®è£…è½½ç„¶åå¾—åˆ°ç»“æœï¼Œä½†æ˜¯ï¼ŒChannelä¸åƒæµé‚£æ ·æ˜¯å•å‘çš„ï¼Œå®ƒå°±åƒå®ƒçš„åå­—ä¸€æ ·ï¼Œä¸€ä¸ªé€šé“å¯ä»¥ä»ä¸€ç«¯èµ°åˆ°å¦ä¸€ç«¯ï¼Œä¹Ÿå¯ä»¥ä»å¦ä¸€ç«¯èµ°åˆ°è¿™ä¸€ç«¯ï¼Œæˆ‘ä»¬åé¢è¿›è¡Œä»‹ç»ã€‚</p>
<h3 id="æ–‡ä»¶ä¼ è¾“FileChannel"><a href="#æ–‡ä»¶ä¼ è¾“FileChannel" class="headerlink" title="æ–‡ä»¶ä¼ è¾“FileChannel"></a>æ–‡ä»¶ä¼ è¾“FileChannel</h3><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†é€šé“çš„åŸºæœ¬æƒ…å†µï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥å°è¯•å®ç°ä¸€ä¸‹æ–‡ä»¶çš„è¯»å–å’Œå†™å…¥ï¼Œåœ¨ä¼ ç»ŸIOä¸­ï¼Œæ–‡ä»¶çš„å†™å…¥å’Œè¾“å‡ºéƒ½æ˜¯ä¾é FileOutputStreamå’ŒFileInputStreamæ¥å®Œæˆçš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"test.txt"</span>);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"test.txt"</span>)){</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">"ä¼å…µä¸€å·å¢æœ¬ä¼Ÿå‡†å¤‡å°±ç»ªï¼"</span>;</span><br><span class="line">        out.write(data.getBytes());   <span class="comment">//å‘æ–‡ä»¶çš„è¾“å‡ºæµä¸­å†™å…¥æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æŠŠæ•°æ®å†™åˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">        out.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[in.available()];</span><br><span class="line">        in.read(bytes);    <span class="comment">//ä»æ–‡ä»¶çš„è¾“å…¥æµä¸­è¯»å–æ–‡ä»¶çš„ä¿¡æ¯</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è€Œç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ä¸€ä¸ªFileChannelå°±å¯ä»¥å®Œæˆè¿™ä¸¤è€…çš„æ“ä½œï¼Œè·å–æ–‡ä»¶é€šé“çš„æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//1. ç›´æ¥é€šè¿‡è¾“å…¥æˆ–è¾“å‡ºæµè·å–å¯¹åº”çš„é€šé“</span></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"test.txt"</span>);</span><br><span class="line">    <span class="comment">//ä½†æ˜¯è¿™é‡Œçš„é€šé“åªæ”¯æŒè¯»å–æˆ–æ˜¯å†™å…¥æ“ä½œ</span></span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> in.getChannel();</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º128çš„ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">    <span class="comment">//ä»é€šé“ä¸­å°†æ•°æ®è¯»å–åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">    channel.read(buffer);</span><br><span class="line">    <span class="comment">//ç¿»è½¬ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥è¦è¯»å–äº†</span></span><br><span class="line">    buffer.flip();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°é€šè¿‡è¾“å…¥æµè·å–çš„æ–‡ä»¶é€šé“è¯»å–æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯å†™å…¥æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//1. ç›´æ¥é€šè¿‡è¾“å…¥æˆ–è¾“å‡ºæµè·å–å¯¹åº”çš„é€šé“</span></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"test.txt"</span>);</span><br><span class="line">    <span class="comment">//ä½†æ˜¯è¿™é‡Œçš„é€šé“åªæ”¯æŒè¯»å–æˆ–æ˜¯å†™å…¥æ“ä½œ</span></span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> in.getChannel();</span><br><span class="line">    <span class="comment">//å°è¯•å†™å…¥ä¸€ä¸‹</span></span><br><span class="line">    channel.write(ByteBuffer.wrap(<span class="string">"ä¼å…µä¸€å·å¢æœ¬ä¼Ÿå‡†å¤‡å°±ç»ªï¼"</span>.getBytes()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1mx9in88jj21l403mgmo.jpg" alt="image-20220426103818019"></p>
<p>ç›´æ¥æŠ¥é”™ï¼Œè¯´æ˜åªæ”¯æŒè¯»å–æ“ä½œï¼Œé‚£ä¹ˆè¾“å‡ºæµå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//1. ç›´æ¥é€šè¿‡è¾“å…¥æˆ–è¾“å‡ºæµè·å–å¯¹åº”çš„é€šé“</span></span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"test.txt"</span>);</span><br><span class="line">    <span class="comment">//ä½†æ˜¯è¿™é‡Œçš„é€šé“åªæ”¯æŒè¯»å–æˆ–æ˜¯å†™å…¥æ“ä½œ</span></span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> out.getChannel();</span><br><span class="line">    <span class="comment">//å°è¯•å†™å…¥ä¸€ä¸‹</span></span><br><span class="line">    channel.write(ByteBuffer.wrap(<span class="string">"ä¼å…µä¸€å·å¢æœ¬ä¼Ÿå‡†å¤‡å°±ç»ªï¼"</span>.getBytes()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°èƒ½å¤Ÿæ­£å¸¸è¿›è¡Œå†™å…¥ï¼Œä½†æ˜¯è¯»å–å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//1. ç›´æ¥é€šè¿‡è¾“å…¥æˆ–è¾“å‡ºæµè·å–å¯¹åº”çš„é€šé“</span></span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"test.txt"</span>);</span><br><span class="line">    <span class="comment">//ä½†æ˜¯è¿™é‡Œçš„é€šé“åªæ”¯æŒè¯»å–æˆ–æ˜¯å†™å…¥æ“ä½œ</span></span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> out.getChannel();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">    <span class="comment">//ä»é€šé“ä¸­å°†æ•°æ®è¯»å–åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">    channel.read(buffer);</span><br><span class="line">    <span class="comment">//ç¿»è½¬ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥è¦è¯»å–äº†</span></span><br><span class="line">    buffer.flip();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1mxbknxa4j21gg03ijsd.jpg" alt="image-20220426104016649"></p>
<p>å¯ä»¥çœ‹åˆ°è¾“å‡ºæµç”Ÿæˆçš„Channelåˆä¸æ”¯æŒè¯»å–ï¼Œæ‰€ä»¥è¯´æœ¬è´¨ä¸Šè¿˜æ˜¯ä¿æŒç€è¾“å…¥è¾“å‡ºæµçš„ç‰¹æ€§ï¼Œä½†æ˜¯ä¹‹å‰ä¸æ˜¯è¯´Channelåˆå¯ä»¥è¾“å…¥åˆå¯ä»¥è¾“å‡ºå—ï¼Ÿè¿™é‡Œæˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬äºŒç§æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RandomAccessFileèƒ½å¤Ÿæ”¯æŒæ–‡ä»¶çš„éšæœºè®¿é—®ï¼Œå¹¶ä¸”å®ç°äº†æ•°æ®æµ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomAccessFile</span> <span class="keyword">implements</span> <span class="title class_">DataOutput</span>, DataInput, Closeable {</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡RandomAccessFileæ¥åˆ›å»ºé€šé“ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      é€šè¿‡RandomAccessFileè¿›è¡Œåˆ›å»ºï¼Œæ³¨æ„åé¢çš„modeæœ‰å‡ ç§ï¼š</span></span><br><span class="line"><span class="comment">      r        ä»¥åªè¯»çš„æ–¹å¼ä½¿ç”¨</span></span><br><span class="line"><span class="comment">      rw   è¯»æ“ä½œå’Œå†™æ“ä½œéƒ½å¯ä»¥</span></span><br><span class="line"><span class="comment">      rws  æ¯å½“è¿›è¡Œå†™æ“ä½œï¼ŒåŒæ­¥çš„åˆ·æ–°åˆ°ç£ç›˜ï¼Œåˆ·æ–°å†…å®¹å’Œå…ƒæ•°æ®</span></span><br><span class="line"><span class="comment">      rwd  æ¯å½“è¿›è¡Œå†™æ“ä½œï¼ŒåŒæ­¥çš„åˆ·æ–°åˆ°ç£ç›˜ï¼Œåˆ·æ–°å†…å®¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">try</span>(<span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">""</span>)){</span><br><span class="line">				</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹å®ƒçš„è¯»å†™æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      é€šè¿‡RandomAccessFileè¿›è¡Œåˆ›å»ºï¼Œæ³¨æ„åé¢çš„modeæœ‰å‡ ç§ï¼š</span></span><br><span class="line"><span class="comment">      r        ä»¥åªè¯»çš„æ–¹å¼ä½¿ç”¨</span></span><br><span class="line"><span class="comment">      rw   è¯»æ“ä½œå’Œå†™æ“ä½œéƒ½å¯ä»¥</span></span><br><span class="line"><span class="comment">      rws  æ¯å½“è¿›è¡Œå†™æ“ä½œï¼ŒåŒæ­¥çš„åˆ·æ–°åˆ°ç£ç›˜ï¼Œåˆ·æ–°å†…å®¹å’Œå…ƒæ•°æ®</span></span><br><span class="line"><span class="comment">      rwd  æ¯å½“è¿›è¡Œå†™æ“ä½œï¼ŒåŒæ­¥çš„åˆ·æ–°åˆ°ç£ç›˜ï¼Œåˆ·æ–°å†…å®¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">try</span>(<span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">"rw"</span>);  <span class="comment">//è¿™é‡Œè®¾å®šä¸ºæ”¯æŒè¯»å†™ï¼Œè¿™æ ·åˆ›å»ºçš„é€šé“æ‰èƒ½å…·æœ‰è¿™äº›åŠŸèƒ½</span></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> f.getChannel()){   <span class="comment">//é€šè¿‡RandomAccessFileåˆ›å»ºä¸€ä¸ªé€šé“</span></span><br><span class="line">        channel.write(ByteBuffer.wrap(<span class="string">"ä¼å…µäºŒå·é©¬é£é£å‡†å¤‡å°±ç»ªï¼"</span>.getBytes()));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"å†™æ“ä½œå®Œæˆä¹‹åæ–‡ä»¶è®¿é—®ä½ç½®ï¼š"</span>+channel.position());  <span class="comment">//æ³¨æ„è¯»å–ä¹Ÿæ˜¯ä»ç°åœ¨çš„ä½ç½®å¼€å§‹</span></span><br><span class="line">        channel.position(<span class="number">0</span>);  <span class="comment">//éœ€è¦å°†ä½ç½®å˜å›åˆ°æœ€å‰é¢ï¼Œè¿™æ ·ä¸‹é¢æ‰èƒ½ä»æ–‡ä»¶çš„æœ€å¼€å§‹è¿›è¡Œè¯»å–</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">        channel.read(buffer);</span><br><span class="line">        buffer.flip();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªFileChannelæ—¢å¯ä»¥å®Œæˆæ–‡ä»¶è¯»å–ï¼Œä¹Ÿå¯ä»¥å®Œæˆæ–‡ä»¶çš„å†™å…¥ã€‚</p>
<p>é™¤äº†åŸºæœ¬çš„è¯»å†™æ“ä½œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥å¯¹æ–‡ä»¶è¿›è¡Œæˆªæ–­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> f.getChannel()){</span><br><span class="line">        <span class="comment">//æˆªæ–­æ–‡ä»¶ï¼Œåªç•™å‰20ä¸ªå­—èŠ‚</span></span><br><span class="line">        channel.truncate(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">        channel.read(buffer);</span><br><span class="line">        buffer.flip();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ–‡ä»¶çš„å†…å®¹ç›´æ¥è¢«æˆªæ–­äº†ï¼Œæ–‡ä»¶å†…å®¹å°±åªå‰©ä¸€åŠäº†ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬è¦è¿›è¡Œæ–‡ä»¶çš„æ‹·è´ï¼Œä¹Ÿæ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œåªéœ€è¦ä½¿ç”¨é€šé“å°±å¯ä»¥ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦å°†ä¸€ä¸ªé€šé“çš„æ•°æ®å†™å…¥åˆ°å¦ä¸€ä¸ªé€šé“ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨transferToæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"test2.txt"</span>);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"test.txt"</span>)){</span><br><span class="line"></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">inChannel</span> <span class="operator">=</span> in.getChannel();   <span class="comment">//è·å–åˆ°testæ–‡ä»¶çš„é€šé“</span></span><br><span class="line">        inChannel.transferTo(<span class="number">0</span>, inChannel.size(), out.getChannel());   <span class="comment">//ç›´æ¥å°†testæ–‡ä»¶é€šé“ä¸­çš„æ•°æ®è½¬åˆ°test2æ–‡ä»¶çš„é€šé“ä¸­</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ‰§è¡Œåï¼Œæ–‡ä»¶çš„å†…å®¹å…¨éƒ¨è¢«å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶äº†ã€‚</p>
<p>å½“ç„¶ï¼Œåå‘æ“ä½œä¹Ÿæ˜¯å¯ä»¥çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">"test2.txt"</span>);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"test.txt"</span>)){</span><br><span class="line"></span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">inChannel</span> <span class="operator">=</span> in.getChannel();   <span class="comment">//è·å–åˆ°testæ–‡ä»¶çš„é€šé“</span></span><br><span class="line">        out.getChannel().transferFrom(inChannel, <span class="number">0</span>, inChannel.size());   <span class="comment">//ç›´æ¥å°†ä»testæ–‡ä»¶é€šé“ä¸­ä¼ æ¥çš„æ•°æ®è½¬ç»™test2æ–‡ä»¶çš„é€šé“</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å½“æˆ‘ä»¬è¦ç¼–è¾‘æŸä¸ªæ–‡ä»¶æ—¶ï¼Œé€šè¿‡ä½¿ç”¨MappedByteBufferç±»ï¼Œå¯ä»¥å°†å…¶æ˜ å°„åˆ°å†…å­˜ä¸­è¿›è¡Œç¼–è¾‘ï¼Œç¼–è¾‘çš„å†…å®¹ä¼šåŒæ­¥æ›´æ–°åˆ°æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ä¸€å®šè¦æ˜¯å¯å†™çš„ï¼Œä¸ç„¶æ— æ³•è¿›è¡Œä¿®æ”¹æ“ä½œ</span></span><br><span class="line"><span class="keyword">try</span>(<span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> f.getChannel()){</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡mapæ–¹æ³•æ˜ å°„æ–‡ä»¶çš„æŸä¸€æ®µå†…å®¹ï¼Œåˆ›å»ºMappedByteBufferå¯¹è±¡</span></span><br><span class="line">    <span class="comment">//æ¯”å¦‚è¿™é‡Œå°±æ˜¯ä»ç¬¬å››ä¸ªå­—èŠ‚å¼€å§‹ï¼Œæ˜ å°„10å­—èŠ‚å†…å®¹åˆ°å†…å­˜ä¸­</span></span><br><span class="line">  	<span class="comment">//æ³¨æ„è¿™é‡Œéœ€è¦ä½¿ç”¨MapMode.READ_WRITEæ¨¡å¼ï¼Œå…¶ä»–æ¨¡å¼æ— æ³•ä¿å­˜æ•°æ®åˆ°æ–‡ä»¶</span></span><br><span class="line">    <span class="type">MappedByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> channel.map(FileChannel.MapMode.READ_WRITE, <span class="number">4</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹åœ¨å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œç¼–è¾‘ï¼Œä¹Ÿå°±æ˜¯ç¼–è¾‘Bufferä¸­çš„å†…å®¹</span></span><br><span class="line">  	<span class="comment">//æ³¨æ„è¿™é‡Œå†™å…¥ä¹Ÿæ˜¯ä»posä½ç½®å¼€å§‹çš„ï¼Œé»˜è®¤æ˜¯ä»0å¼€å§‹ï¼Œç›¸å¯¹äºæ–‡ä»¶å°±æ˜¯ä»ç¬¬å››ä¸ªå­—èŠ‚å¼€å§‹å†™</span></span><br><span class="line">  	<span class="comment">//æ³¨æ„æˆ‘ä»¬åªæ˜ å°„äº†10ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å†™çš„å†…å®¹ä¸èƒ½è¶…å‡º10å­—èŠ‚äº†</span></span><br><span class="line">    buffer.put(<span class="string">"yyds"</span>.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¼–è¾‘å®Œæˆåï¼Œé€šè¿‡forceæ–¹æ³•å°†æ•°æ®å†™å›æ–‡ä»¶çš„æ˜ å°„åŒºåŸŸ</span></span><br><span class="line">    buffer.force();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ–‡ä»¶çš„æŸä¸€ä¸ªåŒºåŸŸå·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹äº†ï¼Œå¹¶ä¸”è¿™é‡Œå®é™…ä¸Šä½¿ç”¨çš„å°±æ˜¯DirectByteBufferç›´æ¥ç¼“å†²åŒºï¼Œæ•ˆç‡è¿˜æ˜¯å¾ˆé«˜çš„ã€‚</p>
<h3 id="æ–‡ä»¶é”FileLock"><a href="#æ–‡ä»¶é”FileLock" class="headerlink" title="æ–‡ä»¶é”FileLock"></a>æ–‡ä»¶é”FileLock</h3><p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè·¨è¿›ç¨‹æ–‡ä»¶é”æ¥é˜²æ­¢å¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„æ–‡ä»¶äº‰æŠ¢æ“ä½œï¼ˆæ³¨æ„è¿™é‡Œæ˜¯è¿›ç¨‹ï¼Œä¸æ˜¯çº¿ç¨‹ï¼‰FileLockæ˜¯æ–‡ä»¶é”ï¼Œå®ƒèƒ½ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼ˆç¨‹åºï¼‰èƒ½å¤Ÿä¿®æ”¹å®ƒï¼Œæˆ–è€…éƒ½åªå¯ä»¥è¯»ï¼Œè¿™æ ·å°±è§£å†³äº†å¤šè¿›ç¨‹é—´çš„åŒæ­¥æ–‡ä»¶ï¼Œä¿è¯äº†å®‰å…¨æ€§ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒè¿›ç¨‹çº§åˆ«çš„ï¼Œä¸æ˜¯çº¿ç¨‹çº§åˆ«çš„ï¼Œä»–å¯ä»¥è§£å†³å¤šä¸ªè¿›ç¨‹å¹¶å‘è®¿é—®åŒä¸€ä¸ªæ–‡ä»¶çš„é—®é¢˜ï¼Œä½†æ˜¯å®ƒä¸é€‚ç”¨äºæ§åˆ¶åŒä¸€ä¸ªè¿›ç¨‹ä¸­å¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªæ–‡ä»¶çš„è®¿é—®ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨æ–‡ä»¶é”ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException {</span><br><span class="line">  	<span class="comment">//åˆ›å»ºRandomAccessFileå¯¹è±¡ï¼Œå¹¶æ‹¿åˆ°Channel</span></span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> f.getChannel();</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" æ­£åœ¨å°è¯•è·å–æ–‡ä»¶é”..."</span>);</span><br><span class="line">  	<span class="comment">//æ¥ç€æˆ‘ä»¬ç›´æ¥ä½¿ç”¨lockæ–¹æ³•è¿›è¡ŒåŠ é”æ“ä½œï¼ˆå¦‚æœå…¶ä»–è¿›ç¨‹å·²ç»åŠ é”ï¼Œé‚£ä¹ˆä¼šä¸€ç›´é˜»å¡åœ¨è¿™é‡Œï¼‰</span></span><br><span class="line">  	<span class="comment">//åŠ é”æ“ä½œæ”¯æŒå¯¹æ–‡ä»¶çš„æŸä¸€æ®µè¿›è¡ŒåŠ é”ï¼Œæ¯”å¦‚è¿™é‡Œå°±æ˜¯ä»0å¼€å§‹åçš„6ä¸ªå­—èŠ‚åŠ é”ï¼Œfalseä»£è¡¨è¿™æ˜¯ä¸€æŠŠç‹¬å é”</span></span><br><span class="line">  	<span class="comment">//èŒƒå›´é”ç”šè‡³å¯ä»¥æå‰åŠ åˆ°ä¸€ä¸ªè¿˜æœªå†™å…¥çš„ä½ç½®ä¸Š</span></span><br><span class="line">    <span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.lock(<span class="number">0</span>, <span class="number">6</span>, <span class="literal">false</span>);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" å·²è·å–åˆ°æ–‡ä»¶é”ï¼"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">5000</span>);   <span class="comment">//å‡è®¾è¦å¤„ç†5ç§’é’Ÿ</span></span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" æ“ä½œå®Œæ¯•ï¼Œé‡Šæ”¾æ–‡ä»¶é”ï¼"</span>);</span><br><span class="line">  	</span><br><span class="line">  	<span class="comment">//æ“ä½œå®Œæˆä¹‹åä½¿ç”¨releaseæ–¹æ³•è¿›è¡Œé”é‡Šæ”¾</span></span><br><span class="line">    lock.release();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ‰å…³å…±äº«é”å’Œç‹¬å é”ï¼š</p>
<ul>
<li>è¿›ç¨‹å¯¹æ–‡ä»¶åŠ ç‹¬å é”åï¼Œå½“å‰è¿›ç¨‹å¯¹æ–‡ä»¶å¯è¯»å¯å†™ï¼Œç‹¬å æ­¤æ–‡ä»¶ï¼Œå…¶å®ƒè¿›ç¨‹æ˜¯ä¸èƒ½è¯»è¯¥æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œçš„ã€‚</li>
<li>è¿›ç¨‹å¯¹æ–‡ä»¶åŠ å…±äº«é”åï¼Œè¿›ç¨‹å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè¯»æ“ä½œï¼Œä½†æ˜¯æ— æ³•è¿›è¡Œå†™æ“ä½œï¼Œå…±äº«é”å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹æ·»åŠ ï¼Œä½†æ˜¯åªè¦å­˜åœ¨å…±äº«é”ï¼Œå°±ä¸èƒ½æ·»åŠ ç‹¬å é”ã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬æ¥å¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹è¯•è¯•çœ‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨IDEAä¸­é…ç½®ä¸€ä¸‹ä¸¤ä¸ªå¯åŠ¨é¡¹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1n5uyrdjij21t40hsmzt.jpg" alt="image-20220426153541728"></p>
<p>ç°åœ¨æˆ‘ä»¬ä¾æ¬¡å¯åŠ¨å®ƒä»¬ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1n5vwim5ej21hc06ct9x.jpg" alt="image-20220426153636218"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1n5w43wzxj21ii06igmw.jpg" alt="image-20220426153648363"></p>
<p>å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯ä¸¤ä¸ªè¿›ç¨‹åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªè¿›è¡Œè®¿é—®ï¼Œè€Œå¦ä¸€ä¸ªéœ€è¦ç­‰å¾…é”é‡Šæ”¾ã€‚</p>
<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç”³è¯·çš„æ˜¯æ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹é” 0 - 5</span></span><br><span class="line"><span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.lock(<span class="number">0</span>, <span class="number">6</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">//å¦ä¸€ä¸ªè¿›ç¨‹é” 6 - 11</span></span><br><span class="line"><span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.lock(<span class="number">6</span>, <span class="number">6</span>, <span class="literal">false</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªè¿›ç¨‹è¿™æ—¶å°±å¯ä»¥åŒæ—¶è¿›è¡ŒåŠ é”æ“ä½œäº†ï¼Œå› ä¸ºå®ƒä»¬é”çš„æ˜¯ä¸åŒçš„æ®µè½ã€‚</p>
<p>é‚£ä¹ˆè¦æ˜¯äº¤å‰å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹é” 0 - 5</span></span><br><span class="line"><span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.lock(<span class="number">0</span>, <span class="number">6</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">//å¦ä¸€ä¸ªè¿›ç¨‹é” 3 - 8</span></span><br><span class="line"><span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.lock(<span class="number">3</span>, <span class="number">6</span>, <span class="literal">false</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°äº¤å‰çš„æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¼šå‡ºç°é˜»å¡çš„ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹å…±äº«é”ï¼Œå…±äº«é”å…è®¸å¤šä¸ªè¿›ç¨‹åŒæ—¶åŠ é”ï¼Œä½†æ˜¯ä¸èƒ½è¿›è¡Œå†™æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException {</span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">        <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> f.getChannel();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" æ­£åœ¨å°è¯•è·å–æ–‡ä»¶é”..."</span>);</span><br><span class="line">        <span class="comment">//ç°åœ¨ä½¿ç”¨å…±äº«é”</span></span><br><span class="line">        <span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.lock(<span class="number">0</span>, Long.MAX_VALUE, <span class="literal">true</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" å·²è·å–åˆ°æ–‡ä»¶é”ï¼"</span>);</span><br><span class="line">  			<span class="comment">//è¿›è¡Œå†™æ“ä½œ</span></span><br><span class="line">        channel.write(ByteBuffer.wrap(<span class="keyword">new</span> <span class="title class_">Date</span>().toString().getBytes()));</span><br><span class="line">       </span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" æ“ä½œå®Œæ¯•ï¼Œé‡Šæ”¾æ–‡ä»¶é”ï¼"</span>);</span><br><span class="line">        <span class="comment">//æ“ä½œå®Œæˆä¹‹åä½¿ç”¨releaseæ–¹æ³•è¿›è¡Œé”é‡Šæ”¾</span></span><br><span class="line">        lock.release();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>å½“æˆ‘ä»¬è¿›è¡Œå†™æ“ä½œæ—¶ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1ni0yi6vcj21t008ugo8.jpg" alt="image-20220426223636761"></p>
<p>å¯ä»¥çœ‹åˆ°ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¯´å¦ä¸€ä¸ªç¨‹åºå·²é”å®šæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œè¿›ç¨‹æ— æ³•è®¿é—®ï¼ˆæŸäº›ç³»ç»Ÿæˆ–æ˜¯ç¯å¢ƒå®æµ‹æ— æ•ˆï¼Œæ¯”å¦‚UPä¸»çš„armæ¶æ„MacOSå°±ä¸ç”Ÿæ•ˆï¼Œè¿™ä¸ªå¼‚å¸¸æ˜¯åœ¨Windowsç¯å¢ƒä¸‹è¿è¡Œå¾—åˆ°çš„ï¼‰</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æµ‹è¯•ä¸€ä¸‹å¤šä¸ªè¿›è¡ŒåŒæ—¶åŠ å…±äº«é”ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException {</span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> f.getChannel();</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" æ­£åœ¨å°è¯•è·å–æ–‡ä»¶é”..."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.lock(<span class="number">0</span>, Long.MAX_VALUE, <span class="literal">true</span>);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" å·²è·å–åˆ°æ–‡ä»¶é”ï¼"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">5000</span>);   <span class="comment">//å‡è®¾è¦å¤„ç†5ç§’é’Ÿ</span></span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" æ“ä½œå®Œæ¯•ï¼Œé‡Šæ”¾æ–‡ä»¶é”ï¼"</span>);</span><br><span class="line">    </span><br><span class="line">    lock.release();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç»“æœæ˜¯å¤šä¸ªè¿›ç¨‹éƒ½èƒ½åŠ å…±äº«é”ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1niehdyqkj21eg03wgm2.jpg" alt="image-20220426224938834"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1nier022vj21go03mwex.jpg" alt="image-20220426224954291"></p>
<p>å½“ç„¶ï¼Œé™¤äº†ç›´æ¥ä½¿ç”¨<code>lock()</code>æ–¹æ³•è¿›è¡ŒåŠ é”ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨<code>tryLock()</code>æ–¹æ³•ä»¥éé˜»å¡æ–¹å¼è·å–æ–‡ä»¶é”ï¼Œä½†æ˜¯å¦‚æœè·å–é”å¤±è´¥ä¼šå¾—åˆ°nullï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException {</span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="string">"test.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">channel</span> <span class="operator">=</span> f.getChannel();</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">" æ­£åœ¨å°è¯•è·å–æ–‡ä»¶é”..."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">FileLock</span> <span class="variable">lock</span> <span class="operator">=</span> channel.tryLock(<span class="number">0</span>, Long.MAX_VALUE, <span class="literal">false</span>);</span><br><span class="line">    System.out.println(lock);</span><br><span class="line">    Thread.sleep(<span class="number">5000</span>);   <span class="comment">//å‡è®¾è¦å¤„ç†5ç§’é’Ÿ</span></span><br><span class="line"></span><br><span class="line">    lock.release();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªè¿›ç¨‹éƒ½å»å°è¯•è·å–ç‹¬å é”ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1niqbuoygj218w02mq39.jpg" alt="image-20220426230102206"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1niqlky3ij21ek04igma.jpg" alt="image-20220426230117926"></p>
<p>ç¬¬ä¸€ä¸ªæˆåŠŸåŠ é”çš„è¿›ç¨‹è·å¾—äº†å¯¹åº”çš„é”å¯¹è±¡ï¼Œè€Œç¬¬äºŒä¸ªè¿›ç¨‹ç›´æ¥å¾—åˆ°çš„æ˜¯<code>null</code>ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæœ‰å…³æ–‡ä»¶é”çš„ç›¸å…³å†…å®¹å°±å·®ä¸å¤šäº†ã€‚</p>
<hr>
<h2 id="å¤šè·¯å¤ç”¨ç½‘ç»œé€šä¿¡"><a href="#å¤šè·¯å¤ç”¨ç½‘ç»œé€šä¿¡" class="headerlink" title="å¤šè·¯å¤ç”¨ç½‘ç»œé€šä¿¡"></a>å¤šè·¯å¤ç”¨ç½‘ç»œé€šä¿¡</h2><p>å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»äº†NIOæ¡†æ¶çš„ä¸¤å¤§æ ¸å¿ƒï¼šBufferå’ŒChannelï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹æœ€åä¸€ä¸ªå†…å®¹ã€‚</p>
<h3 id="ä¼ ç»Ÿé˜»å¡I-Oç½‘ç»œé€šä¿¡"><a href="#ä¼ ç»Ÿé˜»å¡I-Oç½‘ç»œé€šä¿¡" class="headerlink" title="ä¼ ç»Ÿé˜»å¡I/Oç½‘ç»œé€šä¿¡"></a>ä¼ ç»Ÿé˜»å¡I/Oç½‘ç»œé€šä¿¡</h3><p>è¯´èµ·ç½‘ç»œé€šä¿¡ï¼Œç›¸ä¿¡å„ä½å¹¶ä¸é™Œç”Ÿï¼Œæ­£æ˜¯å› ä¸ºç½‘ç»œçš„å­˜åœ¨æˆ‘ä»¬æ‰èƒ½èµ°è¿›ç°ä»£åŒ–çš„ç¤¾ä¼šï¼Œåœ¨JavaWebé˜¶æ®µï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨Socketå»ºç«‹TCPè¿æ¥è¿›è¡Œç½‘ç»œé€šä¿¡ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">ServerSocket</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">8080</span>)){    <span class="comment">//å°†æœåŠ¡ç«¯åˆ›å»ºåœ¨ç«¯å£8080ä¸Š</span></span><br><span class="line">        System.out.println(<span class="string">"æ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥..."</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> server.accept();</span><br><span class="line">        System.out.println(<span class="string">"å®¢æˆ·ç«¯å·²è¿æ¥ï¼ŒIPåœ°å€ä¸ºï¼š"</span>+socket.getInetAddress().getHostAddress());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));  <span class="comment">//é€šè¿‡</span></span><br><span class="line">        System.out.print(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>);</span><br><span class="line">        System.out.println(reader.readLine());</span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(socket.getOutputStream());</span><br><span class="line">        writer.write(<span class="string">"å·²æ”¶åˆ°ï¼"</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">    }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">"localhost"</span>, <span class="number">8080</span>);</span><br><span class="line">         <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)){</span><br><span class="line">        System.out.println(<span class="string">"å·²è¿æ¥åˆ°æœåŠ¡ç«¯ï¼"</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">stream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="type">OutputStreamWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(stream);  <span class="comment">//é€šè¿‡è½¬æ¢æµæ¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå†™å…¥å†…å®¹</span></span><br><span class="line">        System.out.println(<span class="string">"è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">        writer.write(text+<span class="string">'\n'</span>);   <span class="comment">//å› ä¸ºå¯¹æ–¹æ˜¯readLine()è¿™é‡ŒåŠ ä¸ªæ¢è¡Œç¬¦</span></span><br><span class="line">        writer.flush();</span><br><span class="line">        System.out.println(<span class="string">"æ•°æ®å·²å‘é€ï¼š"</span>+text);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(socket.getInputStream()));</span><br><span class="line">        System.out.println(<span class="string">"æ”¶åˆ°æœåŠ¡å™¨è¿”å›ï¼š"</span>+reader.readLine());</span><br><span class="line">    }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">        System.out.println(<span class="string">"æœåŠ¡ç«¯è¿æ¥å¤±è´¥ï¼"</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }<span class="keyword">finally</span> {</span><br><span class="line">        System.out.println(<span class="string">"å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å‰é¢è®²è§£çš„é€šé“æ¥è¿›è¡Œé€šä¿¡ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„ServerSocketChannelï¼Œä¸€ä¼šç›´æ¥ä½¿ç”¨SocketChannelè¿›è¡Œç½‘ç»œIOæ“ä½œ</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open()){</span><br><span class="line">        <span class="comment">//ä¾ç„¶æ˜¯å°†å…¶ç»‘å®šåˆ°8080ç«¯å£</span></span><br><span class="line">        serverChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">        <span class="comment">//åŒæ ·æ˜¯è°ƒç”¨accept()æ–¹æ³•ï¼Œé˜»å¡ç­‰å¾…æ–°çš„è¿æ¥åˆ°æ¥</span></span><br><span class="line">        <span class="type">SocketChannel</span> <span class="variable">socket</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">        <span class="comment">//å› ä¸ºæ˜¯é€šé“ï¼Œä¸¤ç«¯çš„ä¿¡æ¯éƒ½æ˜¯å¯ä»¥æ˜ç¡®çš„ï¼Œè¿™é‡Œè·å–è¿œç«¯åœ°å€ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è·å–æœ¬åœ°åœ°å€</span></span><br><span class="line">        System.out.println(<span class="string">"å®¢æˆ·ç«¯å·²è¿æ¥ï¼ŒIPåœ°å€ä¸ºï¼š"</span>+socket.getRemoteAddress());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨ç¼“å†²åŒºè¿›è¡Œæ•°æ®æ¥æ”¶</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">        socket.read(buffer);   <span class="comment">//SocketChannelåŒæ—¶å®ç°äº†è¯»å†™é€šé“æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿›è¡ŒåŒå‘æ“ä½œ</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        System.out.print(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç›´æ¥å‘é€šé“ä¸­å†™å…¥æ•°æ®å°±è¡Œ</span></span><br><span class="line">        socket.write(ByteBuffer.wrap(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è®°å¾—å…³</span></span><br><span class="line">        socket.close();</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„SocketChannelï¼Œä¸€ä¼šé€šè¿‡é€šé“è¿›è¡Œé€šä¿¡</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> SocketChannel.open(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">"localhost"</span>, <span class="number">8080</span>));</span><br><span class="line">         <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)){</span><br><span class="line">        System.out.println(<span class="string">"å·²è¿æ¥åˆ°æœåŠ¡ç«¯ï¼"</span>);</span><br><span class="line">        System.out.println(<span class="string">"è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">        <span class="comment">//ç›´æ¥å‘é€šé“ä¸­å†™å…¥æ•°æ®ï¼ŒçœŸèˆ’æœ</span></span><br><span class="line">        channel.write(ByteBuffer.wrap(text.getBytes()));</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">        channel.read(buffer);   <span class="comment">//ç›´æ¥ä»é€šé“ä¸­è¯»å–æ•°æ®</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        System.out.println(<span class="string">"æ”¶åˆ°æœåŠ¡å™¨è¿”å›ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è™½ç„¶å¯ä»¥é€šè¿‡ä¼ ç»Ÿçš„Socketè¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœè¦è¿›è¡ŒIOæ“ä½œï¼Œæˆ‘ä»¬éœ€è¦å•ç‹¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ç°åœ¨æœ‰å¾ˆå¤šä¸ªå®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯éœ€è¦åŒæ—¶è¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¦å¤„ç†è¿™äº›å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åªèƒ½å•ç‹¬ä¸ºå…¶åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œå¤„ç†ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1odmx2b3yj21o60dcwgh.jpg" alt="image-20220427165019293"></p>
<p>è™½ç„¶è¿™æ ·çœ‹èµ·æ¥æ¯”è¾ƒåˆç†ï¼Œä½†æ˜¯éšç€å®¢æˆ·ç«¯æ•°é‡çš„å¢åŠ ï¼Œå¦‚æœè¦ä¿æŒæŒç»­é€šä¿¡ï¼Œé‚£ä¹ˆå°±ä¸èƒ½æ‘§æ¯è¿™äº›çº¿ç¨‹ï¼Œè€Œæ˜¯éœ€è¦ä¸€ç›´ä¿ç•™ï¼ˆä½†æ˜¯å®é™…ä¸Šå¾ˆå¤šæ—¶å€™åªæ˜¯ä¿æŒè¿æ¥ï¼Œä¸€ç›´åœ¨é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯çš„è¯»å†™æ“ä½œï¼ŒIOæ“ä½œçš„é¢‘ç‡å¾ˆä½ï¼Œè¿™æ ·å°±ç™½ç™½å ç”¨äº†ä¸€æ¡çº¿ç¨‹ï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯ç«™ç€èŒ…å‘ä¸æ‹‰å±ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬çš„çº¿ç¨‹ä¸å¯èƒ½æ— é™åˆ¶çš„è¿›è¡Œåˆ›å»ºï¼Œæ€»æœ‰ä¸€å¤©ä¼šè€—å°½æœåŠ¡ç«¯çš„èµ„æºï¼Œé‚£ä¹ˆç°åœ¨æ€ä¹ˆåŠå‘¢ï¼Œå…³é”®æ˜¯ç°åœ¨åˆæœ‰å¾ˆå¤šå®¢æˆ·ç«¯æºæºä¸æ–­åœ°è¿æ¥å¹¶è¿›è¡Œæ“ä½œï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨NIOä¸ºæˆ‘ä»¬æä¾›çš„å¤šè·¯å¤ç”¨ç¼–ç¨‹æ¨¡å‹ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹NIOä¸ºæˆ‘ä»¬æä¾›çš„æ¨¡å‹ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1odzw1dk3j21oi0e2goy.jpg" alt="image-20220427170247004"></p>
<p>æœåŠ¡ç«¯ä¸å†æ˜¯ä¸€ä¸ªå•çº¯é€šè¿‡<code>accept()</code>æ–¹æ³•æ¥åˆ›å»ºè¿æ¥çš„æœºåˆ¶äº†ï¼Œè€Œæ˜¯æ ¹æ®å®¢æˆ·ç«¯ä¸åŒçš„çŠ¶æ€ï¼ŒSelectorä¼šä¸æ–­è½®è¯¢ï¼Œåªæœ‰å®¢æˆ·ç«¯åœ¨å¯¹åº”çš„çŠ¶æ€æ—¶ï¼Œæ¯”å¦‚çœŸæ­£å¼€å§‹è¯»å†™æ“ä½œæ—¶ï¼Œæ‰ä¼šåˆ›å»ºçº¿ç¨‹æˆ–è¿›è¡Œå¤„ç†ï¼ˆè¿™æ ·å°±ä¸ä¼šä¸€ç›´é˜»å¡ç­‰å¾…æŸä¸ªå®¢æˆ·ç«¯çš„IOæ“ä½œäº†ï¼‰ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¹‹åéœ€è¦ä¸€ç›´ä¿æŒè¿æ¥ï¼Œå³ä½¿æ²¡æœ‰ä»»ä½•çš„è¯»å†™æ“ä½œã€‚è¿™æ ·å°±ä¸ä¼šå› ä¸ºå ç€èŒ…å‘ä¸æ‹‰å±å¯¼è‡´çº¿ç¨‹æ— é™åˆ¶åœ°åˆ›å»ºä¸‹å»äº†ã€‚</p>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç”šè‡³å•çº¿ç¨‹éƒ½èƒ½åšåˆ°é«˜æ•ˆçš„å¤ç”¨ï¼Œæœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯Redisäº†ï¼Œå› ä¸ºå†…å­˜çš„é€Ÿåº¦éå¸¸å¿«ï¼Œå¤šçº¿ç¨‹ä¸Šä¸‹æ–‡çš„å¼€é”€å°±ä¼šæ˜¾å¾—æœ‰äº›æ‹–åè…¿ï¼Œè¿˜ä¸å¦‚ç›´æ¥å•çº¿ç¨‹ç®€å•é«˜æ•ˆï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆRediså•çº¿ç¨‹ä¹Ÿèƒ½è¿™ä¹ˆå¿«çš„åŸå› ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å°±ä»NIOæ¡†æ¶çš„ç¬¬ä¸‰ä¸ªæ ¸å¿ƒå†…å®¹ï¼šSelectorï¼Œå¼€å§‹è®²èµ·ã€‚</p>
<h3 id="é€‰æ‹©å™¨ä¸I-Oå¤šè·¯å¤ç”¨"><a href="#é€‰æ‹©å™¨ä¸I-Oå¤šè·¯å¤ç”¨" class="headerlink" title="é€‰æ‹©å™¨ä¸I/Oå¤šè·¯å¤ç”¨"></a>é€‰æ‹©å™¨ä¸I/Oå¤šè·¯å¤ç”¨</h3><p>å‰é¢æˆ‘ä»¬å¤§æ¦‚äº†è§£äº†ä¸€ä¸‹é€‰æ‹©å™¨ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œé€‰æ‹©å™¨æ˜¯å½“å…·ä½“æœ‰æŸä¸€ä¸ªçŠ¶æ€ï¼ˆæ¯”å¦‚è¯»ã€å†™ã€è¯·æ±‚ï¼‰å·²ç»å°±ç»ªæ—¶ï¼Œæ‰ä¼šè¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯è®©æˆ‘ä»¬çš„ç¨‹åºä¸»åŠ¨åœ°è¿›è¡Œç­‰å¾…ã€‚</p>
<p>æ—¢ç„¶æˆ‘ä»¬ç°åœ¨éœ€è¦å®ç°IOå¤šè·¯å¤ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹å¸¸è§çš„IOå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯Selectorçš„å®ç°æ–¹æ¡ˆï¼Œæ¯”å¦‚ç°åœ¨æœ‰å¾ˆå¤šä¸ªç”¨æˆ·è¿æ¥åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼š</p>
<ul>
<li><strong>select</strong>ï¼šå½“è¿™äº›è¿æ¥å‡ºç°å…·ä½“çš„æŸä¸ªçŠ¶æ€æ—¶ï¼Œåªæ˜¯çŸ¥é“å·²ç»å°±ç»ªäº†ï¼Œä½†æ˜¯ä¸çŸ¥é“è¯¦å…·ä½“æ˜¯å“ªä¸€ä¸ªè¿æ¥å·²ç»å°±ç»ªï¼Œæ¯æ¬¡è°ƒç”¨éƒ½è¿›è¡Œçº¿æ€§éå†æ‰€æœ‰è¿æ¥ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º<code>O(n)</code>ï¼Œå¹¶ä¸”å­˜åœ¨æœ€å¤§è¿æ¥æ•°é™åˆ¶ã€‚</li>
<li><strong>poll</strong>ï¼šåŒä¸Šï¼Œä½†æ˜¯ç”±äºåº•å±‚é‡‡ç”¨é“¾è¡¨ï¼Œæ‰€ä»¥æ²¡æœ‰æœ€å¤§è¿æ¥æ•°é™åˆ¶ã€‚</li>
<li><strong>epoll</strong>ï¼šé‡‡ç”¨äº‹ä»¶é€šçŸ¥æ–¹å¼ï¼Œå½“æŸä¸ªè¿æ¥å°±ç»ªï¼Œèƒ½å¤Ÿç›´æ¥è¿›è¡Œç²¾å‡†é€šçŸ¥ï¼ˆè¿™æ˜¯å› ä¸ºåœ¨å†…æ ¸å®ç°ä¸­epollæ˜¯æ ¹æ®æ¯ä¸ªfdä¸Šé¢çš„callbackå‡½æ•°å®ç°çš„ï¼Œåªè¦å°±ç»ªä¼šä¼šç›´æ¥å›è°ƒcallbackå‡½æ•°ï¼Œå®ç°ç²¾å‡†é€šçŸ¥ï¼Œä½†æ˜¯åªæœ‰Linuxæ”¯æŒè¿™ç§æ–¹å¼ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦<code>O(1)</code>ï¼ŒJavaåœ¨Linuxç¯å¢ƒä¸‹æ­£æ˜¯é‡‡ç”¨çš„è¿™ç§æ¨¡å¼è¿›è¡Œå®ç°çš„ã€‚</li>
</ul>
<p>å¥½äº†ï¼Œæ—¢ç„¶å¤šè·¯å¤ç”¨æ¨¡å‹äº†è§£å®Œæ¯•äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•è®©æˆ‘ä»¬çš„ç½‘ç»œé€šä¿¡å®ç°å¤šè·¯å¤ç”¨ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">         <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open()){   <span class="comment">//å¼€å¯ä¸€ä¸ªæ–°çš„Selectorï¼Œè¿™ç©æ„ä¹Ÿæ˜¯è¦å…³é—­é‡Šæ”¾èµ„æºçš„</span></span><br><span class="line">        serverChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">        <span class="comment">//è¦ä½¿ç”¨é€‰æ‹©å™¨è¿›è¡Œæ“ä½œï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡çš„æ–¹å¼ï¼Œè¿™æ ·æ‰ä¸ä¼šåƒé˜»å¡IOé‚£æ ·å¡åœ¨accept()ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ï¼Œè®©é€‰æ‹©å™¨å»è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ</span></span><br><span class="line">        serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//å°†é€‰æ‹©å™¨æ³¨å†Œåˆ°ServerSocketChannelä¸­ï¼Œåé¢æ˜¯é€‰æ‹©éœ€è¦ç›‘å¬çš„æ—¶é—´ï¼Œåªæœ‰å‘ç”Ÿå¯¹åº”äº‹ä»¶æ—¶æ‰ä¼šè¿›è¡Œé€‰æ‹©ï¼Œå¤šä¸ªäº‹ä»¶ç”¨ | è¿æ¥ï¼Œæ³¨æ„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„Channeléƒ½æ”¯æŒä»¥ä¸‹å…¨éƒ¨å››ä¸ªäº‹ä»¶ï¼Œå¯èƒ½åªæ”¯æŒéƒ¨åˆ†</span></span><br><span class="line">        <span class="comment">//å› ä¸ºæ˜¯ServerSocketChannelè¿™é‡Œæˆ‘ä»¬å°±ç›‘å¬acceptå°±å¯ä»¥äº†ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">        <span class="comment">//SelectionKey.OP_CONNECT --- è¿æ¥å°±ç»ªäº‹ä»¶ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„è¿æ¥å·²ç»å»ºç«‹æˆåŠŸ</span></span><br><span class="line">        <span class="comment">//SelectionKey.OP_ACCEPT --- æ¥æ”¶è¿æ¥äº‹ä»¶ï¼Œè¡¨ç¤ºæœåŠ¡å™¨ç›‘å¬åˆ°äº†å®¢æˆ·è¿æ¥ï¼ŒæœåŠ¡å™¨å¯ä»¥æ¥æ”¶è¿™ä¸ªè¿æ¥äº†</span></span><br><span class="line">        <span class="comment">//SelectionKey.OP_READ --- è¯» å°±ç»ªäº‹ä»¶ï¼Œè¡¨ç¤ºé€šé“ä¸­å·²ç»æœ‰äº†å¯è¯»çš„æ•°æ®ï¼Œå¯ä»¥æ‰§è¡Œè¯»æ“ä½œäº†</span></span><br><span class="line">        <span class="comment">//SelectionKey.OP_WRITE --- å†™ å°±ç»ªäº‹ä»¶ï¼Œè¡¨ç¤ºå·²ç»å¯ä»¥å‘é€šé“å†™æ•°æ®äº†ï¼ˆè¿™ç©æ„æ¯”è¾ƒç‰¹æ®Šï¼Œä¸€èˆ¬æƒ…å†µä¸‹å› ä¸ºéƒ½æ˜¯å¯ä»¥å†™å…¥çš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šæ— é™å¾ªç¯ï¼‰</span></span><br><span class="line">        serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {   <span class="comment">//æ— é™å¾ªç¯ç­‰å¾…æ–°çš„ç”¨æˆ·ç½‘ç»œæ“ä½œ</span></span><br><span class="line">            <span class="comment">//æ¯æ¬¡é€‰æ‹©éƒ½å¯èƒ½ä¼šé€‰å‡ºå¤šä¸ªå·²ç»å°±ç»ªçš„ç½‘ç»œæ“ä½œï¼Œæ²¡æœ‰æ“ä½œæ—¶ä¼šæš‚æ—¶é˜»å¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br><span class="line">            System.out.println(<span class="string">"ç›‘å¬åˆ° "</span>+count+<span class="string">" ä¸ªäº‹ä»¶"</span>);</span><br><span class="line">            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">                <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                <span class="comment">//æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œå³å¯</span></span><br><span class="line">                <span class="keyword">if</span>(key.isAcceptable()) {  <span class="comment">//å¦‚æœå½“å‰ServerSocketChannelå·²ç»åšå¥½å‡†å¤‡å¤„ç†Accept</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">                    System.out.println(<span class="string">"å®¢æˆ·ç«¯å·²è¿æ¥ï¼ŒIPåœ°å€ä¸ºï¼š"</span>+channel.getRemoteAddress());</span><br><span class="line">                    <span class="comment">//ç°åœ¨è¿æ¥å°±å»ºç«‹å¥½äº†ï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦å°†è¿æ¥ä¹Ÿæ³¨å†Œé€‰æ‹©å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦å½“è¿™ä¸ªè¿æ¥æœ‰å†…å®¹å¯è¯»æ—¶å°±è¿›è¡Œå¤„ç†</span></span><br><span class="line">                    channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">                    channel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                    <span class="comment">//è¿™æ ·å°±åœ¨è¿æ¥å»ºç«‹æ—¶å®Œæˆäº†æ³¨å†Œ</span></span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span>(key.isReadable()) {    <span class="comment">//å¦‚æœå½“å‰è¿æ¥æœ‰å¯è¯»çš„æ•°æ®å¹¶ä¸”å¯ä»¥å†™ï¼Œé‚£ä¹ˆå°±å¼€å§‹å¤„ç†</span></span><br><span class="line">                    <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> (SocketChannel) key.channel();</span><br><span class="line">                    <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">                    channel.read(buffer);</span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//ç›´æ¥å‘é€šé“ä¸­å†™å…¥æ•°æ®å°±è¡Œ</span></span><br><span class="line">                    channel.write(ByteBuffer.wrap(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">                    <span class="comment">//åˆ«å…³ï¼Œè¯´ä¸å®šç”¨æˆ·è¿˜è¦ç»§ç»­é€šä¿¡å‘¢</span></span><br><span class="line">                }</span><br><span class="line">                <span class="comment">//å¤„ç†å®Œæˆåï¼Œä¸€å®šè®°å¾—ç§»å‡ºè¿­ä»£å™¨ï¼Œä¸ç„¶ä¸‹æ¬¡è¿˜æœ‰</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ç€æˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸‹å®¢æˆ·å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„SocketChannelï¼Œä¸€ä¼šé€šè¿‡é€šé“è¿›è¡Œé€šä¿¡</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> SocketChannel.open(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">"localhost"</span>, <span class="number">8080</span>));</span><br><span class="line">         <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in)){</span><br><span class="line">        System.out.println(<span class="string">"å·²è¿æ¥åˆ°æœåŠ¡ç«¯ï¼"</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {   <span class="comment">//å’±ç»™å®ƒå¥—ä¸ªæ— é™å¾ªç¯ï¼Œè¿™æ ·å°±èƒ½ä¸€ç›´å‘æ¶ˆæ¯äº†</span></span><br><span class="line">            System.out.println(<span class="string">"è¯·è¾“å…¥è¦å‘é€ç»™æœåŠ¡ç«¯çš„å†…å®¹ï¼š"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line">            <span class="comment">//ç›´æ¥å‘é€šé“ä¸­å†™å…¥æ•°æ®ï¼ŒçœŸèˆ’æœ</span></span><br><span class="line">            channel.write(ByteBuffer.wrap(text.getBytes()));</span><br><span class="line">            System.out.println(<span class="string">"å·²å‘é€ï¼"</span>);</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">            channel.read(buffer);   <span class="comment">//ç›´æ¥ä»é€šé“ä¸­è¯»å–æ•°æ®</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            System.out.println(<span class="string">"æ”¶åˆ°æœåŠ¡å™¨è¿”å›ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1wf9h1v29j213w06m74t.jpg" alt="image-20220504155104437"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1wf9ms12cj217005uwet.jpg" alt="image-20220504155116276"></p>
<p>å¯ä»¥çœ‹åˆ°æˆåŠŸå®ç°äº†ï¼Œå½“ç„¶å„ä½ä¹Ÿå¯ä»¥è·Ÿè‡ªå·±çš„å®¤å‹ä¸€èµ·å¼€å®¢æˆ·ç«¯è¿›è¡Œæµ‹è¯•ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬åªç”¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå°±èƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œå¯è§å¤šè·¯å¤ç”¨æ˜¯å¤šä¹ˆé‡è¦ã€‚</p>
<h3 id="å®ç°Reactoræ¨¡å¼"><a href="#å®ç°Reactoræ¨¡å¼" class="headerlink" title="å®ç°Reactoræ¨¡å¼"></a>å®ç°Reactoræ¨¡å¼</h3><p>å‰é¢æˆ‘ä»¬ç®€å•å®ç°äº†å¤šè·¯å¤ç”¨ç½‘ç»œé€šä¿¡ï¼Œæˆ‘ä»¬æ¥ç€æ¥äº†è§£ä¸€ä¸‹Reactoræ¨¡å¼ï¼Œå¯¹æˆ‘ä»¬çš„æœåŠ¡ç«¯è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è¿›è¡Œä¼˜åŒ–ï¼Œæˆ‘ä»¬é¦–å…ˆæŠ½è±¡å‡ºä¸¤ä¸ªç»„ä»¶ï¼ŒReactorçº¿ç¨‹å’ŒHandlerå¤„ç†å™¨ï¼š</p>
<ul>
<li>Reactorçº¿ç¨‹ï¼šè´Ÿè´£å“åº”IOäº‹ä»¶ï¼Œå¹¶åˆ†å‘åˆ°Handlerå¤„ç†å™¨ã€‚æ–°çš„äº‹ä»¶åŒ…å«è¿æ¥å»ºç«‹å°±ç»ªã€è¯»å°±ç»ªã€å†™å°±ç»ªç­‰ã€‚</li>
<li>Handlerå¤„ç†å™¨ï¼šæ‰§è¡Œéé˜»å¡çš„æ“ä½œã€‚</li>
</ul>
<p>å®é™…ä¸Šæˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„ç®—æ˜¯ä¸€ç§å•çº¿ç¨‹Reactorçš„æœ´ç´ æ¨¡å‹ï¼ˆé¢å‘è¿‡ç¨‹çš„å†™æ³•ï¼‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ ‡å‡†çš„å†™æ³•ï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1wgietqmhj21fq0c6tah.jpg" alt="image-20220504163417826"></p>
<p>å®¢æˆ·ç«¯è¿˜æ˜¯æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„æ–¹å¼è¿æ¥åˆ°Reactorï¼Œå¹¶é€šè¿‡é€‰æ‹©å™¨èµ°åˆ°Acceptoræˆ–æ˜¯Handlerï¼ŒAcceptorä¸»è¦è´Ÿè´£å®¢æˆ·ç«¯è¿æ¥çš„å»ºç«‹ï¼ŒHandlerè´Ÿè´£è¯»å†™æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼Œé¦–å…ˆæ˜¯Handlerï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Handler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel channel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">            channel.read(buffer);</span><br><span class="line">            buffer.flip();</span><br><span class="line">            System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">            channel.write(ByteBuffer.wrap(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">        }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ç€æ˜¯Acceptorï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠä¸Šé¢çš„ä¸šåŠ¡ä»£ç æ¬ä¸ªä½ç½®ç½¢äº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Acceptorä¸»è¦ç”¨äºå¤„ç†è¿æ¥æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Acceptor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerSocketChannel serverChannel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Acceptor</span><span class="params">(ServerSocketChannel serverChannel, Selector selector)</span> {</span><br><span class="line">        <span class="built_in">this</span>.serverChannel = serverChannel;</span><br><span class="line">        <span class="built_in">this</span>.selector = selector;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> serverChannel.accept();</span><br><span class="line">            System.out.println(<span class="string">"å®¢æˆ·ç«¯å·²è¿æ¥ï¼ŒIPåœ°å€ä¸ºï¼š"</span>+channel.getRemoteAddress());</span><br><span class="line">            channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">//è¿™é‡Œåœ¨æ³¨å†Œæ—¶ï¼Œåˆ›å»ºå¥½å¯¹åº”çš„Handlerï¼Œè¿™æ ·åœ¨Reactorä¸­åˆ†å‘çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥è°ƒç”¨Handleräº†</span></span><br><span class="line">            channel.register(selector, SelectionKey.OP_READ, <span class="keyword">new</span> <span class="title class_">Handler</span>(channel));</span><br><span class="line">        }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬åœ¨æ³¨å†Œæ—¶ä¸¢äº†ä¸€ä¸ªé™„åŠ å¯¹è±¡è¿›å»ï¼Œè¿™ä¸ªé™„åŠ å¯¹è±¡ä¼šåœ¨é€‰æ‹©å™¨é€‰æ‹©åˆ°æ­¤é€šé“ä¸Šæ—¶ï¼Œå¯ä»¥é€šè¿‡<code>attachment()</code>æ–¹æ³•è¿›è¡Œè·å–ï¼Œå¯¹äºæˆ‘ä»¬ç®€åŒ–ä»£ç æœ‰å¤§ä½œç”¨ï¼Œä¸€ä¼šå±•ç¤ºï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹Reactorï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reactor</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span>, Runnable{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerSocketChannel serverChannel;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector selector;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Reactor</span><span class="params">()</span> <span class="keyword">throws</span> IOException{</span><br><span class="line">        serverChannel = ServerSocketChannel.open();</span><br><span class="line">        selector = Selector.open();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            serverChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">            serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">//æ³¨å†Œæ—¶ï¼Œå°†Acceptorä½œä¸ºé™„åŠ å¯¹è±¡å­˜æ”¾ï¼Œå½“é€‰æ‹©å™¨é€‰æ‹©åä¹Ÿå¯ä»¥è·å–åˆ°</span></span><br><span class="line">            serverChannel.register(selector, SelectionKey.OP_ACCEPT, <span class="keyword">new</span> <span class="title class_">Acceptor</span>(serverChannel, selector));</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br><span class="line">                System.out.println(<span class="string">"ç›‘å¬åˆ° "</span>+count+<span class="string">" ä¸ªäº‹ä»¶"</span>);</span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">                    <span class="built_in">this</span>.dispatch(iterator.next());   <span class="comment">//é€šè¿‡dispatchæ–¹æ³•è¿›è¡Œåˆ†å‘</span></span><br><span class="line">                    iterator.remove();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡æ­¤æ–¹æ³•è¿›è¡Œåˆ†å‘</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(SelectionKey key)</span>{</span><br><span class="line">        <span class="type">Object</span> <span class="variable">att</span> <span class="operator">=</span> key.attachment();   <span class="comment">//è·å–attachmentï¼ŒServerSocketChannelå’Œå¯¹åº”çš„å®¢æˆ·ç«¯Channeléƒ½æ·»åŠ äº†çš„</span></span><br><span class="line">        <span class="keyword">if</span>(att <span class="keyword">instanceof</span> Runnable) {</span><br><span class="line">            ((Runnable) att).run();   <span class="comment">//ç”±äºHandlerå’ŒAcceptoréƒ½å®ç°è‡ªRunnableæ¥å£ï¼Œè¿™é‡Œå°±ç»Ÿä¸€è°ƒç”¨ä¸€ä¸‹</span></span><br><span class="line">        }   <span class="comment">//è¿™æ ·å°±å®ç°äº†å¯¹åº”çš„æ—¶å€™è°ƒç”¨å¯¹åº”çš„Handleræˆ–æ˜¯Acceptoräº†</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨äº†è®°å¾—å…³ï¼Œä¿æŒå¥½ä¹ æƒ¯ï¼Œå°±åƒçœ‹å®Œè§†é¢‘è¦ä¸‰è¿ä¸€æ ·</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        serverChannel.close();</span><br><span class="line">        selector.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ€åæˆ‘ä»¬ç¼–å†™ä¸€ä¸‹ä¸»ç±»ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="comment">//åˆ›å»ºReactorå¯¹è±¡ï¼Œå¯åŠ¨ï¼Œå®Œäº‹</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">Reactor</span> <span class="variable">reactor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reactor</span>()){</span><br><span class="line">        reactor.run();</span><br><span class="line">    }<span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†å•çº¿ç¨‹Reactoræ¨¡å¼ï¼Œæ³¨æ„å…¨ç¨‹ä½¿ç”¨åˆ°çš„éƒ½åªæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ²¡æœ‰åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†ä»»ä½•äº‹æƒ…ã€‚</p>
<p>ä½†æ˜¯å•çº¿ç¨‹å§‹ç»ˆæ²¡åŠæ³•åº”å¯¹å¤§é‡çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡ä¸Šå»äº†ï¼Œå•çº¿ç¨‹è¿˜æ˜¯å¾ˆä¸å¤Ÿç”¨ï¼Œæ¥ç€æˆ‘ä»¬æ¥çœ‹çœ‹å¤šçº¿ç¨‹Reactoræ¨¡å¼ï¼Œå®ƒåˆ›å»ºäº†å¤šä¸ªçº¿ç¨‹å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®è¯»å–å®Œæˆä¹‹åçš„æ“ä½œäº¤ç»™çº¿ç¨‹æ± æ¥æ‰§è¡Œï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1whmt5w1sj21fq0cmac7.jpg" alt="image-20220504171307721"></p>
<p>å…¶å®æˆ‘ä»¬åªéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹Handlerå°±è¡Œäº†ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Handler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>{</span><br><span class="line">		<span class="comment">//æŠŠçº¿ç¨‹æ± ç»™å®‰æ’äº†ï¼Œ10ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">POOL</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SocketChannel channel;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(SocketChannel channel)</span> {</span><br><span class="line">        <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            channel.read(buffer);</span><br><span class="line">            buffer.flip();</span><br><span class="line">            POOL.submit(() -&gt; {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    System.out.println(<span class="string">"æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š"</span>+<span class="keyword">new</span> <span class="title class_">String</span>(buffer.array(), <span class="number">0</span>, buffer.remaining()));</span><br><span class="line">                    channel.write(ByteBuffer.wrap(<span class="string">"å·²æ”¶åˆ°ï¼"</span>.getBytes()));</span><br><span class="line">                }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™æ ·ï¼Œåœ¨æ•°æ®è¯»å‡ºä¹‹åï¼Œå°±å¯ä»¥å°†æ•°æ®å¤„ç†äº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œã€‚</p>
<p>ä½†æ˜¯è¿™æ ·æ„Ÿè§‰è¿˜æ˜¯åˆ’åˆ†çš„ä¸å¤Ÿï¼Œä¸€ä¸ªReactoréœ€è¦åŒæ—¶å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„æ‰€æœ‰æ“ä½œè¯·æ±‚ï¼Œæ˜¾å¾—æœ‰äº›ä¹åŠ›ï¼Œé‚£ä¹ˆä¸å¦¨æˆ‘ä»¬å°†Reactoråšæˆä¸€ä¸»å¤šä»çš„æ¨¡å¼ï¼Œè®©ä¸»Reactoråªè´Ÿè´£Acceptæ“ä½œï¼Œè€Œå…¶ä»–çš„Reactorè¿›è¡Œå„è‡ªçš„å…¶ä»–æ“ä½œï¼š</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h1xgciyet7j21f40cijtp.jpg" alt="image-20220505131410997"></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥é‡æ–°è®¾è®¡ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç ï¼ŒReactorç±»å°±ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œä¸è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹å…¶ä»–çš„ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubReactorä½œä¸ºä»Reactor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubReactor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, Closeable {</span><br><span class="line">		<span class="comment">//æ¯ä¸ªä»Reactorä¹Ÿæœ‰ä¸€ä¸ªSelector</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector selector;</span><br><span class="line">	</span><br><span class="line">  	<span class="comment">//åˆ›å»ºä¸€ä¸ª4çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œä¹Ÿå°±æ˜¯å››ä¸ªä»Reactorå·¥ä½œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">POOL</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SubReactor[] reactors = <span class="keyword">new</span> <span class="title class_">SubReactor</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">selectedIndex</span> <span class="operator">=</span> <span class="number">0</span>;  <span class="comment">//é‡‡ç”¨è½®è¯¢æœºåˆ¶ï¼Œæ¯æ¥å—ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå°±è½®è¯¢åˆ†é…ç»™å››ä¸ªä»Reactor</span></span><br><span class="line">    <span class="keyword">static</span> {   <span class="comment">//åœ¨ä¸€å¼€å§‹çš„æ—¶å€™å°±è®©4ä¸ªä»Reactorè·‘èµ·æ¥</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                reactors[i] = <span class="keyword">new</span> <span class="title class_">SubReactor</span>();</span><br><span class="line">                POOL.submit(reactors[i]);</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">		<span class="comment">//è½®è¯¢è·å–ä¸‹ä¸€ä¸ªSelectorï¼ˆAcceptorç”¨ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Selector <span class="title function_">nextSelector</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> reactors[selectedIndex].selector;</span><br><span class="line">        selectedIndex = (selectedIndex + <span class="number">1</span>) % <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">return</span> selector;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SubReactor</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        selector = Selector.open();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {   <span class="comment">//å¯åŠ¨åç›´æ¥ç­‰å¾…selectorç›‘å¬åˆ°å¯¹åº”çš„äº‹ä»¶å³å¯ï¼Œå…¶ä»–çš„æ“ä½œé€»è¾‘å’ŒReactorä¸€è‡´</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> selector.select();</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" &gt;&gt; ç›‘å¬åˆ° "</span>+count+<span class="string">" ä¸ªäº‹ä»¶"</span>);</span><br><span class="line">                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">                    <span class="built_in">this</span>.dispatch(iterator.next());</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatch</span><span class="params">(SelectionKey key)</span>{</span><br><span class="line">        <span class="type">Object</span> <span class="variable">att</span> <span class="operator">=</span> key.attachment();</span><br><span class="line">        <span class="keyword">if</span>(att <span class="keyword">instanceof</span> Runnable) {</span><br><span class="line">            ((Runnable) att).run();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        selector.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä»¬æ¥ç€æ¥ä¿®æ”¹ä¸€ä¸‹Acceptorç±»ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Acceptor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerSocketChannel serverChannel;   <span class="comment">//åªéœ€è¦ä¸€ä¸ªServerSocketChannelå°±è¡Œäº†</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Acceptor</span><span class="params">(ServerSocketChannel serverChannel)</span> {</span><br><span class="line">        <span class="built_in">this</span>.serverChannel = serverChannel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span>{</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">channel</span> <span class="operator">=</span> serverChannel.accept();   <span class="comment">//è¿˜æ˜¯æ­£å¸¸è¿›è¡ŒAcceptæ“ä½œï¼Œå¾—åˆ°SocketChannel</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">" &gt;&gt; å®¢æˆ·ç«¯å·²è¿æ¥ï¼ŒIPåœ°å€ä¸ºï¼š"</span>+channel.getRemoteAddress());</span><br><span class="line">            channel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">            <span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> SubReactor.nextSelector();   <span class="comment">//é€‰å–ä¸‹ä¸€ä¸ªä»Reactorçš„Selector</span></span><br><span class="line">            selector.wakeup();    <span class="comment">//åœ¨æ³¨å†Œä¹‹å‰å”¤é†’ä¸€ä¸‹é˜²æ­¢å¡æ­»</span></span><br><span class="line">            channel.register(selector, SelectionKey.OP_READ, <span class="keyword">new</span> <span class="title class_">Handler</span>(channel));  <span class="comment">//æ³¨æ„ç°åœ¨æ³¨å†Œçš„æ˜¯ä»Reactorçš„Selector</span></span><br><span class="line">        }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç°åœ¨ï¼ŒSocketChannelç›¸å…³çš„æ“ä½œå°±ç”±ä»Reactorè¿›è¡Œå¤„ç†äº†ï¼Œè€Œä¸æ˜¯ä¸€å¾‹äº¤ç»™ä¸»Reactorè¿›è¡Œæ“ä½œã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†NIOçš„ä¸‰å¤§ç»„ä»¶ï¼š<em>Bufferã€Channelã€Selector</em>ï¼Œæœ‰å…³NIOåŸºç¡€ç›¸å…³çš„å†…å®¹ï¼Œå°±è®²è§£åˆ°è¿™é‡Œã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†ç»§ç»­è®²è§£åŸºäºNIOå®ç°çš„é«˜æ€§èƒ½ç½‘ç»œé€šä¿¡æ¡†æ¶Nettyã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h></h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://alanyaeer.fun/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">http://alanyaeer.fun/2024/03/17/Java NIOç¬”è®°ï¼ˆä¸€ï¼‰/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>è€¶æ ¼å°”</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2024-03-17</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2024-06-04</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2023/12/21/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="è®¾è®¡æ¨¡å¼"><img class="cover" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202312212341286.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">è®¾è®¡æ¨¡å¼</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">è€¶æ ¼å°”</div><div class="author-info__description">TTK</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">38</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Alanyaeer"><i class="fab fa-github"></i><span>Follow Me<i class="faa-passing animated" style="padding-left:20px;display:inline-block;vertical-align:middle;"><svg class="icon" style="height:28px;width:28px;fill:currentColor;position:relative;top:5px"><use xlink:href="#icon-xiaoqiche"></use></svg></i></span></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="/assets/QRCode.jpg" target="_blank" title="å¾®ä¿¡"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wechat"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://res.abeim.cn/api/qq/?qq=1563085328" target="_blank" title="QQ"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-qq"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1199523404" target="_blank" title="Bç«™"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://github.com/Alanyaeer" target="_blank" title="github"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-github"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://leetcode.cn/u/sao-hei-chu-e-wei-dang-yu-min" target="_blank" title="åŠ›æ‰£"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-leetcode1"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:25px;width:25px;fill:currentColor;position:relative;top:5px" aria-hidden="true"><use xlink:href="#icon-gonggao"></use></svg></a><span>å…¬å‘Š</span></div><div class="announcement_content">åšå®¢æ­£åœ¨å¼€å‘ä¸­ã€‚ã€‚ã€‚</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NIO%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">NIOåŸºç¡€</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.1.</span> <span class="toc-text">ç¼“å†²åŒº</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffer%E7%B1%BB%E5%8F%8A%E5%85%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">Bufferç±»åŠå…¶å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.2.</span> <span class="toc-text">ç¼“å†²åŒºå†™æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E8%AF%BB%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.3.</span> <span class="toc-text">ç¼“å†²åŒºè¯»æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.4.</span> <span class="toc-text">ç¼“å†²åŒºå…¶ä»–æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%AF%94%E8%BE%83"><span class="toc-number">1.1.5.</span> <span class="toc-text">ç¼“å†²åŒºæ¯”è¾ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E8%AF%BB%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.1.6.</span> <span class="toc-text">åªè¯»ç¼“å†²åŒº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ByteBuffer%E5%92%8CCharBuffer"><span class="toc-number">1.1.7.</span> <span class="toc-text">ByteBufferå’ŒCharBuffer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.1.8.</span> <span class="toc-text">ç›´æ¥ç¼“å†²åŒº</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E9%81%93"><span class="toc-number">1.2.</span> <span class="toc-text">é€šé“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E9%81%93%E6%8E%A5%E5%8F%A3%E5%B1%82%E6%AC%A1"><span class="toc-number">1.2.1.</span> <span class="toc-text">é€šé“æ¥å£å±‚æ¬¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93FileChannel"><span class="toc-number">1.2.2.</span> <span class="toc-text">æ–‡ä»¶ä¼ è¾“FileChannel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%94%81FileLock"><span class="toc-number">1.2.3.</span> <span class="toc-text">æ–‡ä»¶é”FileLock</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1"><span class="toc-number">1.3.</span> <span class="toc-text">å¤šè·¯å¤ç”¨ç½‘ç»œé€šä¿¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E9%98%BB%E5%A1%9EI-O%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1"><span class="toc-number">1.3.1.</span> <span class="toc-text">ä¼ ç»Ÿé˜»å¡I/Oç½‘ç»œé€šä¿¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E5%99%A8%E4%B8%8EI-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">é€‰æ‹©å™¨ä¸I/Oå¤šè·¯å¤ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0Reactor%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">å®ç°Reactoræ¨¡å¼</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:25px;width:25px;fill:currentColor;position:relative;top:5px" aria-hidden="true"><use xlink:href="#icon--shijian"></use></svg></a><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/04/Netty%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="Nettyå­¦ä¹ è®°å½•"><img src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202406042208033.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nettyå­¦ä¹ è®°å½•"></a><div class="content"><a class="title" href="/2024/06/04/Netty%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="Nettyå­¦ä¹ è®°å½•">Nettyå­¦ä¹ è®°å½•</a><time datetime="2024-06-04T14:04:51.167Z" title="å‘è¡¨äº 2024-06-04 22:04:51">2024-06-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/04/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•"><img src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202406042201773.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•"></a><div class="content"><a class="title" href="/2024/06/04/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" title="javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•">javaè™šæ‹Ÿæœºå­¦ä¹ è®°å½•</a><time datetime="2024-06-04T14:04:32.697Z" title="å‘è¡¨äº 2024-06-04 22:04:32">2024-06-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/" title="æ— é¢˜">æ— é¢˜</a><time datetime="2024-03-17T13:05:20.700Z" title="å‘è¡¨äº 2024-03-17 21:05:20">2024-03-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/17/Java%20NIO%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/" title="æ— é¢˜">æ— é¢˜</a><time datetime="2024-03-17T13:04:56.001Z" title="å‘è¡¨äº 2024-03-17 21:04:56">2024-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/21/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="è®¾è®¡æ¨¡å¼"><img src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202312212341286.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¾è®¡æ¨¡å¼"></a><div class="content"><a class="title" href="/2023/12/21/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</a><time datetime="2023-12-21T15:21:41.000Z" title="å‘è¡¨äº 2023-12-21 23:21:41">2023-12-21</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">Â©2020 - 2024 By è€¶æ ¼å°”</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"><span id="percent">0<span>%</span></span></i></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/jquery.js"></script><script src="/js/foot.js"></script><script async="" src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script src="/js/sun_moon.js" async=""></script><script async="" src="/js/fps.js"></script><script async="" src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async="" src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script defer="" data-pjax="" src="/js/readPercent.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script src="/js/share.js"></script><script async="" src="//at.alicdn.com/t/c/font_4310562_r2j4rpxkbn.js"></script><script async="" src="/js/title.js"></script><script async="" src="/js/runtime_min.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --> <script data-pjax="">if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/Hexo/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“š hexoæŒ‡å— (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/Java/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ® JavaæŒ‡å— (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/å‰åç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ±â€ğŸ‘“ å‰åç«¯æŒ‡å— (18)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://alanyaeer.fun/categories/æ“ä½œç³»ç»Ÿ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“’ æ“ä½œç³»ç»ŸæŒ‡å— (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="http://alanyaeer.fun/categories" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #69e8f2}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style>opacity: 0.1;</style><script data-pjax="">
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310291935375.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Java/&quot;);" href="javascript:void(0);">Java</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">HexoæŒ‡å—</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292110565.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Hexo/&quot;);" href="javascript:void(0);">Hexo</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">JavaæŒ‡å—</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292110569.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/å‰åç«¯/&quot;);" href="javascript:void(0);">å‰åç«¯</a><span class="categoryBar-list-count">18</span><span class="categoryBar-list-descr">å‰åç«¯æŒ‡å—</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292131968.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/åç«¯/&quot;);" href="javascript:void(0);">åç«¯</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">æ“ä½œç³»ç»Ÿ</span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/æ“ä½œç³»ç»Ÿ/&quot;);" href="javascript:void(0);">æ“ä½œç³»ç»Ÿ</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/å‰ç«¯/&quot;);" href="javascript:void(0);">å‰ç«¯</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/ç®—æ³•/&quot;);" href="javascript:void(0);">ç®—æ³•</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('å·²æŒ‚è½½butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax="">
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = '0d70a707189f48a8b262edfc710e07e9';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax="" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax="">
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo_v5.4.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.2.2" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="æœ¬ç«™ä½¿ç”¨JsDelivrä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" title=""><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('å·²æŒ‚è½½butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async="" src="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer="" src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer="" src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax="">
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/12/knife4jçš„é…ç½®/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311121830288.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/12/knife4jçš„é…ç½®/&quot;);" href="javascript:void(0);" alt="">knife4jçš„é…ç½®</a><div class="blog-slider__text">knife4jåœ¨ä¸åŒspringbootç‰ˆæœ¬çš„é…ç½®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/12/knife4jçš„é…ç½®/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/10/31/Java-Juc/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310312009843.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-31</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/10/31/Java-Juc/&quot;);" href="javascript:void(0);" alt="">Java_Juc</a><div class="blog-slider__text">Java_Juc</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/10/31/Java-Juc/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/12/springsecurityçš„å­¦ä¹ /&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311122356745.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/12/springsecurityçš„å­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">springsecurityçš„å­¦ä¹ </a><div class="blog-slider__text">è¿™æ˜¯æˆ‘çš„springsecurityçš„å­¦ä¹ è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/12/springsecurityçš„å­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/07/linux-ftpè®¾ç½®/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311081142035.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/07/linux-ftpè®¾ç½®/&quot;);" href="javascript:void(0);" alt="">linux-ftpè®¾ç½®</a><div class="blog-slider__text">è¿œç¨‹linuxè®¾ç½®rootç”¨æˆ·çš„ftp</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/07/linux-ftpè®¾ç½®/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/18/rediså®æˆ˜ç¯‡/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311181702738.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/18/rediså®æˆ˜ç¯‡/&quot;);" href="javascript:void(0);" alt="">rediså®æˆ˜ç¯‡</a><div class="blog-slider__text">rediså®æˆ˜ç¯‡è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/18/rediså®æˆ˜ç¯‡/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/10/28/javaå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310292110572.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/10/28/javaå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½/&quot;);" href="javascript:void(0);" alt="">æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½</a><div class="blog-slider__text">springboot+vueå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/10/28/javaå®ç°æ–‡ä»¶ä¸Šä¼ å’Œæ–‡ä»¶ä¸‹è½½/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/18/elasticsearchå­¦ä¹ /&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311182039973.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/18/elasticsearchå­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">elasticsearchå­¦ä¹ </a><div class="blog-slider__text">è¿™æ˜¯ elasticsearch çš„å­¦ä¹ è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/18/elasticsearchå­¦ä¹ /&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/08/dockerçš„å„ç§é…ç½®/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202311091613623.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-08</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/08/dockerçš„å„ç§é…ç½®/&quot;);" href="javascript:void(0);" alt="">dockerçš„é…ç½®</a><div class="blog-slider__text">dockerå„ç§æœåŠ¡çš„é…ç½®</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/08/dockerçš„å„ç§é…ç½®/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/10/31/Netty/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://cdn.jsdelivr.net/gh/Alanyaeer/ImgSummary@master/img/202310312016673.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-31</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/10/31/Netty/&quot;);" href="javascript:void(0);" alt=""></a><div class="blog-slider__text">Nettyå­¦ä¹ è®°å½•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/10/31/Netty/&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer="" data-pjax="" src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>